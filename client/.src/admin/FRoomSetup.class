' Gambas class file
' Copyright (C) 2008,2009 Dr. Richard Terry

' This program is free software: you can redistribute it and/or modify
' it under the terms of the GNU General Public License as published by
' the Free Software Foundation, either version 3 of the License, or
' (at your option) any later version.

' This program is distributed in the hope that it will be useful,
' but WITHOUT ANY WARRANTY; without even the implied warranty of
' MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
' GNU General Public License for more details.

' You should have received a copy of the GNU General Public License
' along with this program.  If not, see <http://www.gnu.org/licenses/>.
' Amodule to allow setting up of room preferences such as printers
Private allprinters As String[]

Public Sub form_Open()
   Init()
End

Public Sub form_Close()
  
  Settings_Save()
  
End

Public Sub Init()
  Help_Create()
  allprinters = modPrinting.Printers_Load()
  LoadPrinterOptions(cmbPlain, tbPlain, "plain")
  LoadPrinterOptions(cmbScript, tbScript, "script")
  LoadPrinterOptions(cmbLong, tbLong, "long")
  LoadPrinterOptions(cmbRequest, tbRequest, "request")
End

Private Sub LoadPrinterOptions(cmb As ComboBox, opts As TextBox, printername As String)
  Dim i As String
  
  cmb.Add("Default")
  For Each i In allprinters
    cmb.Add(i)
  Next
  cmb.Index = cmb.Find(Settings[Subst$("Printers/&1", printername), "Default"])
  opts.Text = Settings[Subst$("Printers/&1_options", printername), ""]
End



Public Sub SliderFont_Change()

  tlHelp.Font.size = Last.value

End

Private Sub Settings_Save()


  

End

Private Sub Settings_Load()


  

End


Public Sub Help_Create()
   tlhelp.text = "<html><head><title>Document Storage Site</title></head><body>"
 
   "<h2>Room Setup</h2>"
  "<p>This will tell EasyGP where how you wish to set up your clinic rooms."

      "<P><B>Default Printer</B><BR>."
      "<P>This should be the printer in your room you wish to use to print plain paper documents. "
      "Within EasyGP you can over-ride this at any time to print to any printer on the network."
      "<P><B>Script Printer</B><BR>."
      "<P>In many clinic rooms, the staff member will have to print to pre-formatted script paper.</P>"
      "<P>Please test your printers to ensure they are working satisfactorily before saving these defaults.</P>"
 
  End

Public Sub tbTestPrinter_Click()

  PrintTestPage(cmbPlain, tbPlain, "plain", Last.tag)
  PrintTestPage(cmbScript, tbScript, "script", Last.tag)
  PrintTestPage(cmbLong, tbLong, "long", Last.tag)
  PrintTestPage(cmbRequest, tbRequest, "request", Last.tag)

End

Private Sub PrintTestPage(cmb As ComboBox, opts As TextBox, printername As String, tag As String)

   Dim s As String
   Dim pro As Process
   
   If printername <> tag Then Return ' only do the clicked-on widget
   s = cmb.Text
   If s = "Default" Then
     s = ""
   Else
     s = Subst$("-P &1", s)
   Endif
   If opts.Text <> "" Then
     s &= " " & opts.Text
   Endif
   pro = Shell "lpr " & s For Write
   ' we can't use this filename as a parameter to lpr
   ' as in production system all application files
   ' are wrapped up in the executable file, only 
   ' gambas can read them 
   Write #pro, File.Load("templates/testpage.pdf")
   Close #pro
End

Public Sub tbSave_Click()

   '--------------------------------------------------------
   'Save defaults for a room - at this stage - just printers
   '--------------------------------------------------------
   Settings.Clear("Printers")
   SavePrinterOptions(cmbPlain, tbPlain, "plain")
   SavePrinterOptions(cmbScript, tbScript, "script")
   SavePrinterOptions(cmbLong, tbLong, "long")
   SavePrinterOptions(cmbRequest, tbRequest, "request")
End

Private Sub SavePrinterOptions(cmb As ComboBox, opts As TextBox, printername As String)

  If cmb.Text <> "Default" Then
    Settings[Subst$("Printers/&1", printername)] = cmb.Text
  Endif
  If Trim$(opts.Text) <> "" Then
    Settings[Subst$("Printers/&1_options", printername)] = opts.Text
  Endif

End