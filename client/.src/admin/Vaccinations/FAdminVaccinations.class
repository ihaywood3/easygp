' Gambas class file
' Copyright (C) 2008,2009 Dr. Richard Terry

' This program is free software: you can redistribute it and/or modify
' it under the terms of the GNU General Public License as published by
' the Free Software Foundation, either version 3 of the License, or
' (at your option) any later version.

' This program is distributed in the hope that it will be useful,
' but WITHOUT ANY WARRANTY; without even the implied warranty of
' MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
' GNU General Public License for more details.

' You should have received a copy of the GNU General Public License
' along with this program.  If not, see <http://www.gnu.org/licenses/>.
'---------------------------------------------------------------------------------
' PURPOSE         A module to assist in maintenance of vaccinations, schedules etc
' TERMINOLOGY     Which may be unfamiliar to non-australians:
'                 TSI = Torres Straight Islanders eg bAboriginalTSI_Only flag
'                 as government policy identifies these as special groups
'---------------------------------------------------------------------------------
Private bexit As Boolean
Private schedules As Collection
Private schedule As Collection
Private fk_schedule As Integer
Private fk_season As Integer = 0
Private pk_view As Integer
Private bFemaleONly As Boolean            'if true the vaccine is only for females  
Private bAboriginalTSI_Only As Boolean    'if true the schedule is only for this group
Private bScheduleActive As Boolean    'if true the schedule is in current use
Private Seasons As Collection 
Private Vaccines As Collection
Private Vaccine As Collection

Public Sub Form_Open()
   
   Init()
   
End

Public Sub Init()

   seasons = modUtil.LoadCombo(cmbSeasons, modCommonDBI.Seasons_Get(), "season")
   lblMeasure.text = " Maximum Age (Months) "
   modEditAreaHelpers.Resize_labels(Vbox_EditArea_Inner, lblMeasure)
   Try Settings_Load()
   Reload()

End

Public Sub Settings_Save()
   
   Settings["Admin_Vaccination/VSplit_Main.layout"] = Vsplit_Main.layout
   Settings["Admin_Vaccination/HSplit_Schedules_Defaults.Layout"] = HSplit_Schedules_Defaults.Layout
   
End

Private Sub Settings_Load()
   
   HSplit_Schedules_Defaults.Layout = Settings["Admin_Vaccination/HSplit_Schedules_Defaults.Layout"]
   Vsplit_Main.layout = Settings["Admin_Vaccination/VSplit_Main.layout"] 
   
End

Public Sub EditArea_Clear()
   
   modEditAreaHelpers.EditArea_Clear(Vbox_EditArea_Inner)
   
End

Public Sub EditArea_Notify_DataChanged(flag As Boolean)
   
   If flag Then 
      tbSave.Foreground = Color.Red
      Vbox_EditArea_Outer.Padding = 1
   Else
      tbSave.Foreground = Color.Black
      Vbox_EditArea_Outer.Padding = 0 
   Endif
   
End

Public Sub EditArea_TextBox_Activate()
   
End

Public Sub EditArea_TextBox_KeyRelease()
   
End

Public Sub EditArea_Buttons_Click()
   
   Select Case Last.tag
      Case "new"
         Schedule_New()
      Case "save"
         Schedule_Save()
      Case "refresh"
         txtFilterSchedule.text = ""
         Reload()
   End Select
   
End

Public Sub EditArea_Buttons_KeyPress()
   
End

Public Sub Schedule_New()
   
   EditArea_Clear()
   rbFemaleOnlyNo.value = True
   rbAboriginalTSINo.value = True
   rbSeasonalNo.value = True
   bFemaleOnly = False   
   
End

Public Sub Schedule_Delete()
   
End

Public Sub Schedule_Display()
   '----------------------------------------  
   'Displays the schedule but cannot edit it
   '----------------------------------------

   If lvwSchedules.count = 0 Then Return
   lvwSchedules.MoveCurrent
   pk_view = lvwSchedules.Item.Key
   fk_schedule = schedules[pk_view]!pk
   txtSchedule.text = schedules[pk_view]!schedule
   Try txtAgeDueFrom.text = schedules[pk_view]!age_due_from_months
   Try txtAgeDueTo.text = schedules[pk_view]!age_due_to_months
   If schedules[pk_view]!female_only Then
      rbFemaleOnlyYes.value = True
   Endif
   If schedules[pk_view]!aboriginal_tsi_only Then
      rbAboriginalTSIYes.Value = True
   Endif
   If schedules[pk_view]!fk_season Then
      rbSeasonalYes.value = True
   Endif
   Vaccines_In_Schedule_Display()
   HSplit_EditArea.Enabled = False   

End

Public Sub Schedule_Edit()

   Schedule_Display()
    HSplit_EditArea.Enabled = True  

End

Public Sub Schedule_Save()
   
   If Vbox_EditArea_Outer.Border = 0 Then Return ' no changes, nothing to save
   If Not (Schedule_Valid) Then Return
   
   Schedule = New Collection
   If fk_schedule Then
      Schedule!fk_schedule = fk_schedule
   End If
   
End

Public Sub Reload()
   
   schedules = modVaccinationDBI.Schedules_get(Trim(txtFilterSchedule.text))
   lvwSchedules.clear()
   For Each schedule In schedules
      lvwSchedules.Add(schedule!pk, Schedule!schedule)
   Next
   EditArea_Clear()
   EditArea_Notify_DataChanged(False)
   HSplit_EditArea.Enabled = False  

End

Public Sub Schedule_Valid()
   
End

Public Sub rblaterality_Click()
   
End

Public Sub rbFemaleOnly_Click()
   
   bFemaleOnly = False  
   If Last.tag = "Yes" Then bFemaleOnly.value = True
   
End

Public Sub rbAboriginalTSI_Click()
   
   bAboriginalTSI_Only = False
   If Last.tag = "yes" Then bAboriginalTSI_Only.value = True
   
End

Public Sub rbSeasonal_Click()
   
   If Last.tag = "yes" Then
      cmbSeasons.Visible = True
   Else
      cmbSeasons.Visible = False
      cmbSeasons.index = -1
      fk_season = 0
   End If 
   
End

Public Sub cmbSeasons_Click()
   
   fk_season = Seasons[Last.index]!pk
   
End

Public Sub lvwSchedules_Menu()
   
   If Last.count Then mnuSchedules.popup
   
End

Public Sub mnuSchedules_Click()
   
   Select Case Last.tag
      Case "edit"
         Schedule_Edit()
      Case "delete"
      Case "help"
   End Select
   
End

Public Sub rbScheduleActive_Click()

   bScheduleActive = True
   If Last.tag = "No" Then bScheduleActive = False
   
End

Public Sub lvwSchedules_Select()
   
   Schedule_Display()
   
End

Public Sub Vaccines_In_Schedule_Display()
   '---------------------------------------------
   'Display all vaccines in a particular schedule
   '---------------------------------------------

   Vaccines = modVaccinationDBI.Vaccines_In_Schedules_Get(fk_schedule)
   With cvwVaccines
      .Columns.count = 2
      .Clear
   End With
   For Each vaccine In Vaccines
      cvwVaccines.Add(vaccine!pk_view, 0)
      cvwVaccines[vaccine!pk_view][0] = vaccine!brand
      cvwVaccines[vaccine!pk_view][1] = vaccine!description
   Next
   
End

Public Sub txtFilterSchedule_KeyRelease()
   
   Reload()
   
End
