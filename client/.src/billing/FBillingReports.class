' Gambas class file

Private visits As Collection
Private visit As Collection

Public Sub init()
   
   Dim x As Integer
   
   With columnview1
      .Columns.Count = 8
      For x = 0 To .Columns.Count - 1
         .Columns[x].Alignment = Align.Center
      Next
      .Columns[0].text = "Appt"
      .Columns[1].text = "Patient"
      .Columns[2].text = "   Bill To   "
      .Columns[3].text = "Item"
      .Columns[4].text = "Descriptor"
      .Columns[5].text = "Amount"
      .Columns[6].text = "Amount gst"
      .Columns[7].text = "Paid"
   End With   
   
End

Public Sub Button2_Click()
   
   Dim payer As String
   Dim item As String
   Dim x As Integer
   Dim num_visits As Integer 'may not be same as individual patients seen
   Dim fk_Last_invoice As Integer
   
   visits = modBillingDBI.Day_List_Get(Now, modDBConnect.currentUser!fk_branch, modDBConnect.currentUser!fk_staff)
   With columnview1
      .Clear 
      For x = 0 To .Columns.Count - 1
         .Columns[x].Alignment = Align.left
      Next
   End With
   For Each visit In visits
      If fk_Last_invoice <> visit!fk_invoice Then
         fk_Last_invoice = visit!fk_invoice
         Inc num_visits
      Endif
      columnview1.Add(visit!pk_items_billed, 0)
      columnview1[visit!pk_items_billed][1] = visit!patient_wholename
      payer = ""
      If Not IsNull(visit!fk_lu_bulk_billing_type) Then
         If visit!fk_lu_bulk_billing_type = const.BulkBilling_Type_Medicare Then
            Payer = "Medicare"
         Else
            Payer = "Veterans"
         Endif
      Endif
      If payer = "" Then 
         If IsNull(visit!fk_payer_person) And IsNull(visit!fk_payer_branch) Then 
            payer = "Patient"
         Else
            If Not IsNull(visit!payer_organisation) Then
               payer = visit!payer_organisation
            Else
               payer = visit!payer_firstname & " " & visit!payer_surname
            End If   
         End If
      End If   
      columnview1[visit!pk_items_billed][2] = payer
      columnview1[visit!pk_items_billed][3] = Trim(visit!mbs_item & " " & visit!ama_item & " " & visit!user_item)
      columnview1[visit!pk_items_billed][4] = visit!descriptor_brief
      columnview1[visit!pk_items_billed][5] = visit!amount
      If Not IsNull(visit!amount_gst) Then
         columnview1[visit!pk_items_billed][6] = visit!amount_gst
      Else
         columnview1[visit!pk_items_billed][6] = "$0.0"
      Endif
      If Not IsNull(visit!total_paid) Then
         columnview1[visit!pk_items_billed][7] = visit!total_paid
      Else
         columnview1[visit!pk_items_billed][7] = "$0.0"
      End If
   Next
   '----------------------------
   'construct a bit of a summary
   '----------------------------
   tlDaySummary.text &= "<P><B>Summary</B><P>"
   tlDaySummary.text &= "<B>Patients seen:</B>" & num_visits 'put reason patient not seen and print under here
   tlDaySummary.text &= "<B>Patients billed:</B>" & num_visits
     tlDaySummary.text &= "<B>Bulk Billed Medicare:</B>"
End
