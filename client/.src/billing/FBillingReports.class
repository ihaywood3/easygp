' Gambas class file

Private visits As Collection
Private visit As Collection
Private Report_Titles As Collection
Private fk_report As Integer 'fixme changeme remove me only developmental
Private fk_staff As Integer
Private form_html_viewer As FHtmlViewer

Public Sub init(rt As Collection)
   
   Report_Titles = rt   
   
   With columnview1
      .Columns.Count = 10
      
      .Columns[0].text = "Appt"
      .Columns[1].text = "Patient"
      .Columns[2].text = "   Bill To   "
      .Columns[3].text = "Item"
      .Columns[4].text = "Descriptor"
      .Columns[5].text = "Amount"
      .Columns[6].text = "Amount gst"
      .Columns[7].text = "Paid"
      .Columns[8].text = "Paid By"
      .Columns[9].text = "Owing"
   End With   
   With form_html_viewer = New FHtmlViewer(VBox_HTML_Viewer)
      .tbWebBrowserZoomIn.Visible = True  
      .tbWebBrowserPrint.Visible = True   
      .tbWebBrowserZoomOut.Visible = True 
   End With
   
End

Public Sub Report_Show(col As Collection, Optional cal_date As Date = Now(), Optional fk_staff As Integer = 0)
   
   If col!report_title = "Day List" Then
      lblReportHeading.text = "Day List Summary"
      fk_staff = fk_staff
      Day_list_Show(cal_date, fk_staff)
   Endif
   
End

Public Sub Day_list_Show(the_date As Date, fk_staff As Integer)
   
   Dim payer As String
   Dim item As String
   Dim x As Integer
   Dim num_visits As Integer 'may not be same as individual patients seen
   Dim num_visits_bb_have_concession_card As Integer
   Dim num_visits_bb_no_concession_card As Integer
   Dim num_visits_veteran As Integer
   Dim num_visits_private As Integer
   Dim fk_Last_invoice As Integer
   Dim total_billed As Float
   Dim total_paid As Float
   Dim running_total As Float
   Dim payment_totals As New Float[7] 
   Dim monies_received As Collection
   Dim payment_methods As Collection
   Dim running_total_gst As Float
   Dim payments_for_invoice As Collection
   Dim payment_for_invoice As Collection
   Dim payment_count As Integer
   Dim centrelink_card_types As Collection
   Dim concession_card_none_total As Integer
   Dim num_concession_card_pensioner As Integer
   Dim num_concession_card_healthcare As Integer
   Dim num_concession_card_seniors As Integer
   Dim num_private_patients_bulk_billed As Integer
   Dim sHtml As String
   
   Inc Application.Busy
   payment_methods = modBillingDBI.Payment_Methods_Get()
   
   ' monies_received = modBillingDBI.Receipts_Get_For_Day(the_date)
   monies_received = New Collection  
   ' centrelink_card_types = modBillingDBI.Centrelink_Card_Types_Get() 'clerical.lu_centrelink_card_type
   visits = modBillingDBI.Day_List_Get(the_date, modDBConnect.currentUser!fk_branch, fk_staff)
   sHtml = ""
   With columnview1
      .Clear 
      For x = 0 To .Columns.Count - 1
         .Columns[x].Alignment = Align.left
      Next
   End With
   For Each visit In visits
      columnview1.Add(visit!pk_view, 0)
      If IsNull(visit!fk_lu_reason_not_billed) Then                                         'if visit was billed
         If fk_Last_invoice <> visit!fk_invoice Then                                        'for each distinct invoice
            If Not IsNull(visit!appointment_date) Then                                      'if exists, show appointment time (always the first time slot
               columnview1[visit!pk_view][0] = Format(visit!appointment_date, "hh:nn")             ' eg. 09:00 FIXME PUT IN AM/PM
            Endif
            columnview1[visit!pk_view][1] = visit!wholename
            payer = ""
            '------------------------------
            'get some stats on bulk billing
            '------------------------------
            If Not IsNull(visit!fk_lu_bulk_billing_type) Then
               payer = visit!bulk_billing_type                                               'bulk bill type medicare or veteran
               If visit!fk_lu_bulk_billing_type = const.BulkBilling_Type_Medicare Then
                  If Not IsNull(visit!fk_lu_centrelink_card_type) Then
                     If visit!fk_lu_centrelink_card_type > 1 Then '1=none
                        Inc num_visits_bb_have_concession_card
                        Select Case visit!fk_lu_centrelink_card_type
                           Case const.Centrelink_Concession_Card_Health_Care_Card
                              Inc num_concession_card_healthcare
                           Case const.Centrelink_concession_card_seniors_Health_Card
                              Inc num_concession_card_seniors
                           Case const.Centrelink_concession_card_pensioner_concession_card
                              Inc num_concession_card_pensioner
                        End Select
                     End If
                  Else
                     Inc num_visits_bb_no_concession_card
                  End If   
               Else
                  Payer = "Veterans"
                  Inc num_visits_veteran
               Endif
            Else
               Inc num_visits_private 
            Endif
            If payer = "" Then 
               If IsNull(visit!fk_payer_person) And IsNull(visit!fk_payer_branch) Then 
                  payer = "Patient"
               Else
                  payer = visit!account_to_name
               End If
            End If   
            columnview1[visit!pk_view][2] = payer
            fk_Last_invoice = visit!fk_invoice
            Inc num_visits
         Else                                                                                     
            columnview1[visit!pk_view][0] = ""                                          'suppress duplicates
            columnview1[visit!pk_view][1] = "" 
            columnview1[visit!pk_view][2] = ""
         Endif
         columnview1[visit!pk_view][3] = visit!item 'coalesced ama_item,mbs_item, user_item
         columnview1[visit!pk_view][4] = visit!descriptor_brief
         columnview1[visit!pk_view][5] = visit!amount
         If Not IsNull(visit!amount_gst) Then
            columnview1[visit!pk_view][6] = visit!amount_gst
         Else
            columnview1[visit!pk_view][6] = "$0.0"
         Endif
         columnview1[visit!pk_view][7] = visit!payment_amount 'fixme take into account multiple payments
         columnview1[visit!pk_view][8] = visit!payment_method
         ' If visit!paid = True Then 'will only be TRUE if total bill paid
         '     columnview1[visit!pk_view][9].text = "$0.00"
         '  Else
         If IsNull(visit!payment_amount) Then
             columnview1[visit!pk_view][9] = visit!amount
         Else
            columnview1[visit!pk_view][9] = modUtil.Money_Format(modUtil.MoneyToFloat(visit!amount) - modUtil.MoneyToFloat(visit!payment_amount))
         Endif
         'columnview1[visit!pk_view][9] = modUtil.Money_Format(modUtil.MoneyToFloat(visit!total_bill) - modUtil.MoneyToFloat(visit!total_paid))
         '  Endif
      Else
         columnview1[visit!pk_view][0] = Format(visit!appointment_date, "hh:nn") 
         columnview1[visit!pk_view][1] = visit!wholename
         columnview1[visit!pk_view][2] = "-"
         columnview1[visit!pk_view][3] = "n/a"
         columnview1[visit!pk_view][5] = "$0.00"
         columnview1[visit!pk_view][4] = visit!reason_not_billed
      End If 
   Next
   '----------------------------
   'construct a bit of a summary
   '----------------------------
   sHtml = "<HTML><BODY>"
   sHtml &= "<P><B>Summary</B><P>"
   sHtml &= "<B>Patients seen:</B>" & num_visits & "<BR>" 'put reason patient not seen and print under here
   sHtml &= "<B>Patients billed:</B>" & num_visits & "<BR>"
   sHtml &= "<B>Bulk Billed on concession card:</B>" & num_visits_bb_have_concession_card & "<BR>"
   If num_concession_card_healthcare Then
      sHtml &= "- Health care card holders:" & Str(num_concession_card_healthcare) & "<BR>"
   Endif
   If num_concession_card_pensioner Then
      sHtml &= "- Pensioner card holders:" & Str(num_concession_card_pensioner) & "<BR>"
   Endif
   If num_concession_card_seniors Then
      sHtml &= "- Sensiors health card total:" & Str(num_concession_card_seniors) & "<BR>"
   Endif
   sHtml &= "<B>Bulk Billed no concession card:</B>" & num_visits_bb_no_concession_card & "<BR>" & "<BR>"
   sHtml &= "<B>Bulk Billed Veteran:</B>" & num_visits_veteran & "<BR>"
   sHtml &= "<B>Private Billing:</B>" & num_visits_private & "<BR>"
   sHtml = Replace(sHtml, "%seen%", Str(num_visits))
   sHtml = Replace(sHtml, "%billed%", Str(num_visits))
   '  sHtml = Replace(sHtml, "%seen%", num_visits)
   sHtml = Day_List_Receipts_Summary_HTML()
   sHtml = Replace(sHtml, "%seen%", Str(num_visits))
   sHtml = Replace(sHtml, "%billed%", Str(num_visits))
   sHtml = Replace(sHtml, "%numHCC%", Str(num_concession_card_healthcare))
   sHtml = Replace(sHtml, "%pensioner%", Str(num_concession_card_pensioner))
   sHtml = Replace(sHtml, "%seniors%", Str(num_concession_card_seniors))
   sHtml = Replace(sHtml, "%no-card%", Str(num_visits_bb_no_concession_card))
   sHtml = Replace(sHtml, "%bbillmc%", Str(num_concession_card_seniors))
   sHtml = Replace(sHtml, "%bbvet%", Str(num_visits_veteran))
   sHtml = Replace(sHtml, "%privbill%", Str(num_visits_private))
   sHtml &= "</BODY>/<HTML>"
   form_html_viewer.WebView1.HTML = sHtml
   Dec Application.Busy
   
End

Public Function Day_List_Receipts_Summary_HTML() As String
   
   Return ""
   "<TABLE WIDTH=100% BORDER=1 CELLPADDING=0 CELLSPACING=0 >"
   "<COL WIDTH=128*>"
   "<COL WIDTH=128*>"
   " <TR VALIGN=TOP>"
   "  <TD WIDTH=50% >"
   "   <P ALIGN=CENTER><B>Billing Summary</B></P>"
   "  </TD>"
   "  <TD WIDTH=50% >"
   "   <P ALIGN=CENTER><B>Receipts Taken</B></P>"
   "  </TD>"
   " </TR>"
   " <TR VALIGN=TOP>"
   "  <TD WIDTH=50% >"
   "   <TABLE WIDTH=100% CELLPADDING=0 CELLSPACING=0 >"
   "    <COL WIDTH=553>"
   "    <COL WIDTH=76>"
   "    <TR VALIGN=TOP>"
   "     <TD WIDTH=553 >"
   "      <P><B>Patients Seen</B></P>"
   "     </TD>"
   "     <TD WIDTH=76 >"
   "      <P>%seen%</P>"
   "     </TD>"
   "    </TR>"
   "    <TR VALIGN=TOP>"
   "     <TD WIDTH=553 >"
   "      <P><B>Patients Billed</B></P>"
   "     </TD>"
   "     <TD WIDTH=76 >"
   "      <P>%billed%</P>"
   "     </TD>"
   "    </TR>"
   "    <TR VALIGN=TOP>"
   "     <TD WIDTH=100% >"
   "      <P><B>Patients Bulk Billed (Medicare)</B></P>"
   "      <TABLE >"
   "       <COL WIDTH=40%>"
   "       <COL WIDTH=30%>"
   "       <COL WIDTH=20%>"
   "       <TR VALIGN=TOP>"
   "        <TD WIDTH=50% >"
   "         <P></P>"
   "        </TD>"
   "        <TD WIDTH=30% >"
   "         <P><B>On Health Care Card</B></P>"
   "        </TD>"
   "        <TD WIDTH=20 >"
   "         <P>%numHCC%</P>"
   "        </TD>"
   "       </TR>"
   "       <TR VALIGN=TOP>"
   "        <TD WIDTH=50%>"
   "         <P>"
   "         </P>"
   "        </TD>"
   "        <TD WIDTH=30%>"
   "         <P><B>On Pensioner Card</B></P>"
   "        </TD>"
   "        <TD WIDTH=10%>"
   "         <P>%pensioner%</P>"
   "        </TD>"
   "       </TR>"
   "       <TR VALIGN=TOP>"
   "        <TD WIDTH=213 >"
   "         <P><BR>"
   "         </P>"
   "        </TD>"
   "        <TD WIDTH=30%>"
   "         <P><B>On Seniors Health Card</B></P>"
   "        </TD>"
   "        <TD WIDTH=105 >"
   "         <P>%seniors%</P>"
   "        </TD>"
   "       </TR>"
   "       <TR VALIGN=TOP>"
   "        <TD WIDTH=213 >"
   "         <P><BR>"
   "         </P>"
   "        </TD>"
   "        <TD WIDTH=220 >"
   "         <P><B>Private Patients Bulk Bille</B>d</P>"
   "        </TD>"
   "        <TD WIDTH=105 >"
   "         <P>%no-card%</P>"
   "        </TD>"
   "       </TR>"
   "      </TABLE>"
   "      <P><BR><BR>"
   "      </P>"
   "     </TD>"
   "     <TD WIDTH=76 >"
   "      <P>%bbillmc%</P>"
   "     </TD>"
   "    </TR>"
   "    <TR VALIGN=TOP>"
   "     <TD WIDTH=553 >"
   "      <P><B>Patients Bulk Billed (Veteran)</B></P>"
   "     </TD>"
   "     <TD WIDTH=76 >"
   "      <P>%bbvet%</P>"
   "     </TD>"
   "    </TR>"
   "    <TR VALIGN=TOP>"
   "     <TD WIDTH=553 >"
   "      <P><B>Patients Billed Privately</B></P>"
   "     </TD>"
   "     <TD WIDTH=76 >"
   "      <P>$privbill%</P>"
   "     </TD>"
   "    </TR>"
   "   </TABLE>"
   "   <P><BR><BR>"
   "   </P>"
   "  </TD>"
   "  <TD WIDTH=50% >"
   "   <DIV ALIGN=RIGHT>"
   "    <TABLE WIDTH=653 CELLPADDING=0 CELLSPACING=0 >"
   "     <COL WIDTH=316>"
   "     <COL WIDTH=316>"
   "     <TR VALIGN=TOP>"
   "      <TD WIDTH=316 >"
   "       <P><B>Cash</B></P>"
   "      </TD>"
   "      <TD WIDTH=316 >"
   "       <P>%cash%</P>"
   "      </TD>"
   "     </TR>"
   "     <TR VALIGN=TOP>"
   "      <TD WIDTH=316 >"
   "       <P><B>Electronic Funds Transfer POS (EFTPOS)</B></P>"
   "      </TD>"
   "      <TD WIDTH=316 >"
   "       <P>%eftpos</P>"
   "      </TD>"
   "     </TR>"
   "     <TR VALIGN=TOP>"
   "      <TD WIDTH=316 >"
   "       <P><B>Cheque</B></P>"
   "      </TD>"
   "      <TD WIDTH=316 >"
   "       <P>%cheque</P>"
   "      </TD>"
   "     </TR>"
   "     <TR VALIGN=TOP>"
   "      <TD WIDTH=316 >"
   "       <P><B>Electronic Funds Transfer (Not at POS)</B></P>"
   "      </TD>"
   "      <TD WIDTH=316 >"
   "       <P>%eft-notefpos%</P>"
   "      </TD>"
   "     </TR>"
   "     <TR VALIGN=TOP>"
   "      <TD WIDTH=316 >"
   "       <P><B>Medicare Cheque</B></P>"
   "      </TD>"
   "      <TD WIDTH=316 >"
   "       <P>%medicare-cheque%</P>"
   "      </TD>"
   "     </TR>"
   "     <TR VALIGN=TOP>"
   "      <TD WIDTH=316 >"
   "       <P><B>Veterans Cheque</B></P>"
   "      </TD>"
   "      <TD WIDTH=316 >"
   "       <P>%veterans cheque%</P>"
   "      </TD>"
   "     </TR>"
   "     <TR VALIGN=TOP>"
   "      <TD WIDTH=316 >"
   "       <P ALIGN=LEFT >Empty column</P>" 
   "</TD>"
   "      <TD WIDTH=316 >"
   "       <P ALIGN=LEFT>Empty column</P>"
   "      </TD>"
   "     </TR>"
   "     <TR VALIGN=TOP>"
   "      <TD WIDTH=316 >"
   "       <P ALIGN=LEFT><B>TOTAL (GST)</B></P>"
   "      </TD>"
   "      <TD WIDTH=316 >"
   "       <P>%gst-total%</P>"
   "      </TD>"
   "     </TR>"
   "     <TR VALIGN=TOP>"
   "      <TD WIDTH=316 >"
   "       <P><B>TOTAL (INCLUDING GST)</B></P>"
   "      </TD>"
   "      <TD WIDTH=316 >"
   "       <P>%total-including-gst%</P>"
   "      </TD>"
   "     </TR>"
   "    </TABLE>"
   "   </DIV>"
   "   <P><BR><BR>"
   "   </P>"
   "  </TD>"
   " </TR>"
   "</TABLE>"
   
End
