' Gambas class file

Private visits As Collection
Private visit As Collection

Public Sub init()
   
   With columnview1
      .Columns.Count = 10
      
      .Columns[0].text = "Appt"
      .Columns[1].text = "Patient"
      .Columns[2].text = "   Bill To   "
      .Columns[3].text = "Item"
      .Columns[4].text = "Descriptor"
      .Columns[5].text = "Amount"
      .Columns[6].text = "Amount gst"
      .Columns[7].text = "Paid"
      .Columns[8].text = "Paid By"
      .Columns[9].text = "Owing"
   End With   
   
End

Public Sub Day_list_Show(the_date As Date)
   
   Dim payer As String
   Dim item As String
   Dim x As Integer
   Dim num_visits As Integer 'may not be same as individual patients seen
   Dim num_visits_bb_have_concession_card As Integer
   Dim num_visits_bb_no_concession_card As Integer
   Dim num_visits_veteran As Integer
   Dim num_visits_private As Integer
   Dim fk_Last_invoice As Integer
   Dim total_billed As Float
   Dim total_paid As Float
   Dim running_total As Float
   Dim payment_totals As New Float[7] 
   Dim monies_received As Collection
   Dim payment_methods As Collection
   Dim running_total_gst As Float
   Dim payments_for_invoice As Collection
   Dim payment_for_invoice As Collection
   Dim payment_count As Integer
   Dim centrelink_card_types As Collection
   Dim concession_card_none_total As Integer
   Dim num_concession_card_pensioner As Integer
   Dim num_concession_card_healthcare As Integer
   Dim num_concession_card_seniors As Integer
   Dim num_private_patients_bulk_billed As Integer

   Inc Application.Busy
   payment_methods = modBillingDBI.Payment_Methods_Get()
   monies_received = modBillingDBI.Receipts_Get_For_Day(the_date)
   ' centrelink_card_types = modBillingDBI.Centrelink_Card_Types_Get() 'clerical.lu_centrelink_card_type
   visits = modBillingDBI.Day_List_Get(the_date, modDBConnect.currentUser!fk_branch, modDBConnect.currentUser!fk_staff)
   tlDaySummary.text = ""
   With columnview1
      .Clear 
      For x = 0 To .Columns.Count - 1
         .Columns[x].Alignment = Align.left
      Next
   End With
   For Each visit In visits
      columnview1.Add(visit!pk_items_billed, 0)
      If fk_Last_invoice <> visit!fk_invoice Then                                             'for each distinct invoice
         If Not IsNull(visit!appointment_time) Then                                           'if exists, show appointment time
            columnview1[visit!pk_items_billed][0] = Format(visit!appointment_time, "hh:nn")   ' eg. 09:00 FIXME PUT IN AM/PM
         Else 
            columnview1[visit!pk_items_billed][0] = ""                                        'this may not exist if billed without appointment in book  
         Endif
         columnview1[visit!pk_items_billed][1] = visit!patient_wholename
         payer = ""
         If Not IsNull(visit!fk_lu_bulk_billing_type) Then
            If visit!fk_lu_bulk_billing_type = const.BulkBilling_Type_Medicare Then
               Payer = "Medicare"
               If Not IsNull(visit!fk_lu_centrelink_card_type) Then
                  If visit!fk_lu_centrelink_card_type > 1 Then '1=none
                     Inc num_visits_bb_have_concession_card
                     Select Case visit!fk_lu_centrelink_card_type
                        Case const.Centrelink_Concession_Card_Health_Care_Card
                           Inc num_concession_card_healthcare
                        Case const.Centrelink_concession_card_seniors_Health_Card
                           Inc num_concession_card_seniors
                        Case const.Centrelink_concession_card_pensioner_concession_card
                           Inc num_concession_card_pensioner
                     End Select
                  End If
               Else
                  Inc num_visits_bb_no_concession_card
               End If   
            Else
               Payer = "Veterans"
               Inc num_visits_veteran
            Endif
         Else
            Inc num_visits_private 
         Endif
         If payer = "" Then 
            If IsNull(visit!fk_payer_person) And IsNull(visit!fk_payer_branch) Then 
               payer = "Patient"
            Else
               If Not IsNull(visit!payer_organisation) Then
                  payer = visit!payer_organisation128
               Else
                  payer = visit!payer_person_wholename
               End If   
            End If
         End If   
         columnview1[visit!pk_items_billed][2] = payer
         fk_Last_invoice = visit!fk_invoice
         Inc num_visits
      Else                                                                                     
         columnview1[visit!pk_items_billed][0] = ""                                          'suppress duplicates
         columnview1[visit!pk_items_billed][1] = "" 
         columnview1[visit!pk_items_billed][2] = ""
      Endif
      columnview1[visit!pk_items_billed][3] = Trim(visit!mbs_item & " " & visit!ama_item & " " & visit!user_item)
      columnview1[visit!pk_items_billed][4] = visit!descriptor_brief
      columnview1[visit!pk_items_billed][5] = visit!amount
      If Not IsNull(visit!amount_gst) Then
         columnview1[visit!pk_items_billed][6] = visit!amount_gst
      Else
         columnview1[visit!pk_items_billed][6] = "$0.0"
      Endif
      If Not IsNull(visit!total_paid) Then
         'get payment method.
         payments_for_invoice = modBillingDBI.Invoice_Payments_For_Get(visit!fk_invoice)
         If payments_for_invoice.count Then 'BUG HERE SHOULD NEVER HAPPEN IE INPUT/sve BUG has created this
            payment_count = 0
            For Each payment_for_invoice In payments_for_invoice
               If payment_count = 1 Then 
                  columnview1.Add(visit!pk_items_billed & "-" & Str(payment_count), 0)
                  columnview1[visit!pk_items_billed & "-" & Str(payment_count)][0] = "" 
                  columnview1[visit!pk_items_billed & "-" & Str(payment_count)][7] = payment_for_invoice!amount_paid 
                  columnview1[visit!pk_items_billed & "-" & Str(payment_count)][8] = payment_for_invoice!payment_method   
               Else
                  columnview1[visit!pk_items_billed][7] = payment_for_invoice!amount_paid      
                  columnview1[visit!pk_items_billed][8] = payment_for_invoice!payment_method 
               End If  
               Inc payment_count
            Next   
         End If   
      Else
         columnview1[visit!pk_items_billed][7] = "$0.0"
      End If
      '  If Not IsNull(visit!payment_method) Then
      
      ' Endif
      ' payment_totals[visit!fk_lu_payment_method] = payment_totals[visit!fk_lu_payment_method] + CFloat(Replace(visit!amount_paid, "$", ""))
      ' running_total += modUtil.MoneyToFloat(visit!amount_paid)
      ' If visit!invoice_paid = True Then
      '    If Not IsNull(visit!item_billed_amount_gst) Then128
      '       running_total_gst += modUtil.MoneyToFloat(visit!item_billed_amount_gst)
      '    Endif
      ' Endif
      
   Next
   '----------------------------
   'construct a bit of a summary
   '----------------------------
   tlDaySummary.text &= "<P><B>Summary</B><P>"
   tlDaySummary.text &= "<B>Patients seen:</B>" & num_visits & "<BR>" 'put reason patient not seen and print under here
   tlDaySummary.text &= "<B>Patients billed:</B>" & num_visits & "<BR>"
   tlDaySummary.text &= "<B>Bulk Billed on concession card:</B>" & num_visits_bb_have_concession_card & "<BR>"
   If num_concession_card_healthcare Then
      tlDaySummary.text &= "- Health care card holders:" & Str(num_concession_card_healthcare) & "<BR>"
   Endif
   If num_concession_card_pensioner Then
      tlDaySummary.text &= "- Pensioner card holders:" & Str(num_concession_card_pensioner) & "<BR>"
   Endif
   If num_concession_card_seniors Then
      tlDaySummary.text &= "- Sensiors health card total:" & Str(num_concession_card_seniors) & "<BR>"
   Endif
   tlDaySummary.text &= "<B>Bulk Billed no concession card:</B>" & num_visits_bb_no_concession_card & "<BR>" & "<BR>"
   tlDaySummary.text &= "<B>Bulk Billed Veteran:</B>" & num_visits_veteran & "<BR>"
   tlDaySummary.text &= "<B>Private Billing:</B>" & num_visits_private & "<BR>"
   tlDaySummary.text = Replace(tlDaySummary.text, "%seen%", Str(num_visits))
   tlDaySummary.text = Replace(tlDaySummary.text, "%billed%", Str(num_visits))
   '   tlDaySummary.text = Replace(tlDaySummary.text, "%seen%", num_visits)
   tlDaySummary.text = Day_List_Receipts_Summary_HTML()
   tlDaySummary.text = Replace(tlDaySummary.text, "%seen%", Str(num_visits))
   tlDaySummary.text = Replace(tlDaySummary.text, "%billed%", Str(num_visits))
   tlDaySummary.text = Replace(tlDaySummary.text, "%numHCC%", Str(num_concession_card_healthcare))
   tlDaySummary.text = Replace(tlDaySummary.text, "%pensioner%", Str(num_concession_card_pensioner))
   tlDaySummary.text = Replace(tlDaySummary.text, "%seniors%", Str(num_concession_card_seniors))
   tlDaySummary.text = Replace(tlDaySummary.text, "%no-card%", Str(num_visits_bb_no_concession_card))
   tlDaySummary.text = Replace(tlDaySummary.text, "%bbillmc%", Str(num_concession_card_seniors))
   tlDaySummary.text = Replace(tlDaySummary.text, "%bbvet%", Str(num_visits_veteran))
   tlDaySummary.text = Replace(tlDaySummary.text, "%privbill%", Str(num_visits_private))
   webview1.HTML = tlDaySummary.text
   Dec Application.Busy
   
End

Public Sub DateChooser1_Activate()
   
   Day_list_Show(Last.value)
   
End

Public Function Day_List_Receipts_Summary_HTML() As String
   
   Return ""
   "<HTML>"
   ""
   "<BODY>"
   "<TABLE WIDTH=" & Str$(tlDaySummary.width) & " CELLPADDING=0 BORDER = 1 CELLSPACING=0 >"
   " <COL WIDTH=50%>"
   " <COL WIDTH=50%>"
   " <TR VALIGN=TOP>"
   "  <TD WIDTH=50% >"
   "   <P ALIGN=CENTER><B>Billing Summary</B></P>"
   "  </TD>"
   "  <TD WIDTH=50% >"
   "   <P ALIGN=CENTER><B>Receipts Taken</B></P>"
   "  </TD>"
   " </TR>"
   " <TR VALIGN=TOP>"
   "  <TD WIDTH=50% >"
   "   <TABLE WIDTH=650 CELLPADDING=0 CELLSPACING=0 >"
   "    <COL WIDTH=553>"
   "    <COL WIDTH=76>"
   "    <TR VALIGN=TOP>"
   "     <TD WIDTH=553 >"
   "      <P><B>Patients Seen</B></P>"
   "     </TD>"
   "     <TD WIDTH=76 >"
   "      <P>%seen%</P>"
   "     </TD>"
   "    </TR>"
   "    <TR VALIGN=TOP>"
   "     <TD WIDTH=553 >"
   "      <P><B>Patients Billed</B></P>"
   "     </TD>"
   "     <TD WIDTH=76 >"
   "      <P>%billed%</P>"
   "     </TD>"
   "    </TR>"
   "    <TR VALIGN=TOP>"
   "     <TD WIDTH=100% >"
   "      <P><B>Patients Bulk Billed (Medicare)</B></P>"
   "      <TABLE >"
   "       <COL WIDTH=40%>"
   "       <COL WIDTH=30%>"
   "       <COL WIDTH=20%>"
   "       <TR VALIGN=TOP>"
   "        <TD WIDTH=50% >"
   "         <P></P>"
   "        </TD>"
   "        <TD WIDTH=30% >"
   "         <P><B>On Health Care Card</B></P>"
   "        </TD>"
   "        <TD WIDTH=20 >"
   "         <P>%numHCC%</P>"
   "        </TD>"
   "       </TR>"
   "       <TR VALIGN=TOP>"
   "        <TD WIDTH=50%>"
   "         <P>"
   "         </P>"
   "        </TD>"
   "        <TD WIDTH=30%>"
   "         <P><B>On Pensioner Card</B></P>"
   "        </TD>"
   "        <TD WIDTH=10%>"
   "         <P>%pensioner%</P>"
   "        </TD>"
   "       </TR>"
   "       <TR VALIGN=TOP>"
   "        <TD WIDTH=213 >"
   "         <P><BR>"
   "         </P>"
   "        </TD>"
   "        <TD WIDTH=30%>"
   "         <P><B>On Seniors Health Card</B></P>"
   "        </TD>"
   "        <TD WIDTH=105 >"
   "         <P>%seniors%</P>"
   "        </TD>"
   "       </TR>"
   "       <TR VALIGN=TOP>"
   "        <TD WIDTH=213 >"
   "         <P><BR>"
   "         </P>"
   "        </TD>"
   "        <TD WIDTH=220 >"
   "         <P><B>Private Patients Bulk Bille</B>d</P>"
   "        </TD>"
   "        <TD WIDTH=105 >"
   "         <P>%no-card%</P>"
   "        </TD>"
   "       </TR>"
   "      </TABLE>"
   "      <P><BR><BR>"
   "      </P>"
   "     </TD>"
   "     <TD WIDTH=76 >"
   "      <P>%bbillmc%</P>"
   "     </TD>"
   "    </TR>"
   "    <TR VALIGN=TOP>"
   "     <TD WIDTH=553 >"
   "      <P><B>Patients Bulk Billed (Veteran)</B></P>"
   "     </TD>"
   "     <TD WIDTH=76 >"
   "      <P>%bbvet%</P>"
   "     </TD>"
   "    </TR>"
   "    <TR VALIGN=TOP>"
   "     <TD WIDTH=553 >"
   "      <P><B>Patients Billed Privately</B></P>"
   "     </TD>"
   "     <TD WIDTH=76 >"
   "      <P>$privbill%</P>"
   "     </TD>"
   "    </TR>"
   "   </TABLE>"
   "   <P><BR><BR>"
   "   </P>"
   "  </TD>"
   "  <TD WIDTH=50% >"
   "   <DIV ALIGN=RIGHT>"
   "    <TABLE WIDTH=653 CELLPADDING=0 CELLSPACING=0 >"
   "     <COL WIDTH=316>"
   "     <COL WIDTH=316>"
   "     <TR VALIGN=TOP>"
   "      <TD WIDTH=316 >"
   "       <P><B>Cash</B></P>"
   "      </TD>"
   "      <TD WIDTH=316 >"
   "       <P>%cash%</P>"
   "      </TD>"
   "     </TR>"
   "     <TR VALIGN=TOP>"
   "      <TD WIDTH=316 >"
   "       <P><B>Electronic Funds Transfer POS (EFTPOS)</B></P>"
   "      </TD>"
   "      <TD WIDTH=316 >"
   "       <P>%eftpos</P>"
   "      </TD>"
   "     </TR>"
   "     <TR VALIGN=TOP>"
   "      <TD WIDTH=316 >"
   "       <P><B>Cheque</B></P>"
   "      </TD>"
   "      <TD WIDTH=316 >"
   "       <P>%cheque</P>"
   "      </TD>"
   "     </TR>"
   "     <TR VALIGN=TOP>"
   "      <TD WIDTH=316 >"
   "       <P><B>Electronic Funds Transfer (Not at POS)</B></P>"
   "      </TD>"
   "      <TD WIDTH=316 >"
   "       <P>%eft-notefpos%</P>"
   "      </TD>"
   "     </TR>"
   "     <TR VALIGN=TOP>"
   "      <TD WIDTH=316 >"
   "       <P><B>Medicare Cheque</B></P>"
   "      </TD>"
   "      <TD WIDTH=316 >"
   "       <P>%medicare-cheque%</P>"
   "      </TD>"
   "     </TR>"
   "     <TR VALIGN=TOP>"
   "      <TD WIDTH=316 >"
   "       <P><B>Veterans Cheque</B></P>"
   "      </TD>"
   "      <TD WIDTH=316 >"
   "       <P>%veterans cheque%</P>"
   "      </TD>"
   "     </TR>"
   "     <TR VALIGN=TOP>"
   "      <TD WIDTH=316 >"
   "       <P ALIGN=LEFT >Empty column</P>" 
   "</TD>"
   "      <TD WIDTH=316 >"
   "       <P ALIGN=LEFT>Empty column</P>"
   "      </TD>"
   "     </TR>"
   "     <TR VALIGN=TOP>"
   "      <TD WIDTH=316 >"
   "       <P ALIGN=LEFT><B>TOTAL (GST)</B></P>"
   "      </TD>"
   "      <TD WIDTH=316 >"
   "       <P>%gst-total%</P>"
   "      </TD>"
   "     </TR>"
   "     <TR VALIGN=TOP>"
   "      <TD WIDTH=316 >"
   "       <P><B>TOTAL (INCLUDING GST)</B></P>"
   "      </TD>"
   "      <TD WIDTH=316 >"
   "       <P>%total-including-gst%</P>"
   "      </TD>"
   "     </TR>"
   "    </TABLE>"
   "   </DIV>"
   "   <P><BR><BR>"
   "   </P>"
   "  </TD>"
   " </TR>"
   "</TABLE>"
   "<P><BR><BR>"
   "</P>"
   "</BODY>"
   "</HTML>" 
   
End
