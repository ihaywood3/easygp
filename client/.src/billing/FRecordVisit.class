' Gambas class file

' Copyright (C) 2008-2012 Dr. Richard Terry

' This program is free software: you can redistribute it and/or modify
' it under the terms of the GNU General Public License as published by
' the Free Software Foundation, either version 3 of the License, or
' (at your option) any later version.

' This program is distributed in the hope that it will be useful,
' but WITHOUT ANY WARRANTY; without even the implied warranty of
' MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
' GNU General Public License for more details.

' You should have received a copy of the GNU General Public License
' along with this program.  If not, see <http://www.gnu.org/licenses/>.
'
' A Form to record the patients visit and raise the item number
'----------------------------------------------------------------------
'THIS FORM WILL NOT WORK IT IS VERY MUCH PROTOTYPE PRE-ALPHA ONLY
'ONLY FOR PROOF OF CONCEPT
'FIX ME APPOINTMENT ICONS SPREAD OVER Frecordvisit, FMakeAppointments and ModAppointmentsDBI -FIXME
'-----------------------------------------------------------------
Private currentconsult As CConsult
Private bexit As Boolean
Private OnRow As Integer
Private OnCol As Integer
Private GridData As Collection 
Private GridRows As Collection
Private iLeft As Integer
Private iTop As Integer
Private i As Integer
Private iFirstRow As Integer
Private iLastRow As Integer
Private bFoundFirst As Integer
Private SeenBy As Collection 
Private clinic As Collection
Private clinics As Collection
Private items As Collection 
Private item As Collection
Private form_appointments As FDayList
Private appointment_icons As Collection   
Private staff As Collection
Private Staff_Member As Collection
Private Unbilled_Consultations As Collection 
Private Unbilled_consultation As Collection
Private payers As Collection
Private payer As Collection   'could be patient/organisation etc
Private cGridColumn_ItemNumber As Integer = 0
Private cGridColumn_BriefDescriptor As Integer = 1
Private Payment_Methods As Collection


Public Sub Init() '(cons As CConsult)
   '---------------------------------------------------------
   'Do all the form initialisation stuff like adding stuff to 
   'combo's, setting numbers of columns in lists, displaying
   'the patients contact details
   '---------------------------------------------------------
   Dim x As Integer
   'currentconsult = Cons         'set current consult
   Appointment_Icons = Appointment_icons_Get_Picture(modAppointmentsDBI.Appointment_icons_get())
    With form_appointments = New FDayList(Vbox_Appointments)
     '  .Init(Staff_Member, Now(), modDBConnect.currentUser!fk_clinic, Appointment_Icons)
   End With
   With cvwUnBilled
      .Columns.count = 2
   End With
   lblmeasure.text = "  Payment Method "
   modEditAreaHelpers.Resize_labels(VBox_EditArea_Inner, lblmeasure)
   Payment_methods = modUtil.LoadCombo(cmbPaymentMethods, modBillingDBI.Payment_Methods_Get(), "method")
   staff = modUtil.LoadCombo(cmbStaff, modContactsDBI.Staff_Get(), "wholename")  
   cmbStaff.index = 0
   cvwUnBilled_Refresh  
   Gridview1_Init()

   Me.Center()
   Try Settings_Load()         'load settings for this form
   GridRows = New Collection
   seenBy = modUtil.LoadCombo(cmbSeenBy, modInboxDBI.Inbox_Staff_Get(), "wholename")
   clinics = modUtil.LoadCombo(cmbLocation, modAdminDBI.Clinics_Get(), "branch")
   columnview1.Columns.count = 3
End

Public Sub EditArea_Clear()
   bExit = True
 ' fk_payer = 0
  modEditAreaHelpers.EditArea_Clear(VBox_EditArea_Inner) 
  textlabelPayer.text = ""
  bexit = False
   
End

Public Sub cvwUnBilled_Refresh()
   '------------------------------------------------------------------------
   'Display a list of all unbilled consultations ordered by appointment date
   '-------------------------------------------------------------------------
    
    Unbilled_Consultations = modBillingDBI.Consultations_UnBilled_Get()
    cvwUnBilled.Clear()
    For Each Unbilled_consultation In Unbilled_Consultations
        cvwUnBilled.Add(Unbilled_consultation!pk, 0)
        cvwUnBilled[Unbilled_consultation!pk][0] = Format(Unbilled_consultation!begin, "dd/mm/yyyy")
        cvwUnBilled[Unbilled_consultation!pk][1] = Unbilled_consultation!wholename
    Next
End



Public Sub Gridview1_Init()
    Dim x As Integer
      ' With gridview2
      '    .Rows.count = 1
      '    .Columns.count = 5
      '    .Columns[1].Alignment = Align.Right
      '    .height = 24
      ' End With
      ' gridview2[0, 1].Text = "Total "
      With gridview1
     .Rows.H = 20 
     .Columns.Count = 5
     .Rows.count = 5
     For x = 0 To 4
       If x <> 1 Then 
         .Columns[x].Width = 100
         label101.width = 100
          lblInvoiceTotal.width = 100
           label104.width = 100
            label105.width = 100
       '  gridview2.Columns[x].width = 100
       Else
         .Columns[1].width = gridview1.width - 400
         label200.width = gridview1.width - 400
       '  gridview2.Columns[x].Width = gridview1.width - 400
       End If
     Next
     .Columns[0].text = "Item"
     .Columns[1].text = "Description"
     .Columns[2].text = "Fee"
     .Columns[3].text = "Rate"
     .Columns[4].text = "GST"
    
   End With
     gridview1.height = 100
   
End

Public Sub Gridview1_Rebuild(data As Collection)
   
  Dim i As Integer
  
  gridview1.Clear()
  gridview1.Rows.count = data.count
  For i = 0 To data.count - 1
      gridview1[i, 0].text = data[i]!time
      gridview1[i, 1].picture = data[i]!picture
      gridview1[i, 2].text = data[i]!name
      gridview1.Rows[i].height = data[i]!slots * 20
      
    '  gridview1[i, 1].Picture = pic
  Next
   
End
Public Sub GridView1_Click()
   
   Print "on row" & gridview1.Row
   Print "on col" & gridview1.Column
   onrow = gridview1.Row
   OnCol = gridview1.Column
End

Public Sub GridView1_DblClick()
   Dim i As Integer
   Dim iSlotCount As Integer
   
   TextBox1.text = ""                              'clear search textbox
   bFoundFirst = False  

   Print "The first was ", iFirstRow
   Print "The last was ", iLastRow
    For i = 0 To gridview1.rows.count - 1           'figure out which rows are selected
       
      If gridview1.rows[i].selected = True Then
         If bfoundfirst = False Then
            bfoundfirst = True
            ifirstrow = i
         End If 
         ilastrow = i
         Print "row " & i & " is selected"
      End If 
    '  If bfoundfirst = False Then 
    '     islotcount += gridrows[i]!slots
    '  Endif
   Next   
   Print gridview1.Rows.Select
   Print gridview1.Rows.height 
   onrow = gridview1.Row 
   iLeft = gridview1[onrow, oncol].Left
  ' iTop = onrow * gridview1.Rows.height 
   iTop = ((onrow + 1) * 20) + 1 'iSlotCount * 20
 ' iTop = iFirstRow * gridview1.Rows.height 
   TextBox1.left = iLeft + 2
   TextBox1.top = iTop
   TextBox1.width = gridview1.Columns[oncol].Width + 4
  ' TextBox1.top = gridview1.ScreenX
   TextBox1.Height = ((iLastRow - iFirstRow) + 1) * gridview1.Rows[0].Height + 5
   TextBox1.Visible = True
   TextBox1.SetFocus()
   
End

Public Sub GridView1_Select()
   
   TextBox1.Visible = False   
   
End
Public Sub gridview_Keypress()
    If bExit Then Return 
   ' bexit = True
   ' GridView1_DblClick()
   ' TextBox1.text = Asc(gridview1.Key.code)
End

Public Sub cmbEditArea_Click()
   
  ' Dim window1 As Window
   
   Select Case Last.tag
      Case "staff"
      '   For Each window1 In Workspace1.windows
         '   If window1.Caption = staff[cmbstaff.index]!wholename & " from " & Format(Now, gb.LongDate) Then
          '     Workspace1.ActiveWindow = Window1
          '     Workspace1.Tag = Staff_Member
           '    Return
          '  Endif
       '  Next
         Staff_Member = staff[cmbStaff.Index]
         form_appointments.Init(Staff_Member, Now(), modDBConnect.currentUser!fk_clinic, Appointment_Icons)

       '  Generate_WeekList(Now)
       '  cmbStaff.index = -1
     ' Case "location" 
   End Select
   
End
Public Sub Textbox1_KeyRelease()
  '  '--------------------------------------------
  '  'First, rebuild the array of appointment times
  '  '--------------------------------------------
  '  
   columnview1.Clear
   If Trim(TextBox1.text) = "" Then Return   
   items = modBillingDBI.Descriptors_Get(Last.text)
   
   For Each item In items  
      
   Next

   
End

Public Sub GridView1_Menu()

  ' mnuRecordVisit.popup()

End

Public Sub Form_Close()
   
  Settings_Save() 
   
End

Private Sub Settings_Load()
     Try Vsplit_Main.layout = Settings["Billing_RecordVisit/VSplit_Main.Layout"]
   
   
End

Public Sub Settings_Save()
   
   Settings["Billing_RecordVisit/VSplit_Main.Layout"] = Vsplit_Main.Layout
   
End

Public Sub Save()
   
   
   
End



Public Sub Form_Resize()

   Gridview1_Init()

End

Public Sub EditArea_TextBox_GotFocus()

   rbInvoiceToOther.value = True

End
Public Sub Appointment_icons_Get_Picture(Appointment_Icons As Collection) As Collection 
   '-----------------------------------------------------------------------------------------
   'Loads the actual picture of the appointment icon into the collection got from the backend
   '-----------------------------------------------------------------------------------------
   
   Dim Appointment_icon As Collection
   
   For Each Appointment_Icon In Appointment_Icons
      Appointment_Icon!picture = Picture.Load(Appointment_Icon!icon_path)
   Next
   Return Appointment_Icons
   
End

Public Sub cvwUnBilled_Click()

   EditArea_Clear()
   cvwUnBilled.MoveCurrent()
   txtpatient.text = Unbilled_Consultations[cvwUnBilled.Item.key]!wholename
   txtDate.text = Format(Unbilled_Consultations[cvwUnBilled.Item.key]!begin, "dd/mm/yyyy")
   'temp code get the responsible person FIXME  body code only whilst developin
   'need more inclusive way of getting the payer - eg might not be a patient
   payer = modBillingDBI.Responsible_Payer_Get(Unbilled_Consultations[cvwUnBilled.Item.key]!fk_patient)
   Try textlabelPayer.text = payer!wholename & "<BR>" & Trim(payer!street1 & " " & payer!street2) & " " & payer!town & " " & payer!postcode
End

Public Sub TextBox1_Activate()

   Print "column is:" & gridview1.Column
   Select Case gridview1.Column
      Case cGridColumn_ItemNumber
          gridview1[gridview1.row, 0].Text = TextBox1.text
          TextBox1.Visible = False  
          Get_Items(TextBox1.text)
         
   End Select

End

Public Sub Get_Items(txt As String)
     Items = modBillingDBI.Items_Get(Trim(txt))
     If items.count = 1 Then
        For Each item In items 'fixme ?proper way of doing this
           gridview1[gridview1.row, 1].Text = item!descriptor_brief
           gridview1[gridview1.row, 2].Text = item!price
        Next
     Endif
     gridview1.row = gridview1.row + 1
     Invoice_Calculate_Total()
     gridview1.SetFocus()
     GridView1_DblClick()
End

Public Sub Invoice_Calculate_Total()
    Dim x As Integer
    Dim total As Float
    
    For x = 0 To gridview1.Rows.Count - 1
        If gridview1[x, 2].text = "" Then Break
        total = total + CFloat(Val(Replace(gridview1[x, 2].text, "$", "")))
    Next
   
    lblInvoiceTotal.text = "  " & Format$(total, "$,#.###")
  
End


Public Sub rbInvoiceTo_Click()

   textlabelPayer.text = ""

End


