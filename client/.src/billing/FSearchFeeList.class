' Gambas class file

Private bExit As Boolean
Public ScheduledFeeItems As Collection 'must be public
Private timer_count As Integer
Private FeeItem As Collection

Public Sub _new()
   
    With gvwFeeScheduleItems
      .Clear
      .Columns.count = 2
      .Rows.count = 0
   End With
   tbRefresh_Click
  ' ScheduledFeeItems = modUtil.Copy_Collection_Keyed_Sequentially(modBillingDBI.Fees_Get_With_Brief_Descriptor())
  
End

Public Sub Fee_Schedule_Reload()
   
   ' timer1.Stop
   ' bexit = True
   ' combobox1.index = 0 'items with brief descriptor
   ' bexit = False
   ' 
   ' Inc Application.Busy
    ScheduledFeeItems = modUtil.Copy_Collection_Keyed_Sequentially(modBillingDBI.Fees_Get_With_Brief_Descriptor())
   ' gvwFeeScheduleItems_FillGrid()
   ' Dec Application.Busy
   
End

Public Sub gvwFeeScheduleItems_FillGrid()
   
   Dim FeeItem As Collection
   Dim num_patients As String = ""
   Dim x As Integer
   
   For Each FeeItem In ScheduledFeeItems
      num_patients = ""
      If FeeItem!percentage_fee_rule Then
         num_patients = "/" & Str(FeeItem!number_of_patients)
      Endif
      Inc gvwFeeScheduleItems.rows.count
      gvwFeeScheduleItems.row = x
      gvwFeeScheduleItems[gvwFeeScheduleItems.row, 0].text = Trim(FeeItem!mbs_item & " " & FeeItem!ama_item & " " & FeeItem!user_item) & num_patients
      gvwFeeScheduleItems[gvwFeeScheduleItems.row, 1].text = FeeItem!descriptor_brief
      gvwFeeScheduleItems[gvwFeeScheduleItems.row, 1].WordWrap = True
      gvwFeeScheduleItems.Rows[gvwFeeScheduleItems.row].Height = -1
      Inc x
   Next
   
End

Public Sub txtSearch_GotFocus()
   
   txtSearch.Text = ""
   Last.BackGround = Color.rgb(95, 255, 175)
   txtSearch.Clear()
   combobox1.index = -1
   txtFilter.text = ""                                   'don't allow filter on the brief descriptor whilst searching
   
End

Public Sub txtSearch_KeyRelease()
   
   timer_count = 0
   timer1.Enabled = True
   timer1.Start
   
End

Public Sub txtSearch_LostFocus()
   
   Last.BackGround = Color.White
   timer1.stop
   
End

Public Sub timer1_Timer()
   
   Inc timer_count
   If timer_count > 3 Then
      Scheduled_Fees_Search
   Endif
   
End

Public Sub Scheduled_Fees_Search()
   '-----------------------------------------------------
   'User has typed in txtSearch for fee item
   'They will have typed either a number, or text phrase
   '-----------------------------------------------------
   
   timer1.Stop
   Inc Application.Busy
   ScheduledFeeItems = modUtil.Copy_Collection_Keyed_Sequentially(modBillingDBI.Descriptors_Get(txtSearch.Text, True, False))
   Scheduled_Fees_Reload
   Dec Application.Busy
   
End

Public Sub Scheduled_Fees_Reload()
   '----------------------------------------------------
   'display the fee schedule items filtered by txtFilter
   '----------------------------------------------------
   
   Dim bskip As Boolean
   Dim num_patients As String = ""
   Dim x As Integer
   
   With gvwFeeScheduleItems
      .Clear
      .Columns.count = 2
      .Rows.count = 0
   End With
   If IsNull(ScheduledFeeItems) Then Return
   For Each FeeItem In ScheduledFeeItems
      bSkip = False
      If txtFilter.text <> "" Then
         If Not IsNull(FeeItem!descriptor_brief) Then
            If Not InStr(Lower(FeeItem!descriptor_brief), Lower(Trim(txtFilter.text))) Then
               bskip = True
            Endif
         Else
            If Not InStr(Lower(FeeItem!descriptor), Lower(Trim(txtFilter.text))) Then
               bskip = True
            Endif
         End If
      End If
      If Not bskip Then
         Inc gvwFeeScheduleItems.rows.count
         '  gvwFeeScheduleItems.row = x
         num_patients = ""
         If FeeItem!percentage_fee_rule Then
            num_patients = "/" & Str(FeeItem!number_of_patients)
         Endif
         gvwFeeScheduleItems[x, 0].text = Trim(FeeItem!mbs_item & " " & FeeItem!ama_item & " " & FeeItem!user_item) & num_patients
         If Not IsNull(FeeItem!descriptor_brief) Then
            gvwFeeScheduleItems[x, 1].text = FeeItem!descriptor_brief
            gvwFeeScheduleItems[x, 1].WordWrap = True
            gvwFeeScheduleItems.rows[x].Height = -1
         Else
            gvwFeeScheduleItems[x, 1].text = FeeItem!descriptor
            gvwFeeScheduleItems[x, 1].WordWrap = True
            gvwFeeScheduleItems.rows[x].Height = -1
         End If
         Inc x
      End If
   Next
   If gvwFeeScheduleItems.Rows.count Then
      gvwFeeScheduleItems.row = 0
      gvwFeeScheduleItems.Rows[0].Selected = True
   Endif
   
End


Public Sub txtFilter_KeyRelease()
   
   Scheduled_Fees_Reload
   
End

Public Sub tbRefresh_Click()

   txtSearch.text = ""
   txtFilter.Text = ""
   Scheduled_Fees_Reload

End
