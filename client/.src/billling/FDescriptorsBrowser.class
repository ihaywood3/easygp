' Gambas class file

Private Descriptors As Collection
Private Descriptor As Collection
Private bExit As Boolean
Private lcRow As CDescriptorRow
Private timer_count As Integer 


Public Sub Init()
   
   modEditAreaHelpers.Resize_labels(Vbox_Editarea, lblmeasure)
   Try Settings_Load()
   Reload() 
   
End
Public Sub Reload()
   Timer1.enabled = False
   lcDescriptors.Clear()
   Descriptors = modBillingDBI.Descriptors_Get(Trim(txtFilterDescriptor.text), sbLimit.value)

   For Each Descriptor In Descriptors
        lcRow = New CDescriptorRow(lcDescriptors, descriptor)
   Next    
   Timer1.Enabled = True   
End

Public Sub Save()
   '--------------------------
   'Save a modified descriptor
   '--------------------------

   modDBConnect.BeginTrans()
   modDBConnect.CommitTrans() 
   Reload()
   
End

Public Sub Settings_Save()
   
   Settings["Billing_Descriptors/VSplit_Main.Layout"] = Vsplit_Main.Layout
   
End

Private Sub Settings_Load()
   
   Try Vsplit_Main.Layout = Settings["Billing_Descriptors/VSplit_Main.Layout"]
   
End



Public Sub Timer1_Timer()
   Inc timer_count
   If timer_count = 3 Then
       Reload()
   End If   
End

Public Sub txtFilterDescriptor_KeyRelease()
  If Timer1.Enabled = False Then Timer1.Enabled = True   
   timer_count = 0 

End

Public Sub txtFilterDescriptor_GotFocus()

Timer1.Start()
   

End

Public Sub EditArea_Clear()
   
  modEditAreaHelpers.EditArea_Clear(Vbox_Editarea) 
   
End

Public Sub Display()
   '------------------------------------------
   'Displays the currently selected descriptor
   '------------------------------------------ 
   EditArea_Clear()
   bexit = True
   txtMBSItemNumber.text = descriptor!mbs_item
   txtAMAItemNumber.text = descriptor!ama_item
   txtDescriptor.text = descriptor!descriptor
   Try txtDateceased = Format(descriptor!ceased_date, "dd/mm/yyyy")
   txtGroup.text = descriptor!group
   
   bexit = False  
   
End


Public Sub lcDescriptors_Click()

     '----------------------------------------------------------------------------------
   'User has clicked on one row of the list container - hence selecting a patient
   'put that patient into the current patient collection, and photo into patient_photo
   '----------------------------------------------------------------------------------
   
   Dim hctrl As Control
   Dim HB As HBox
   Dim Tl As TextLabel
   
   If lcDescriptors.Count Then
      descriptor = Descriptors[Last.children[Last.index].tag] 
      Display()
   Endif
   

End

Public Sub Form_Close()

   
   Settings_Save()

End
