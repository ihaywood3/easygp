' Gambas class file

' Copyright (C) 2008-2014 Dr. Richard Terry

' This program is free software: you can redistribute it and/or modify
' it under the terms of the GNU General Public License as published by
' the Free Software Foundation, either version 3 of the License, or
' (at your option) any later version.

' This program is distributed in the hope that it will be useful,
' but WITHOUT ANY WARRANTY; without even the implied warranty of
' MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
' GNU General Public License for more details.

' You should have received a copy of the GNU General Public License
' along with this program.  If not, see <http://www.gnu.org/licenses/>.
'-------------------------------------------------------------------------------------
' PURPOSE        : Allow viewing/re-printing of referrals by clerical staff
'-------------------------------------------------------------------------------------

Private requests As Collection
Private request As Collection
Private CurrentConsult As CConsult
Private PDF_Form As FPdf
Private Form_HTML_Viewer As FHtmlViewer

Public Sub _new()
   
   With PDF_Form = New FPdf(Vbox_PDf)                              'Pdf form to show any scanned doc's
      .BtOpen.Visible = False
      .BtPrint.Visible = True
      .btZoomIn.Visible = True
      .btZoomOut.Visible = True
   End With 
   PDF_Form.BtPrint.Enabled = True
   With cvwRequests
      .Columns.count = 2
      .Columns[0].Text = "Date and Request"   'can be back date
      .Columns[1].Text = "Provider"
   End With
   
   Settings_Load()
   
End

Public Sub Init(cons As CConsult)
   
   CurrentConsult = cons
   Reload
   
End

Public Sub Reload()
   '--------------------------------------------------------------
   'Loop through the collection, the key of the columnview becomes
   'the primary key of clin_referrals.inbox
   '--------------------------------------------------------------
   
   Dim request As Collection
   Dim x As Integer
   Dim sString As String
   
   requests = CurrentConsult!requests_ordered
   modEditAreaHelpers.Patient_Requests_Show(currentconsult, cvwRequests,, True, Lower(Trim(txtExcludeRequest.text)), Lower(Trim(txtFilterRequest.text)))
   
End

Public Sub Settings_Save()
   
   Settings["FClericalRequests/HSplit1.Layout"] = HSplit1.Layout
   
End

Private Sub Settings_Load()
   
   HSplit1.Layout = Settings["FClericalRequests/HSplit1.Layout", modUtil.HSplit([1, 1])]
   cvwRequests.font = Font[Settings["FClericalRequests/cvwRequests.font", "DejaVu Sans,9"]]
   
End

Public Sub cvwRequests_Menu()
   
   If cvwRequests.count Then
      mnuRequests.Popup
   Endif
   
End

Public Sub mnuRequests_Click()
   '-------------------------------------------------------
   'user has clicked on the menu over the certificates list
   'weird key for very old historical reasons
   'if ever I get around to hit I will eliminate this by
   're-writing FRequests and associated codes
   '-------------------------------------------------------   
   
   Dim x As Integer
   
   Select Case Last.tag
      Case "print"
         For x = 0 To cvwRequests.Selection.count - 1
            Print cvwRequests.Selection[x]
            '  modPrinting.Print_latex(certificates[cvwReferrals.Selection[x]]!latex, const.Paper_Plain, 1)
            request = requests[Right(cvwRequests.Selection[x], Len(cvwRequests.Selection[x]) - InStr(cvwRequests.Selection[x], "-"))]
            If Not IsNull(Request!latex) Then
               modPrinting.Print_latex(Request!latex)
            Else
               PDF_Form.Load_PDF(modUtil.Find_File("templates" &/ "request_missing_latex_notice.pdf"), False, False) 'fixme write code to regenerate the latex definition
            Endif
         Next
         cvwRequests.UnselectAll()
      Case "font"
         modUtil.Columnview_SetFont(cvwRequests, "FClericalRequests")
      Case "help"
         modUtil.NotImplemented("Help for Clerical Requests section")
   End Select 
Catch
   Return 

End

Public Sub cvwRequests_Select()
   '--------------------------------------------------------------
   'user has clicked on a request form - show the latex definition
   '--------------------------------------------------------------
   
   cvwRequests.MoveCurrent()
   request = requests[Right(cvwRequests.item.key, Len(cvwRequests.item.key) - InStr(cvwRequests.item.key, "-"))]
   If Not IsNull(Request!latex) Then 
      PDF_Form.Load_PDF(modPrinting.Latex_To_PDF(Request!latex), False, False)
   Else
      PDF_Form.Load_PDF(modUtil.Find_File("templates" &/ "request_missing_latex_notice.pdf"), False, False) 'fixme write code to regenerate the latex definition
   End If 
   
End

Public Sub EditAreaTextBox_KeyRelease()
   
   Reload
   
End
