' Gambas class file

Private FTask As FStaffTasks
Private Const cOustandingTasks As Integer = 0
Private Const cCompletedTasks As Integer = 1
Private Const cAllocatedTasks As Integer = 2
Private AllocatedTasks As Collection
Private allocatedTask As Collection
Private CompletedTasks As Collection
Private CompletedTask As Collection 
Private iTaskFor As Integer                         'points to category of current task
Private cTaskForPatient As Integer = 0
Private cTaskBetweenStaff As Integer = 1
Private ColumnHeadings As String[] = ["Patient", "Staff Member"]

Public Sub Form_Open()

  
   Init()
   
End

Public Sub Settings_Save()
  FTask.Settings_Save()
 End



Public Sub Init()
   'Embed staff tasks, and set splits compatible with this module
  '  Settings_Load()
   Ftask = New FStaffTasks(HBox_StaffTask)
   With FTask
     .Set_Parent_Form("FDayBook")
     .Init()
     .Reload()
   End With
   
   lblHeading.text = "Staff Tasks for " & modDBConnect.currentUser_FullName()
   With cvwCompletedTasks
      .Columns.count = 4
      .Columns[0].Text = "Logged"
      .Columns[1].Text = "For"
     
      .Columns[2].Text = "Task"
      .Columns[3].Text = "Details"
     
   End With
   With cvwTasksAllocated
     .Columns.count = 6
     .Columns[0].text = "Responsible"
     .Columns[1].text = "Patient"
   End With
End





Public Sub TabStrip1_Click()
   '-----------------------------------------------------------------
   'User has clicked on one of two tabs
   ' Tab1: shows all outstanding tasks for the staff member logged on
   ' Tab2: shows all completed tasks for the staff member logged on
   '-----------------------------------------------------------------
   Select Last.Index
    Case cOustandingTasks
    Case cCompletedTasks
         rbPatientTasks.value = True
         Completed_Tasks_Refresh()
    Case cAllocatedTasks
        Tasks_Allocated_For_Others_ReLoad()
   End Select
End

Public Sub Tasks_Allocated_For_Others_ReLoad()
   '---------------------------------------------------------------------
   'Reloads and fills columnview of tasks that current user has allocated
   'to other staff members, so we can keep tabs on whats done/not done
   '---------------------------------------------------------------------

   Dim staffTask As Collection 
   Dim x As Integer
   Dim R As Result
    
 ' ; Task_Keys = New Collection
 '   StaffTasks = New Collection
   ' fk_schema = 0   'fixme
   ' fk_table = 0
   ' fk_table_row = 0
   Inc Application.Busy
 
   cvwTasksAllocated.Clear()
   cvwTasksAllocated.Columns.count = 6
   cvwTasksAllocated.Columns[0].width = 100
  ' currentconsult = Null 2 = either completed or not completed FIXME 
   AllocatedTasks = modDayBookDBI.Staff_Tasks_Get(0, modDBConnect.currentUser!fk_staff, True, 0, 0, 0, False) 'get uncompleted tasks
   If AllocatedTasks.count = 0 Then
      cvwTasksAllocated.Add(x, 0)
      cvwTasksAllocated[x][0] = "None Allocated" 
   Else
      For Each AllocatedTask In AllocatedTasks
         '--------------------------------------
         'Display the patients name (if present)
         '--------------------------------------
         If Not IsNull(AllocatedTask!patient_wholename) Then
            cvwTasksAllocated.Add(x, 0)
            cvwTasksAllocated[x][0] = AllocatedTask!staff_allocated_wholename
            cvwTasksAllocated[x][1] = Trim(AllocatedTask!patient_wholename)   '& "[" & AllocatedTask!patient_birthdate & "]" & " " & AllocatedTask!patient_street & " " & AllocatedTask!patient_town & " " & AllocatedTask!patient_postcode
          '  cvwTasksAllocated[x][1] = Format(AllocatedTask!patient_birthdate, "dd/mm/yyyy")
        '    cvwTasksAllocated[x][1] = AllocatedTask!patient_age
          '  Task_Keys.Add(AllocatedTask!pk_view, x)
           ' Inc x
     
         '------------------------------------------------------------
         'indicate level of urgency and the details (if details exist)
         '------------------------------------------------------------  
        ' cvwTasksAllocated.Add(x, 0)
         cvwTasksAllocated[x][2] = AllocatedTask!task_type
         cvwTasksAllocated[x][3] = AllocatedTask!details
         
         Select Case AllocatedTask!fk_urgency
            Case const.UrgencyLevelRoutine 
               cvwTasksAllocated[x][4] = "Routine"
            Case const.UrgencyLevelModerate
               cvwTasksAllocated[x][4] = "Moderately urgent" 
            Case const.UrgencyLevelUrgent
               cvwTasksAllocated[x][4] = "URGENT"
         End Select
         If IsNull(AllocatedTask!date_finalised) Then
            cvwTasksAllocated[x][5] = "pending"
         Else
            cvwTasksAllocated[x][5] = "Completed by" & AllocatedTask!staff_finalised_task_title & " " & AllocatedTask!staff_finalised_task_wholename
         Endif
         'Task_Keys.Add(AllocatedTask!pk, x)
         Inc x
         End If
         ' stafftask = New Collection
         ' stafftask!fk_task = AllocatedTask!fk_task
         ' StaffTask!fk_staff_filed_task = AllocatedTask!fk_staff_filed_task
         ' StaffTask!fk_schema = AllocatedTask!fk_schema
         ' StaffTask!fk_table = AllocatedTask!fk_table
         ' StaffTask!fk_row = AllocatedTask!fk_row
         ' StaffTask!date_finalised = AllocatedTask!date_finalised
         ' staffTasks.Add(staffTask, AllocatedTask!fk_task)
      Next   
   '    cvwTasksAllocated.MoveFirst
   '    cvwTasksAllocated.Item.Selected = True   
   '    cvwStaffTasks_Select()
    End If   
   Dec Application.Busy

End
Public Sub Completed_Tasks_Refresh()
   '---------------------------------------------------
   'Displays a list of completed tasks for current user
   '---------------------------------------------------
   Dim x As Integer
   Dim task As Collection 
   Dim notes As Collection
   Dim note As Collection
   Dim document As Collection 
   Dim bNotedDocument As Boolean
   
   CompletedTasks = modDayBookDBI.Staff_Tasks_Get(modDBConnect.currentUser!fk_staff, True, 0, 0, 0, True)
   cvwCompletedTasks.Clear()
   If CompletedTasks.count Then
      For Each task In CompletedTasks
        
         cvwCompletedTasks.Add(x, 0)
         cvwCompletedTasks[x][0] = Format(task!date_component_logged, "dd/mm/yyyy")
         If Not IsNull(task!patient_wholename) Then
           cvwCompletedTasks[x][1] = Task!patient_wholename
         Endif
         cvwCompletedTasks[x][2] = Task!task
         cvwCompletedTasks[x][3] = Task!details
         Inc x
         If Not IsNull(task!fk_row) And bNotedDocument = False Then
           'currently only documents are linked, so don't care what the fk is, this may change
           document = modInboxDBI.Document_Get(task!fk_row)
           If Not IsNull(document) Then
               cvwCompletedTasks.Add(x, 0)
               cvwCompletedTasks[x][0] = ""
               cvwCompletedTasks[x][1] = ""
               cvwCompletedTasks[x][2] = "Document source: " & document!msh_sending_entity & " " & document!tag_user
               cvwCompletedTasks[x][3] = ""
               Inc x
               
               bNotedDocument = True   
           Endif
         End If

         '-------------------------------
         'Now get the notes for that task
         '--------------------------------
          notes = modDayBookDBI.Staff_Tasks_Get_Notes(task!fk_task)
          For Each note In notes
               cvwCompletedTasks.Add(x, 0)
                cvwCompletedTasks[x][0] = ""
                cvwCompletedTasks[x][1] = ""
                cvwCompletedTasks[x][2] = note!note
                cvwCompletedTasks[x][3] = "- " & note!staff_made_note_title & " " & note!staff_made_note_wholename '& ")"
                Inc x
          Next
            cvwCompletedTasks.Add(x, 0)
            cvwCompletedTasks[x][0] = ""
            cvwCompletedTasks[x][1] = ""
            Try cvwCompletedTasks[x][2] = "Finalised on " & Format(task!date_finalised, "dd/mm/yyyy") & " by " & task!staff_finalised_task_title & " " & task!staff_finalised_task_wholename
            cvwCompletedTasks[x][3] = ""
            Inc x
      Next
   Endif
End


Public Sub rbTasks_Click()
   '------------------------------------------------------------------------------
   'The tag property of radiobutton = either cTaskBetweenStaff or cTaskForPatient
   '-----------------------------------------------------------------------------
   iTaskFor = Last.tag
   lblFilter.text = "Filter by " & ColumnHeadings[Last.tag] & "    " 'label is auto-resize
   cvwCompletedTasks.Columns[1].text = ColumnHeadings[iTaskFor]  
End

Public Sub txtFilter_GotFocus()

   Last.BackGround = Color.rgb(95, 255, 175)

End
Public Sub txtFilter_LostFocus()

   Last.BackGround = Color.White

End

Public Sub tbRefreshInbox_Click()

  

End
