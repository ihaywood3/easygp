' Gambas class file

Private FTask As FStaffTasks
Private Const cTab_OutstandingTasks As Integer = 0
Private Const cTab_Completed_Tasks As Integer = 1
Private Const CTab_Allocated_Tasks As Integer = 2
Private AllocatedTasks As Collection
Private allocatedTask As Collection
Private CompletedTasks As Collection
Private CompletedTask As Collection 
Private iTaskFor As Integer                         'points to category of current task
Private cTaskForPatient As Integer = 0
Private cTaskBetweenStaff As Integer = 1
Private ColumnHeadings As String[] = ["Patient", "Staff Member"]
Private form_tasks_allocated As FTaskViewer
Private form_tasks_completed As FTaskViewer

Public Sub Form_Open()
   
   Init()
   
End

Public Sub Settings_Save()
   
   FTask.Settings_Save()
   
End

Public Sub Init()
   'Embed staff tasks, and set splits compatible with this module
   '  Settings_Load()
   
   Ftask = New FStaffTasks(HBox_StaffTask)
   With FTask
      .Set_Parent_Form("FDayBook")
      .Init()
      .Reload()
   End With
   
   lblHeading.text = "Staff Tasks for " & modDBConnect.currentUser_FullName()


End
' Public Sub Tasks_Allocated_For_Others_ReLoad()
'    '---------------------------------------------------------------------
'    'Reloads and fills columnview of tasks that current user has allocated
'    'to other staff members, so we can keep tabs on whats done/not done
'    
'    '---------------------------------------------------------------------
'    
'    Dim staffTask As Collection 
'    Dim x As Integer
'    Dim R As Result
'    Dim pic_task_completed As Picture = Picture["icons/12/green_dot.png"]
'    Dim pic_task_incomplete As Picture = Picture["icons/12/red_dot.png"]
'    Dim task_status As Integer = const.cTaskCompletionAny
'    
'    Inc Application.Busy
'    cvwTasksAllocated.Clear()
'    cvwTasksAllocated.Columns.count = 6
'    'cvwTasksAllocated.Columns[0].width = 100
'    ' currentconsult = Null 2 = either completed or not completed FIXME 
'    'ModDayBookDBI.Staff_Tasks_Get
'    '(fk_staff_allocated_task As Integer,
'    ' fk_staff_filed_task As Integer,
'    ' bfk_staff_only As Boolean, 
'    'Optional fk_schema As Integer = 0, 
'    'Optional fk_table As Integer = 0,
'    'Optional fk_row As Integer = 0, 
'    'Optional completed As Integer = 0,
'    'Optional iTaskRestriction As Integer = const.cTaskRestriction_User
'    ') As Collection
'    '------------------------------------------------
'    'Get tasks that this user has allocated to others
'    'fk_staff_allocated_task= 0 means tasks I've allocated to everyone
'    'modDBConnect.currentUser!fk_staff is the users logged on doing this
'    ' bfk_staff_only = True '?needed anymore
'    '0,0,0 = fk_schema, fk_table, fk_row FIXME THIS WILL GO WHEN IAN FINISHES AUDIT.
'    'COMPLETED = 2 means show me tasks either completed or not completed FIXME NOT HARD CODED
'    'DESC show newest to oldest
'    
'    '------------------------------------------------
'    If chkTaskStatus.value = True Then task_status = const.cTaskCompletionNo
'    AllocatedTasks = modDayBookDBI.Staff_Tasks_Get(0, modDBConnect.currentUser!fk_staff, True, 0, 0, 0, task_status, const.cTaskRestriction_User, "DESC") 'get uncompleted tasks
'    
'    If AllocatedTasks.count = 0 Then
'       cvwTasksAllocated.Add(x, 0)
'       cvwTasksAllocated[x][0] = "None Allocated" 
'    Else
'       
'       For Each AllocatedTask In AllocatedTasks
'          '--------------------------------------
'          'Display the patients name (if present)
'          '--------------------------------------
'          If Not IsNull(AllocatedTask!patient_wholename) Then
'             If IsNull(AllocatedTask!date_finalised) Then
'                cvwTasksAllocated.Add(x, "", pic_task_incomplete)
'             Else 
'                cvwTasksAllocated.Add(x, "", pic_task_completed)
'             Endif
'             cvwTasksAllocated[x][1] = Format(allocatedTask!date_component_logged, "dd/mm/yyyy")
'             cvwTasksAllocated[x][2] = AllocatedTask!staff_allocated_wholename
'             cvwTasksAllocated[x][3] = Trim(AllocatedTask!patient_wholename)   '& "[" & AllocatedTask!patient_birthdate & "]" & " " & AllocatedTask!patient_street & " " & AllocatedTask!patient_town & " " & AllocatedTask!patient_postcode
'             cvwTasksAllocated[x][4] = AllocatedTask!task_type
'             cvwTasksAllocated[x][5] = AllocatedTask!details
'             If IsNull(AllocatedTask!date_finalised) Then
'                cvwTasksAllocated[x][6] = "Pending"
'             Else
'                cvwTasksAllocated[x][6] = "Complete: " & AllocatedTask!staff_finalised_task_title & " " & AllocatedTask!staff_finalised_task_wholename
'             Endif
'             ' Task_Keys.Add(AllocatedTask!pk, x)
'             Inc x
'          End If
'       Next   
'    End If   
'    Dec Application.Busy
'    
' End

Public Sub TabStrip1_Click()
   '-----------------------------------------------------------------
   'User has clicked on one of two tabs
   ' Tab1: shows all outstanding tasks for the staff member logged on
   ' Tab2: shows all completed tasks for the staff member logged on
   '-----------------------------------------------------------------
   
   Select Last.Index
      Case cTab_OutstandingTasks
       Case CTab_Allocated_Tasks
          If IsNull(form_tasks_allocated) Then
             With form_tasks_allocated = New FTaskViewer(Vbox_Tasks_Allocated)
                .Init("allocated")
             End With
          Endif
      Case cTab_Completed_Tasks
      If IsNull(form_tasks_completed) Then
         With form_tasks_completed = New FTaskViewer(Vbox_Tasks_Completed) 
            .Init("completed") 
         End With 
      End If 
   End Select
   
End


Public Sub Completed_Tasks_Refresh()
   ' '---------------------------------------------------
   ' 'Displays a list of completed tasks for current user
   ' '---------------------------------------------------
   ' 
   ' Dim x As Integer
   ' Dim task As Collection 
   ' Dim notes As Collection
   ' Dim note As Collection
   ' Dim document As Collection 
   ' Dim bNotedDocument As Boolean
   ' 
   ' CompletedTasks = modDayBookDBI.Staff_Tasks_Get(modDBConnect.currentUser!fk_staff, True, 0, 0, 0, True)
   ' cvwCompletedTasks.Clear()
   ' If CompletedTasks.count Then
   '    For Each task In CompletedTasks
   '       
   '       cvwCompletedTasks.Add(x, 0)
   '       cvwCompletedTasks[x][0] = Format(task!date_component_logged, "dd/mm/yyyy")
   '       If Not IsNull(task!patient_wholename) Then
   '          cvwCompletedTasks[x][1] = Task!patient_wholename
   '       Endif
   '       cvwCompletedTasks[x][2] = Task!task
   '       cvwCompletedTasks[x][3] = Task!details
   '       Inc x
   '       If Not IsNull(task!fk_row) And bNotedDocument = False Then
   '          'currently only documents are linked, so don't care what the fk is, this may change
   '          document = modInboxDBI.Document_Get(task!fk_row)
   '          If Not IsNull(document) Then
   '             cvwCompletedTasks.Add(x, 0)
   '             cvwCompletedTasks[x][0] = ""
   '             cvwCompletedTasks[x][1] = ""
   '             cvwCompletedTasks[x][2] = "Document source: " & document!msh_sending_entity & " " & document!tag_user
   '             cvwCompletedTasks[x][3] = ""
   '             Inc x
   '             
   '             bNotedDocument = True   
   '          Endif
   '       End If
   '       
   '       '-------------------------------
   '       'Now get the notes for that task
   '       '--------------------------------
   '       notes = modDayBookDBI.Staff_Tasks_Get_Notes(task!fk_task)
   '       For Each note In notes
   '          cvwCompletedTasks.Add(x, 0)
   '          cvwCompletedTasks[x][0] = ""
   '          cvwCompletedTasks[x][1] = ""
   '          cvwCompletedTasks[x][2] = note!note
   '          cvwCompletedTasks[x][3] = "- " & note!staff_made_note_title & " " & note!staff_made_note_wholename '& ")"
   '          Inc x
   '       Next
   '       cvwCompletedTasks.Add(x, 0)
   '       cvwCompletedTasks[x][0] = ""
   '       cvwCompletedTasks[x][1] = ""
   '       Try cvwCompletedTasks[x][2] = "Finalised on " & Format(task!date_finalised, "dd/mm/yyyy") & " by " & task!staff_finalised_task_title & " " & task!staff_finalised_task_wholename
   '       cvwCompletedTasks[x][3] = ""
   '       Inc x
   '    Next
   ' Endif
   ' 
End

Public Sub rbTasks_Click()
   '------------------------------------------------------------------------------
   'The tag property of radiobutton = either cTaskBetweenStaff or cTaskForPatient
   '-----------------------------------------------------------------------------
   ' 
   ' iTaskFor = Last.tag
   ' lblFilter.text = "Filter by " & ColumnHeadings[Last.tag] & "    " 'label is auto-resize
   ' cvwCompletedTasks.Columns[1].text = ColumnHeadings[iTaskFor]  
   
End

Public Sub txtFilter_GotFocus()
   
   Last.BackGround = Color.rgb(95, 255, 175)
   
End

Public Sub txtFilter_LostFocus()
   
   Last.BackGround = Color.White
   
End

' Public Sub tbRefreshAllocatedTasks_Click()
'    
' End
' 
' Public Sub chkTaskStatus_Click()
'    
'    Tasks_Allocated_For_Others_ReLoad()
'    
' End
