' Gambas class file

Private FTask As FStaffTasks
Private cOustandingTasks As Integer = 0
Private cCompletedTasks As Integer = 1
Private CompletedTasks As Collection
Private CompletedTask As Collection 
Private iTaskFor As Integer                         'points to category of current task
Private cTaskForPatient As Integer = 0
Private cTaskBetweenStaff As Integer = 1
Private ColumnHeadings As String[] = ["Patient", "Staff Member"]

Public Sub Form_Open()

  
   Init()
   
End

Public Sub Settings_Save()
  FTask.Form_Settings("save")
 End

Public Sub Settings_Load()
End

Public Sub Init()
   'Embed staff tasks, and set splits compatible with this module
  '  Settings_Load()
   Ftask = New FStaffTasks(HBox_StaffTask)
   With FTask
     .Set_Parent_Form("FDayBook")
     .Init()
     .Reload()
   End With
   
   lblHeading.text = "Staff Tasks for " & modDBConnect.currentUser_FullName()
   With cvwCompletedTasks
      .Columns.count = 4
      .Columns[0].Text = "Logged"
      .Columns[1].Text = "For"
     
      .Columns[2].Text = "Task"
      .Columns[3].Text = "Details"
     
   End With
End





Public Sub TabStrip1_Click()
   '-----------------------------------------------------------------
   'User has clicked on one of two tabs
   ' Tab1: shows all outstanding tasks for the staff member logged on
   ' Tab2: shows all completed tasks for the staff member logged on
   '-----------------------------------------------------------------
   Select Last.Index
    Case cOustandingTasks
    Case cCompletedTasks
         rbPatientTasks.value = True
         Completed_Tasks_Refresh()
   End Select
End

Public Sub Completed_Tasks_Refresh()
   '---------------------------------------------------
   'Displays a list of completed tasks for current user
   '---------------------------------------------------
   Dim x As Integer
   Dim task As Collection 
   Dim notes As Collection
   Dim note As Collection
   Dim document As Collection 
   Dim bNotedDocument As Boolean
   
   CompletedTasks = modDayBookDBI.Staff_Tasks_Get(modDBConnect.currentUser!fk_staff, True, 0, 0, 0, True)
   cvwCompletedTasks.Clear()
   If CompletedTasks.count Then
      For Each task In CompletedTasks
        
         cvwCompletedTasks.Add(x, 0)
         cvwCompletedTasks[x][0] = Format(task!date_component_logged, "dd/mm/yyyy")
         If Not IsNull(task!patient_wholename) Then
           cvwCompletedTasks[x][1] = Task!patient_wholename
         Endif
         cvwCompletedTasks[x][2] = Task!task
         cvwCompletedTasks[x][3] = Task!details
         Inc x
         If Not IsNull(task!fk_row) And bNotedDocument = False Then
           'currently only documents are linked, so don't care what the fk is, this may change
           document = modInboxDBI.Document_Get(task!fk_row)
           If Not IsNull(document) Then
               cvwCompletedTasks.Add(x, 0)
               cvwCompletedTasks[x][0] = ""
               cvwCompletedTasks[x][1] = ""
               cvwCompletedTasks[x][2] = "Document source: " & document!msh_sending_entity & " " & document!tag_user
               cvwCompletedTasks[x][3] = ""
               Inc x
               
               bNotedDocument = True   
           Endif
         End If

         '-------------------------------
         'Now get the notes for that task
         '--------------------------------
          notes = modDayBookDBI.Staff_Tasks_Get_Notes(task!fk_task)
          For Each note In notes
               cvwCompletedTasks.Add(x, 0)
                cvwCompletedTasks[x][0] = ""
                cvwCompletedTasks[x][1] = ""
                cvwCompletedTasks[x][2] = note!note
                cvwCompletedTasks[x][3] = "- " & note!staff_made_note_title & " " & note!staff_made_note_wholename '& ")"
                Inc x
          Next
            cvwCompletedTasks.Add(x, 0)
            cvwCompletedTasks[x][0] = ""
            cvwCompletedTasks[x][1] = ""
            Try cvwCompletedTasks[x][2] = "Finalised on " & Format(task!date_finalised, "dd/mm/yyyy") & " by " & task!staff_finalised_task_title & " " & task!staff_finalised_task_wholename
            cvwCompletedTasks[x][3] = ""
            Inc x
      Next
   Endif
End


Public Sub rbTasks_Click()
   '------------------------------------------------------------------------------
   'The tag property of radiobutton = either cTaskBetweenStaff or cTaskForPatient
   '-----------------------------------------------------------------------------
   iTaskFor = Last.tag
   lblFilter.text = "Filter by " & ColumnHeadings[Last.tag] & "    " 'label is auto-resize
   cvwCompletedTasks.Columns[1].text = ColumnHeadings[iTaskFor]  
End

Public Sub txtFilter_GotFocus()

   Last.BackGround = Color.rgb(95, 255, 175)

End
Public Sub txtFilter_LostFocus()

   Last.BackGround = Color.White

End

Public Sub tbRefreshInbox_Click()

  

End
