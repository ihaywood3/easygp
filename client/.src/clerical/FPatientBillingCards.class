' Gambas class file

' Copyright (C) 2008-2012 Dr. Richard Terry

' This program is free software: you can redistribute it and/or modify
' it under the terms of the GNU General Public License as published by
' the Free Software Foundation, either version 3 of the License, or
' (at your option) any later version.

' This program is distributed in the hope that it will be useful,
' but WITHOUT ANY WARRANTY; without even the implied warranty of
' MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
' GNU General Public License for more details.

' You should have received a copy of the GNU General Public License
' along with this program.  If not, see <http://www.gnu.org/licenses/>.
' ------------------------------------------------------------------------
' PURPOSE         A module to save patient specific information to do with 
'                 billing and general practice
'-------------------------------------------------------------------------
Private doctors As Collection
Private fk_person As Collection
Private patient As Collection 
Private vetern_card_types As Collection
Private centrelink_card_types As Collection
Private health_insurance_companies As Collection
Private billing_types As Collection
Private bExit As Boolean
Private bkeyvalid As Boolean


Public Function Active_Status_Get() As String
   
   If rbActiveYes.value = True Then Return ""
   Return "i"
   
End

Public Function medicare_card_number_get() As String
   
   Return Trim(txtMedicareNumber.text) 
   
End

Public Function Medicare_Card_Position_Get() As Integer

   Return Val(txtMedicareCardPostitionNumber.text)

End 

Public Function medicare_card_expiry_date_get() As String
   
   Return (Trim(txtMedicareCardExpiryDate.text))
   
End

Public Function veteran_card_number_get() As String
   
   Return Trim(txtVeteranNumber.text) 
   
End

Public Function Veteran_card_type_get() As String
      '---------------------------
      'bugga this is legacy stuff
      'g= gold, l=lilac, s= specific
      'FIXME IN THE BACKEND.
      '-----------------------------
      Select Case vetern_card_types[cmbVeteranCardTypes.index]
         Case 1
            Return "g"
         Case 2
            Return "l"
         Case 3
            Return "s"
      End Select
   
End

Public Function veteran_specific_condition_get() As String
   
  Return Trim(txtVeteranSpecificCondition.Text)
   
End


Public Sub Init()
   
   modEditAreaHelpers.EditArea_Clear(Vbox_EditArea)
   lblMeasure.text = "  Concession Card Name  "
   modEditAreaHelpers.Resize_labels(Vbox_EditArea, lblMeasure)
   doctors = modUtil.Copy_Collection_Keyed_Sequentially(modContactsDBI.Staff_Get_Per_Role(const.StaffRole_Doctor))
   modUtil.LoadCombo(cmbPreferredDoctor, doctors, "wholename")
   vetern_card_types = modBilling.Veteran_Card_Types_Get()
   modUtil.LoadCombo(cmbVeteranCardTypes, vetern_card_types, "type")
   centrelink_card_types = modBilling.Centrelink_Card_Types_Get()
   modUtil.LoadCombo(cmbCentreLinkCardTypes, centrelink_card_types, "type")
   health_insurance_companies = modBilling.Health_Funds_Get()
   modUtil.LoadCombo(cmbPrivateInsuranceCompany, health_insurance_companies, "fund")
   billing_types = modBilling.Billing_Types_Get()
   modUtil.LoadCombo(cmbBillingTypes, billing_types, "name") 'ian's table hence the different field name
   lblMeasure.text = "  Commonwealth Seniors Health Card  "
   cmbPreferredDoctor.width = lblMeasure.Width
   cmbVeteranCardTypes.width = lblMeasure.Width
   cmbCentreLinkCardTypes.width = lblMeasure.Width
   cmbBillingTypes.width = lblMeasure.Width
   cmbPrivateInsuranceCompany.width = lblMeasure.Width
   HBox_Medicare.width = lblMeasure.Width
   HBox_Concession.width = lblMeasure.Width  
   
End

Public Sub Display_Patient_Data(P As Collection)
   
   patient = P
   Try txtMedicareNumber.text = P!medicare_number
   Try txtMedicareCardPostitionNumber.text = P!medicare_ref_number
   Try txtMedicareCardExpiryDate.text = Format(P!medicare_expiry_date, "dd/mm/yyyy")
   Try txtVeteranNumber.text = P!veteran_number
   Try txtVeteranSpecificCondition.text = P!veteran_specific_condition
   Try txtlegacyFileNumber.text = P!pk_legacy
   
End

Public Function EditArea_ExcludeKeys(keycode As Integer, tag As String) As Boolean
   '----------------------------------------------------------
   'PURPOSE       Restrict key presses for validation purposes
   'HOW IT WORKS  see routines names
   'FIXME         Ian would do this much simpler I'm sure
   '-----------------------------------------------------------
   
   Select Case Last.Tag
      Case "medicare number", "medicare card position number"
         bKeyValid = modUtil.AllowKeys(const.AllowKeys_NumbersOnly, keycode)
      Case "veteran number", "Concession number"
         bKeyValid = modUtil.AllowKeys(const.AllowKeys_Letters_Numbers, keycode)
      Case "age onset"
         bKeyValid = modUtil.AllowKeys(const.AllowKeys_NumbersOnly, keycode)
      Case "medicare card expiry date", "concession expiry date"
         bKeyValid = modUtil.AllowKeys(const.AllowKeys_DateFormat, keycode)
      Case Else
         bkeyvalid = True
   End Select
   Return bKeyValid
   
End

Public Sub EdidtArea_Activate()
   
   Select Case Last.tag
         
      Case "medicare number"
      Case "medicare card position number"
      Case "medicare card expiry date"
      Case "veteran number"
      Case "veteran condition"
      Case "Concession number"
      Case "concession expiry date"
      Case "responsible payer"
      Case "legacy file number"
      Case "find next of kin"
      Case "next of kin"
         
   End Select
   
End

Public Sub EdidtArea_Keypress()
   
   bkeyvalid = EditArea_ExcludeKeys(key.code, Last.tag)
   If bkeyvalid = False Then
      Stop Event
      Return
   End If
   Select Case Key.Code
      Case Key.Down
         If columnview1.Visible Then
            With columnview1
               .SetFocus()
               .Item.Selected = True   
            End With
         Endif
   End Select
   
End

Public Sub EditArea_Combo_Click()
   
   Select Case Last.tag
      Case "veteran card type"
      Case "centrelink card type"
      Case "private insurance company"
      Case "preferred doctor"
      Case "billing concession"
         
   End Select
   
End

Public Sub Next_Of_Kin_Get()
   
End

Public Sub Next_Of_Kin_Select()
   
End

' pk serial Not Null,
'   fk_person integer Not Null,
'   fk_doctor integer,
'   fk_next_of_kin integer,
'   fk_payer integer,
'   fk_family integer,
'   active_status character(1) Default 'a'::bpchar, -- a=active i=inactive v=????-fixme
'   medicare_number character varying(10),
'   medicare_ref_number text,
'   medicare_expiry_date Date,
'   veteran_number character varying(10),
'   veteran_card_type character(1), - - Veteran cards can be: ...
'   veteran_specific_condition text,
'   concession_card_name text, - - Non Veterans concession cards can be: ...
'   concession_type character(1),
'   concession_number text,
'   concession_expiry_date Date,
'   file_paper_number text,
'   file_racgp_format boolean,
'   file_chart_status character(1), - - a = Archived c = current
'   private_billing_concession integer,
'   private_insurance text,
'   memo text,
'   pk_legacy text, - - the key From the legacy database For the patient
' atsi integer, 

Public Sub EditAreaTextBox_GotFocus()
   
   Last.BackGround = Color.rgb(95, 255, 175)
   
End

Public Sub EditAreaTextBox_LostFocus()
   
   Last.BackGround = Color.white
   
End 