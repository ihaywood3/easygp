' Gambas class file

' Copyright (C) 2008-2011 Dr. Richard Terry

' This program is free software: you can redistribute it and/or modify
' it under the terms of the GNU General Public License as published by
' the Free Software Foundation, either version 3 of the License, or
' (at your option) any later version.

' This program is distributed in the hope that it will be useful,
' but WITHOUT ANY WARRANTY; without even the implied warranty of
' MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
' GNU General Public License for more details.

' You should have received a copy of the GNU General Public License
' along with this program.  If not, see <http://www.gnu.org/licenses/>.
'
' A Form Template for most other new forms
' Copy this form and paste as a new form
'----------------------------------------------------------------------

Private $iLast As Integer
Private $sLast As String
Private $sOption As String
Private $hEditor As Object

Private bexit As Boolean
Private obs As Observer
Private OnRow As Integer
Private GridData As Collection 
Private GridRows As Collection
Private iLeft As Integer
Private iTop As Integer
Private i As Integer
Public iFirstRow As Integer
Private iLastRow As Integer
Private bFoundFirst As Integer
Private PregnancyIcon As Picture = Picture["icons/20/pregnancy.png"]
Private BloodTestIcon As Picture = Picture["icons/16/bloodtube16x16.png"]
Private ProcedureIcon As Picture = Picture["icons/24/glove-scalple_2424.png"]
Private MentalHealthPlan As Picture = Picture["icons/22/face-smile.png"]
Private ScriptIcon As Picture = Picture["icons/20/pill2020.png"]
Private ImmunizationIcon As Picture = Picture["icons/20/syringe2020.png"]
Private WorkcoverIcon As Picture = Picture["icons/20/workcover2020.png"]  
Private CheckupIcon As Picture = Picture["icons/22/heart.png"]
Private irowheight As Integer = 18 'fix me
Private staff_photo As Picture
Private staff_member As Collection
Private form_select As FPatientsSelect
Public patient As Collection 

' Static Public form_appointmentlist As FAppointmentList        ' so that patient multi-select can acess this form
' 
' Static Public Sub patient_load_record_external(patient As Collection, bPhotoConfirmed As Boolean, P As Picture) 
'    '------------------------------------------------------------------------------
'    'User has searched for a patient > multiple choice > chosen, so load the record
'    '------------------------------------------------------------------------------   
'    
'    form_appointmentlist.patient_load_record(patient, bPhotoConfirmed, P)
' 
' 
' End

Public Sub Init(sm As Collection, sDate As String)
   '------------------------------------------------
   'initialise the appointment module from fclerical 
   '------------------------------------------------
   
   Dim appointment_interval As Integer                                                 'interval in minutes for appointments
   
   Dim x As Integer
   Dim ihour As Integer
   Dim iminute As Integer
   Dim istarthour As Integer = 8                                                       'fixme make me configurable
   Dim istartminute As Integer = 30
   
   ' form_appointmentlist = Me
   staff_member = sm
   txtAppointment.height = irowheight                                                        'grid rows = same height as our textbox
   Me.title = UCase(staff_member!title & " " & staff_member!wholename)                        'heading e.g "appointments for 01/01/2011"
   lblDate.text = Format(Val(sDate), gb.LongDate)
   appointment_interval = 10                                                           'fixme make me configurable
   
   With gridview1                                                                         
      .columns.count = 3
      .columns[0].width = 100
      .columns[1].width = 24
      .columns[2].width = gridview1.width - 124
      .rows.count = 50
   End With
   ihour = istarthour
   iminute = istartminute
   gridrows = New Collection
   
   For x = 0 To 49
      griddata = New Collection
      griddata!time = Format(Time(ihour, iminute, 0), "hh:nn")
      griddata!slots = 1
      gridrows.add(griddata, Str(x))
      gridview1[x, 0].text = Format(Time(ihour, iminute, 0), "hh:nn") 
      gridview1.rows[x].height = griddata!slots * irowheight
      iminute += 10
      Print iminute
      
      If iminute = 60 Then
         Inc ihour
         iminute = 0
         
      Endif
   Next
   
End

Public Sub GridData_Rebuild()
   
   Dim NewRows As New Collection
   Dim iNewRowCount As Integer
   
   Dim i As Integer 
   
   'Gridview1[iFirstRow, 2].text = TextBox1.Text
   For i = 0 To Gridview1.Rows.Count - 1
      If i < iFirstRow Then 
         NewRows.Add(GridRows[i], iNewRowCount)
         
      Else If i = iFirstRow And i < iLastRow + 1 Then
         
         GridData = New Collection
         If iFirstRow = iLastRow Then
            GridData!time = GridRows[i]!time
            GridData!picture = GridRows[i]!picture
            GridData!slots = 1
         Else
            GridData!time = GridRows[i]!time & "-" & GridRows[iLastRow + 1]!time
            GridData!picture = GridRows[i]!picture
            GridData!slots = iLastRow + 1 - iFirstRow
            i = i + iLastRow + 1 - iFirstRow
         End If 
         GridData!name = Trim(txtAppointment.text)
         NewRows.Add(GridData, iNewRowCount)
         
      Else
         GridData = New Collection
         GridData!time = GridRows[i]!time
         GridData!slots = GridRows[i]!slots
         NewRows.Add(GridData, iNewRowCount)
      End If   
      Inc iNewRowCount
   Next
   Print NewRows
   
   GridRows = modUtil.Copy_Collection(NewRows)
   
End

Public Sub Gridview1_Rebuild(data As Collection)
   
   Dim i As Integer
   
   Dim pic As Picture = Picture["icons/20/green_dot.png"]
   
   Gridview1.Clear()
   Gridview1.Rows.count = data.count
   For i = 0 To data.count - 1
      Gridview1[i, 0].text = data[i]!time
      Gridview1[i, 1].picture = data[i]!picture
      Gridview1[i, 2].text = data[i]!name
      Gridview1.Rows[i].height = data[i]!slots * irowheight
   Next
   
End

Public Sub form_Close()
   
   Settings_Save()
   
End

Public Sub mnuAppointments_Click()
   
   Print Last.Picture
   Gridview1[Gridview1.Row, 1].Picture = Last.Picture
   GridRows[Gridview1.Row]!picture = Last.Picture
   Return 
   Select Case Last.tag
      Case "ante-natal"
         Gridview1[Gridview1.Row, 1].Picture = PregnancyIcon
         GridRows[Gridview1.Row]!picture = PregnancyIcon
      Case "blood test"
         Gridview1[Gridview1.Row, 1].Picture = BloodTestIcon
         GridRows[Gridview1.Row]!picture = BloodTestIcon
   End Select 
   
End

Private Sub Settings_Save()
   
End

Private Sub Settings_Load()
   
End

Public Sub Gridview1_Keypress()
   ' 

    
   If bExit Then Return 
   'bexit = True
   '  Print Key.code 
   
   Try txtAppointment.text = Chr(Key.code)
   GridView1_DblClick()
   
End



Public Sub Gridview1_DblClick()
   '----------------------------------------------
   'User has double clicked on an appointment slot
   '----------------------------------------------
   
   Dim i As Integer
   Dim iSlotCount As Integer
   Dim x As Integer
 
   txtAppointment.text = ""                              'clear search textbox FIXME, SHOULD PUT BACK NAME IF ALREADY EXISTS
   bFoundFirst = False  
   For i = 0 To Gridview1.rows.count - 1           'figure out which rows are selected
      x = x + Gridview1.Rows[i].Height
      If Gridview1.Rows[i].Selected = True Then
         If bFoundFirst = False Then
            bFoundFirst = True
            iFirstRow = i
            itop = x - Gridview1.Rows[i].height
         End If 
         iLastRow = i
      End If 
      If bFoundFirst = False Then 
         iSlotCount += GridRows[i]!slots
      Endif
   Next 
   onrow = iFirstRow  ', Gridview1.Row
   Show_EditingTextBox()
   txtAppointment.Height = ((iLastRow - iFirstRow) + 1) * Gridview1.Rows[0].Height + 5
   
End

Public Sub Gridview1_Select()
   
   '  With TextBox1
   '      .Visible = False   
   '      .text = ""
   '  End With
  ' GridView1[0, 2].Control = txtAppointment
   
End

' Public Sub gridview1_Keypress()
'    
'    If bExit Then Return 
'    bexit = True
'    Gridview1_DblClick()
'    TextBox1.text = Asc(Gridview1.Key.code)
'    bexit = False 
'    
' End

Public Sub txtAppointment_Activate()
   '--------------------------------------------
   'First, rebuild the array of apointment times
   '--------------------------------------------
   
   ' bExit = False
   ' Patients_Find()
   ' textbox1.Visible = False   
   
End

Public Sub Gridview1_Menu()
   
   If Gridview1[Gridview1.Row, 2].text = "" Then Return 
   mnuAppointments.Popup()
   
End

Public Sub Patients_Find(Optional fk_patient As Integer) 
   '-----------------------------------------------------------------------------
   'Attemps to find patients according to criteria entered in cmbSearch
   'of by patient key if picked from list of patients seen that day
   'If none found , resets focus to cmbsearch
   'Otherwise creates an empty patient object
   'If only one name and address auto-load that patient to currentconsult
   'If multiple names/addresses, popup a modal for choice
   'which returns a patient object which becomes currentconsult
   'fixme - implement the patient stack
   '-----------------------------------------------------------------------------
   
   Dim AllPatients As New Collection
   Dim patient As Collection
   Dim sql_in_english As String
   Dim P As Picture
   Dim bPhotoConfirmed As Boolean = False 
   
   If BExit Then Return 
   bExit = True   
   
   Inc Application.Busy
   
   If fk_patient Then
      AllPatients = modContactsDBI.Patient_Get_Using_PK(fk_patient)
   Else
      AllPatients = modContactsDBI.patients_get_firstname_surname(Lower(txtAppointment.text), False) 'get only living patients
      
      sql_in_english = AllPatients!sql_in_english
      AllPatients.Remove("sql_in_english")
   End If   
   If AllPatients.count = 0 Then 
      txtAppointment.SetFocus()
      Dec application.Busy
      bExit = False  
      Return
   Else  
      '----------------------------------------------------
      'One or more patients.
      'If one, get their photo if it exists and load record
      '----------------------------------------------------
      If AllPatients.count = 1 Then  
         '----------------------------------------------------
         'no way in gambas to get a key without an iteraction
         'get first key
         '----------------------------------------------------
         For Each patient In AllPatients
            If Not IsNull(patient!image.data) Then 
               P = modGraphics.Blob_Convert_To_Picture(patient!image)!picture 
            Else
               P = Picture.Load("icons/misc/no_photo.png")
            End If   
         Next
         FConfirmPatient.Init(P, patient!wholename)
         If Not FConfirmPatient.ShowModal() Then 
            bExit = False  
            Return            
         End If
         patient_load_record(patient, bPhotoConfirmed, P)
      Else  
         '---------------------
         'more than one patient
         '---------------------
         Print "first", iFirstRow
         Dec Application.Busy
         ' Vbox1.Visible = False  
         Me.Parent.Parent.Parent.Visible = False  '(vbox1 on FClerical)
         form_select = New FPatientsSelect(Me.Parent.Parent.Parent.Parent)
         obs = New Observer(form_select.btnCancel) As "SelectPatient"     
         form_select.Init(AllPatients, sql_in_english, "FAppointmentList")
         form_select.Visible = True 
         Print "second", iFirstRow
      Endif
   End If   
   bExit = False  
   Dec application.Busy
   ' 
   
End

Public Sub patient_load_record(patient As Collection, bPhotoConfirmed As Boolean, Optional P As Picture) 
   '-------------------------------------------
   'Loads the patients name for the appointment
   '-------------------------------------------
   Me.Parent.Parent.Parent.Visible = True       're-show the appointment grids
   txtAppointment.text = patient!wholename & " [" & Format(patient!birthdate, "dd/mm/yyyy") & "] " & Trim(patient!street1 & " " & patient!street2) & " " & patient!town
   Save(patient)
   GridData_Rebuild()
   Gridview1_Rebuild(GridRows)
   gridview1.SetFocus()
   
End

Public Sub Save(patient As Collection)
   
   
   
End

Public Sub SelectPatient_click()                                       
   '-------------------------------------------------------------------
   'User has cancelled patient selection in popup patient selector form
   '-------------------------------------------------------------------
   
   If Last.tag = "cancel" Then Stop Event
   form_select.Visible = False 
   Vbox1.Visible = True   
   Gridview1_Rebuild
   
End

Public Sub Form_Resize()
   
   gridview1.Columns[2].width = gridview1.width - gridview1.Columns[1].W - gridview1.Columns[0].Width - 25
   
End

Public Sub Form_Leave()
   
   txtAppointment.Visible = False   
   
End

Public Sub TextBox2_Change()
   
   If Len(Last.text) Then
      patient_load_record(patient, True) 
   Endif
   
End

Public Sub Show_EditingTextBox()
   'Displays the editing textbox
   'Copied some of this code from the gambas IDE so can't remmber reason for use of the hEditor   
   Dim sAppointment As String  'the contents of the grid column with patients 
   Dim hEditor As Object 
   
   hEditor = txtAppointment
   txtAppointment.ReadOnly = False
   $hEditor = hEditor
   Move_EditingTextBox
   $hEditor.Show
   txtAppointment.Visible = True 
   $hEditor.SetFocus
   $hEditor = txtAppointment 
   txtAppointment.SelectAll
   
End

Public Sub Move_EditingTextBox()
   
   Dim iW As Integer
   
   If IsNull($hEditor) Then Return
   
   With gridview1[gridview1.Row, 2]
      
     ' panEditor.Move(gridview1.X + .X - gridview1.ScrollX, gridview1.Y + .Y - gridview1.ScrollY, .Width, .Height)
     ' panEditor.Raise
      txtAppointment.Move(gridview1.X + .X - gridview1.ScrollX, gridview1.Y + itop - gridview1.ScrollY, .Width, ((iLastRow - iFirstRow) + 1) * Gridview1.Rows[0].Height + 5)
     ' txtAppointment.Raise 
   End With
   
End

Public Sub Gridview1_Scroll()
   
   Move_EditingTextBox
   
End

Public Sub Gridview1_MouseUp()
   
  ' Show_EditingTextBox
   
End

Public Sub Button1_Click()

   Print "irowheight", irowheight
   Print txtAppointment.Height, "= txtappointment.height"

End

