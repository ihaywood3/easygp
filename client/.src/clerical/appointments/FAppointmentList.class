' Gambas class file

' Copyright (C) 2008-2011 Dr. Richard Terry

' This program is free software: you can redistribute it and/or modify
' it under the terms of the GNU General Public License as published by
' the Free Software Foundation, either version 3 of the License, or
' (at your option) any later version.

' This program is distributed in the hope that it will be useful,
' but WITHOUT ANY WARRANTY; without even the implied warranty of
' MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
' GNU General Public License for more details.

' You should have received a copy of the GNU General Public License
' along with this program.  If not, see <http://www.gnu.org/licenses/>.
'
' A Form Template for most other new forms
' Copy this form and paste as a new form
'----------------------------------------------------------------------

Private bexit As Boolean
Private OnRow As Integer
Private GridData As Collection 
Private GridRows As Collection
Private iLeft As Integer
Private iTop As Integer
Private i As Integer
Private iFirstRow As Integer
Private iLastRow As Integer
Private bFoundFirst As Integer
Private PregnancyIcon As Picture = Picture["icons/20/pregnancy.png"]
Private BloodTestIcon As Picture = Picture["icons/16/bloodtube16x16.png"]
Private irowheight As Integer = 18
Private staff_photo As Picture
Private staff_member As Collection

Public Sub Init(sm As Collection, sDate As String)
   '------------------------------------------------
   'initialise the appointment module from fclerical 
   '------------------------------------------------
   Dim appointment_interval As Integer                                                 'interval in minutes for appointments
   
   Dim x As Integer
   Dim ihour As Integer
   Dim iminute As Integer
   Dim istarthour As Integer = 8                                                       'fixme make me configurable
   Dim istartminute As Integer = 30
  
  DateBox1.value = sDate 
   staff_member = sm
 ' lblAppointmentsFor.text = "Appointments for " & UCase(staff_member!title & " " & staff_member!wholename) & "  "
   textbox1.height = irowheight                                                        'grid rows = same height as our textbox
   Me.title = UCase(staff_member!title & " " & staff_member!wholename)                        'heading e.g "appointments for 01/01/2011"
   lblStaffrole.text = staff_member!role
   lblDate.text = Format(Val(sDate), gb.LongDate)
   ' If Not IsNull(staff_member!image.data) Then 
   '    staff_photo = modGraphics.Blob_Convert_To_Picture(staff_member!image)!picture  
   ' Else
   '    staff_photo = Picture.Load("icons/misc/no_photo.png") 
   ' Endif
   ' picStaff.Picture = staff_photo
   appointment_interval = 10                                                           'fixme make me configurable
   
   
   With gridview1                                                                         
      .columns.count = 3
      .columns[0].width = 100
      .columns[1].width = 50
      .columns[2].width = gridview1.width - 100
      .rows.count = 50
    
   End With
   ihour = istarthour
   iminute = istartminute
   gridview1.rows.h = 20
   gridrows = New Collection
   
   For x = 0 To 49
      griddata = New Collection
      griddata!time = Format(Time(ihour, iminute, 0), "hh:nn")
      griddata!slots = 1
      gridrows.add(griddata, Str(x))
      gridview1[x, 0].text = Format(Time(ihour, iminute, 0), "hh:nn") 
      gridview1.rows[x].height = griddata!slots * irowheight
      iminute += 10
      Print iminute
      
      If iminute = 60 Then
         Inc ihour
         iminute = 0
         
      Endif
   Next
End

  
Public Sub Init_new()
   ' 
   ' With columnview1
   '   .Columns.Count = 2
   '   .Columns[0].width = 100
   '   .add(0, 0)
   '   ColumnView1[0][0] = "01/10/20011" 
   ' End With

   Dim Appointment_interval As Integer
   
   Dim x As Integer
   Dim iHour As Integer
   Dim iMinute As Integer
   Dim iStartHour As Integer = 8
   Dim iStartMinute As Integer = 30

   TextBox1.height = 25
    Me.title = "Appointments for " & Format(Now, "dd/mm/yyyy") 
   Print Format(Time(8, 30, 0), "hh:nn")
   
   Appointment_interval = 10
   
   With Gridview1
      .Columns.count = 3
      .Columns[1].Width = 20
      .Rows.count = 50

   End With
   iHour = istarthour
   iminute = iStartMinute
   Gridview1.Rows.H = 20
   GridRows = New Collection
   
   For x = 0 To 49
      GridData = New Collection
      ' GridData.Add(Format(Time(iHour, iminute, 0), "hh:nn"), Str(x))
      GridData!time = Format(Time(iHour, iminute, 0), "hh:nn")
      GridData!slots = 1
      GridRows.Add(GridData, Str(x))
      Gridview1[x, 0].text = Format(Time(iHour, iminute, 0), "hh:nn") 
      Gridview1.Rows[x].height = GridData!slots * 20
      '   Print Format(Time(iHour, iminute, 0), "hh:nn")
      iminute += 10
      Print iminute
      
      If iminute = 60 Then
         Inc iHour
         iMinute = 0
         
      Endif
   Next
   
   ' gridview1.row = 0
   ' gridview1.
   Print GridRows
  Me.Center
End

Public Sub Gridview1_Rebuild(data As Collection)
   
  Dim i As Integer
  
  Dim pic As Picture = Picture["icons/20/green_dot.png"]
  Gridview1.Clear()
  Gridview1.Rows.count = data.count
  For i = 0 To data.count - 1
      Gridview1[i, 0].text = data[i]!time
      Gridview1[i, 1].picture = data[i]!picture
      Gridview1[i, 2].text = data[i]!name
      Gridview1.Rows[i].height = data[i]!slots * 20
      
    '  gridview1[i, 1].Picture = pic
  Next
   
End

Public Sub form_Close()
   
   Settings_Save()
   
End

Public Sub mnuAppointments_Click()
   
  Select Case Last.tag
  Case "ante-natal"
     Gridview1[Gridview1.Row, 1].Picture = PregnancyIcon
     GridRows[Gridview1.Row]!picture = PregnancyIcon
  Case "blood test"
     Gridview1[Gridview1.Row, 1].Picture = BloodTestIcon
     GridRows[Gridview1.Row]!picture = BloodTestIcon
  End Select 
   
End

Private Sub Settings_Save()
   
End

Private Sub Settings_Load()
   
End

Public Sub Gridview1_Keypress()
   
   If Key.code = Key.return Then
      Gridview1_DblClick()
   End If 
   
End

Public Sub Gridview1_Click()
   
   Print "on row" & Gridview1.Row
   Print "From the collection:", GridRows[Gridview1.row]!time

End

Public Sub Gridview1_DblClick()
   Dim i As Integer
   Dim iSlotCount As Integer
   
   TextBox1.text = ""                              'clear search textbox
   bFoundFirst = False  
   For i = 0 To Gridview1.rows.count - 1           'figure out which rows are selected
       
      If Gridview1.Rows[i].Selected = True Then
         If bFoundFirst = False Then
            bFoundFirst = True
            iFirstRow = i
         End If 
         iLastRow = i
         Print "Row " & i & " is selected"
      End If 
      If bFoundFirst = False Then 
         iSlotCount += GridRows[i]!slots
      Endif
   Next 
   Print "The first was ", iFirstRow
   Print "The last was ", iLastRow
   
   Print Gridview1.Rows.Select
   Print Gridview1.Rows.height 
   onrow = Gridview1.Row
   iLeft = Gridview1[0, 2].Left
  ' iTop = onrow * gridview1.Rows.height 
   iTop = iSlotCount * 20
 ' iTop = iFirstRow * gridview1.Rows.height 
   TextBox1.left = iLeft
   TextBox1.top = iTop
  ' TextBox1.top = gridview1.ScreenX
   TextBox1.Height = ((iLastRow - iFirstRow) + 1) * Gridview1.Rows[0].Height + 5
   TextBox1.Visible = True
   TextBox1.SetFocus()
   
End

Public Sub Gridview1_Select()
   
   TextBox1.Visible = False   
   
End
Public Sub gridview_Keypress()
    If bExit Then Return 
    bexit = True
    Gridview1_DblClick()
    TextBox1.text = Asc(Gridview1.Key.code)
End

Public Sub Textbox1_Activate()
   '--------------------------------------------
   'First, rebuild the array of apointment times
   '--------------------------------------------
   Dim NewRows As New Collection
   Dim iNewRowCount As Integer
   
   Dim i As Integer 
   
   Print iFirstRow, iLastRow
   For i = 0 To Gridview1.Rows.Count - 1
      If i < iFirstRow Then 
            NewRows.Add(GridRows[i], iNewRowCount)
            
      Else If i = iFirstRow And i < iLastRow + 1 Then
           
           GridData = New Collection
           If iFirstRow = iLastRow Then
               GridData!time = GridRows[i]!time
               GridData!picture = GridRows[i]!picture
               GridData!slots = 1
           Else
               GridData!time = GridRows[i]!time & "-" & GridRows[iLastRow + 1]!time
               GridData!picture = GridRows[i]!picture
               GridData!slots = iLastRow + 1 - iFirstRow
               i = i + iLastRow + 1 - iFirstRow
           End If 
           GridData!name = Trim(TextBox1.text)
           NewRows.Add(GridData, iNewRowCount)
           
      Else
          GridData = New Collection
          GridData!time = GridRows[i]!time
          GridData!slots = GridRows[i]!slots
          NewRows.Add(GridData, iNewRowCount)
      End If   
      Inc iNewRowCount
   Next
   Print NewRows
  Gridview1[onrow, 2].text = TextBox1.Text
    TextBox1.Visible = False   
   GridRows = modUtil.Copy_Collection(NewRows)
    Gridview1_Rebuild(GridRows)
   
End

Public Sub Gridview1_Menu()

 '  mnuAppointments.Popup()

End
