' Gambas class file

' Copyright (C) 2008-2011 Dr. Richard Terry

' This program is free software: you can redistribute it and/or modify
' it under the terms of the GNU General Public License as published by
' the Free Software Foundation, either version 3 of the License, or
' (at your option) any later version.

' This program is distributed in the hope that it will be useful,
' but WITHOUT ANY WARRANTY; without even the implied warranty of
' MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
' GNU General Public License for more details.

' You should have received a copy of the GNU General Public License
' along with this program.  If not, see <http://www.gnu.org/licenses/>.
'----------------------------------------------------------------------------------
' PURPOSE         Mainly a container form for showing appointment grids
' HOW THIS WORKS  Contains the necessary logic to allow the user to:
'                 - set the location branch
'                 - select the type of  view eg week view for staff
'                   or day view for all staff at once
'                 - to search for e.g next available long appointment
'                 - all the days of apointments are forms embedded onto
'                   the main workspace on a scroll view - which will show
'                   three days at once. The search logic for the patient is on this
'                   form and the resultant collection of a patient are passed back
'                   to which ever embedded FAppointmentList form called the logic
'                   in the first place
'------------------------------------------------------------------------------------

Private bexit As Boolean
Private OnRow As Integer
Private GridData As Collection 
Private GridRows As Collection
Private iLeft As Integer
Private iTop As Integer
Private iRowHeight As Integer = 20 'make this configurable
Private i As Integer
Private iFirstRow As Integer
Private iLastRow As Integer
Private bFoundFirst As Integer
Private PregnancyIcon As Picture = Picture["icons/20/pregnancy.png"]
Private BloodTestIcon As Picture = Picture["icons/16/bloodtube16x16.png"]
Private Staff As Collection
Private Staff_Member As Collection
Private form_select As FPatientsSelect
Private clinics As Collection
Private clinic As Collection
Private obs As Observer 
Private Appointment_Lists As Collection   'of FAppointmentList forms
Private FContainer As FAppLists
Public DayLists As Object[] 
Private DayList As FAppointmentList
Private DayListContainer As Window
Private HB As HBox
Private sv As ScrollView
Private CurrentSearchTxtBox As Textbox 
Private iSlotCount As Integer
Public AppointmentList As FAppointmentList

Static Private Form_Make_Appointments As FMakeAppointments

Static Public Sub patient_load_record_external(patient As Collection, bPhotoConfirmed As Boolean, P As Picture) 
   '------------------------------------------------------------------------------
   'User has searched for a patient > multiple choice > chosen, so load the record
   '------------------------------------------------------------------------------   
   
   Form_Make_Appointments.patient_load_record(patient, bPhotoConfirmed, P)
   
End

Public Sub patient_load_record(patient As Collection, bPhotoConfirmed As Boolean, P As Picture) 
   '---------------------------------------------------------------------------------
   'Display patient name in the appointment book
   'this name is set in the current FappointmentList
   'the text2_change event triggers the necessary code to update the appointment grid
   '---------------------------------------------------------------------------------

   Me.Parent.Parent.Parent.Visible = True
   AppointmentList.patient = Patient
   AppointmentList.TextBox2.text = patient!wholename & " [" & Format(patient!birthdate, "dd/mm/yyyy") & "] " & Trim(patient!street1 & " " & patient!street2) & " " & patient!town

End

Public Sub Init()
   '------------------------------------------------
   'Initialise the appointment module from FClerical 
   '------------------------------------------------
   
   Dim Appointment_interval As Integer                                                 'interval in minutes for appointments
   Dim x As Integer
   
   Dim iHour As Integer
   Dim iMinute As Integer
   Dim iStartHour As Integer = 8                                                       'fixme make me configurable
   Dim iStartMinute As Integer = 30
   
   Form_Make_Appointments = Me
   staff = modUtil.LoadCombo(cmbStaff, modContactsDBI.Staff_Get(), "wholename")     'get all staff
   clinics = modUtil.LoadCombo(cmbLocation, modAdminDBI.Clinics_Get(), "branch")       'get all branches
   lblMeasure.text = "  Find patient appointment  "
   modEditAreaHelpers.Resize_labels(VBox_SearchOptions, lblMeasure)
   cmbFind.Add("Normal appointment")
   cmbFind.Add("Long appointment")
   cmbFind.Add("Over 75 Health Care Assessment")
   cmbFind.Add("Prolonged appointment")
   cmbFind.Index = 0
   cmbDays.Add("Monday")
   cmbDays.Add("Tuesday")
   cmbDays.Add("Wednesday")
   cmbDays.Add("Thursday")
   cmbDays.Add("Friday")
   cmbDays.Add("Saturday")
   cmbDays.Add("Sunday")
   cmbTimeDay.Add("Morning")
   cmbTimeDay.Add("Afternoon")
   cmbTimeDay.Add("Evening")
   
End

Public Sub form_Close()
   
   Settings_Save()
   
End

Private Sub Settings_Save()
   
End

Private Sub Settings_Load()
   
End

Public Sub form_Resize()
   '--------------------------------------------------------------------------------
   'Resize the appointment lists contained on the workspace
   'Try.. because they may not exist yet
   'I've arbitrarily at the moment made the size of each list = 1/3 of the workspace
   ''-------------------------------------------------------------------------------   
   
   Try FContainer.HBox1.width = 5 * (Workspace1.width / 3)
   
End

Public Sub cmbEditArea_Click()
   '-------------------------------------------
   'User has clicked on the staff members combo
   '-------------------------------------------  
   
   Dim AL As FAppointmentList
   Dim x As Integer
   Dim theDate As Date
   Dim HBox_Week As Hbox

   Select Case Last.tag
      Case "location"
         'Set location 
      Case "seen by"
         Staff_Member = staff[cmbStaff.Index]
         With DayListContainer = New Window
            .Arrangement = Arrange.Fill
            .Expand = True
            .title = Staff_Member!wholename
         End With
         With sv = New ScrollView(DayListContainer)
            .Expand = True
            .Arrangement = Arrange.Horizontal
            .Border = False
         End With
         With HB = New HBox(sv)
            .Expand = False   
            .Padding = 5
         End With
         Workspace1.Add(DayListContainer)
         For x = 0 To 4
            theDate = DateAdd(Now, gb.day, x)
            With HB
               .width = (x + 1) * (Workspace1.width / 3)    'try and fit 3 days/screen
            End With
            With AL = New FAppointmentList(HB)
               .Init(Staff_Member, thedate, clinics[cmbLocation.index]!fk_clinic)
               obs = New Observer(AL.Gridview1) As "AppointmentList"
               obs = New Observer(AL.txtAppointment) As "TxtFindPatient"
            End With
         Next
         
   End Select
   
End

Public Sub txtFindPatient_Activate()
   
   Stop Event
   
   bExit = False
   AppointmentList = Last.Window
   Patients_Find(Last)
   Last.Visible = False 
   
End

Public Sub Patients_Find(txtBox As Textbox, Optional fk_patient As Integer) 
   '-----------------------------------------------------------------------------
   'Attemps to find patients according to criteria entered in cmbSearch
   'of by patient key if picked from list of patients seen that day
   'If none found , resets focus to cmbsearch
   'Otherwise creates an empty patient object
   'If only one name and address auto-load that patient to currentconsult
   'If multiple names/addresses, popup a modal for choice
   'which returns a patient object which becomes currentconsult
   'fixme - implement the patient stack
   '-----------------------------------------------------------------------------
   
   Dim AllPatients As New Collection
   Dim patient As Collection
   Dim sql_in_english As String
   Dim P As Picture
   Dim bPhotoConfirmed As Boolean = False 
   
   If BExit Then Return 
   bExit = True   
   
   Inc Application.Busy
   
   If fk_patient Then
      AllPatients = modContactsDBI.Patient_Get_Using_PK(fk_patient)
   Else
      AllPatients = modContactsDBI.patients_get_firstname_surname(Lower(txtbox.text), False) 'get only living patients
      
      sql_in_english = AllPatients!sql_in_english
      AllPatients.Remove("sql_in_english")
   End If   
   If AllPatients.count = 0 Then 
      Last.SetFocus()
      Dec application.Busy
      bExit = False  
      Return
   Else  
      '----------------------------------------------------
      'One or more patients.
      'If one, get their photo if it exists and load record
      '----------------------------------------------------
      If AllPatients.count = 1 Then  
         '----------------------------------------------------
         'no way in gambas to get a key without an iteraction
         'get first key
         '----------------------------------------------------
         For Each patient In AllPatients
            If Not IsNull(patient!image.data) Then 
               P = modGraphics.Blob_Convert_To_Picture(patient!image)!picture 
            Else
               P = Picture.Load("icons/misc/no_photo.png")
            End If   
         Next
         FConfirmPatient.Init(P, patient!wholename)
         If Not FConfirmPatient.ShowModal() Then 
            bExit = False  
            Return            
         End If
         patient_load_record(patient, bPhotoConfirmed, P)
      Else  
         '---------------------
         'more than one patient
         '---------------------
         Dec Application.Busy
         Me.Parent.Parent.Parent.Visible = False  '(vbox1 on FClerical)
         form_select = New FPatientsSelect(Me.Parent.Parent.Parent.Parent)
         obs = New Observer(form_select.btnCancel) As "SelectPatient"     
         form_select.Init(AllPatients, sql_in_english, "FMakeAppointments")
         form_select.Visible = True 
      Endif
   End If   
   bExit = False  
   Dec application.Busy
   ' 

End

Public Sub WeekView_Display()
   '--------------------
   'Displays a week view
   '-------------------- 
   
End

Public Sub rbWeekView_Click()
   
   Select Case Last.tag
      Case "day view"
      Case "week view" 
   End Select
   
End

Public Sub Workspace1_Activate()
   '------------------------------------------
   'User has clicked on a tab on the workspace
   '------------------------------------------
   
   Dim page As Window
   
   For Each page In Workspace1.Windows
      If page = Workspace1.ActiveWindow Then  
         Print page.Title 
      End If   
   Next
   
End

Public Sub Button1_Click()
   
   Print appointmentList.GridRows
   
End
