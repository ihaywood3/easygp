' Gambas class file

Private Staff As Collection
Private fk_staff_Allocated As Variant
Private StaffTypes As Collection
Private fk_staff_type As Variant
Private Form_Decision_Support As FDecisionSupport
Private columnview1_key As Variant

Public Sub _new()
   
   StaffTypes = modutil.Copy_Collection_Keyed_Sequentially(modAdminDBI.Staff_Types_Get())
   modUtilGUI.LoadCombo(cmbStaffType, StaffTypes, "type")
   cmbStaffType.index = -1
    Form_Decision_Support = New FDecisionSupport(Vbox_Decision_Support)
End

Public Sub Init()
   
   With tableview1
      .Columns.Count = 7
      .Rows.count = 10
      .Columns[0].text = "Date"
      .Columns[1].text = "Logged By"
      .Columns[2].text = "Issue"
      .Columns[3].text = "Proposed Action"
      .Columns[4].text = "Responsible Person"
      .Columns[5].text = "Outcome"
      .Columns[6].text = "Resolved"
      .Rows.H = 32
   End With
   lblMeasure.text = "Remove From Agenda      "
   modEditAreaHelpers.Resize_labels(VBox_EditArea, lblmeasure) 
   lblMeasure.text = "Proposed Actions   "
   modEditAreaHelpers.Resize_labels(VBox_EditArea_Right, lblmeasure)
   staff = modUtilGUI.LoadCombo(cmbStaff, modContactsDBI.Staff_Get(), "wholename")   
   Settings_Load 
   
End

Private Sub Form_Close()
   
   Settings_Save 
   
End

Private Sub Settings_Load()
   
   VSplit_Agenda_Items.Layout = Settings["FStaffMeetings/VSplit_Agenda_Items.Layout", modUtilGUI.VSplit([1, 1])]
   
End

Private Sub Settings_Save()
   
End

' Private Sub Issue_New()
'    
'    ' txtDateAgendaItemLogged.text = Format(Now, "dd/mm/yyyy")
'    ' txtStaffLogged.text = modDBConnect.currentUser!wholename
'    ' txtIssue.SetFocus   
'    tableview1[0, 0].text = Format(Now, "dd/mm/yyyy")
'    tableview1[0, 1].text = modDBConnect.currentUser!wholename
'    
' End 

Private Sub Issue_Save()
   '-----------------------------------------------------------------
   'Saves a user-entered issue to be raised at the next staff meeting
   '-----------------------------------------------------------------
   
   If Vbox_EditArea_Outer.padding = 0 Then Return
   If Not Issue_Data_Is_Valid() Then Return
   
End

Private Sub Issue_Data_Is_Valid() As Boolean
   
   If Trim(txtIssue.text) = "" Then Return 
   Return True   
   
End

Public Sub EditArea_TxtBox_Change()
   
   Select Case Last.tag
      Case "issue"
         Vbox_EditArea_Outer.Padding = 1
   End Select
   
End

Public Sub TableView1_Click()
   
   Select Case tableview1.Column
      Case 4
         tableview1.EditWith(cmbStaff)
      Case 6
         tableview1.EditWith(CheckBox1)
      Case Else
         tableview1.EditWith(textedit1)
   End Select
   
   ' Select Case tableview1.Column
   '    Case 0
   '       textedit
   '    Case 1
   ' End Select
End

Public Sub Tableview1_Save(Row As Integer, Column As Integer, Value As String) 
   
   ' If column <> 0 Then 
   Tableview1[Row, Column].text = Trim(Value)
   ' ProvidersOfCare[row]!contribution_to_plan = modUtilGUI.Strip_Last_Character(Trim(value), True)
   '  EditArea_Notify_DataChange(True)
   '  End If 
   
End

Public Sub VSplit_Agenda_Items_Resize()
   
   Settings[Me.name & "/VSplit_Agenda_Items.Layout"] = VSplit_Agenda_Items.Layout
   
End

Public Sub Staff_Find()
   'Finds the staff member to allocate document to
   
   Dim x As Integer
   Dim Staff_Member As Collection
   
   With columnview1
      .Clear()
      .Columns.count = 3
   End With
   If Trim(txtStaffAllocated.text) = "" Then Return
   staff = modutil.Copy_Collection_Keyed_Sequentially(modContactsDBI.Staff_Get(Trim(txtStaffAllocated.text)))
   If Not staff.count Then Return
   For Each Staff_Member In staff
      columnview1.Add(x, 0)
      columnview1[x][0] = Staff_Member!title & " " & Staff_Member!wholename
      columnview1[x][1] = Staff_Member!occupation
      columnview1[x][2] = Staff_Member!branch
      Inc x
   Next
   
   If Staff.count = 1 Then
      Staff_Display(Staff_Member) 'using the current Staff_Member collection
   Else
      modUtilGUI.Columnview_Columns_Set_Size(columnview1, lblmeasure)
      With Columnview1
         .Visible = True
         .Raise
         .tag = txtStaffAllocated
      End With
   End If
   
End

Public Sub ColumnView1_KeyPress()
   '---------------------------------------------------------
   'Either accept the user selection, or if they have hit the
   'up arrow, move back into the textbox
   '----------------------------------------------------------
   
   Select Case key.Code
      Case key.Return
         ColumnView1_DblClick()
   End Select
   
End

Public Sub ColumnView1_DblClick()
   
   With columnview1
      .MoveCurrent
      columnview1_key = .item.Key
      .Visible = False  
   End With
   
   Staff_Display(staff[columnview1_key])
   
End

Public Sub Staff_Display(Staff_Member As Collection)
   
   Try txtStaffAllocated.text = staff_member!title & " " & staff_member!wholename
   txtStaffAllocated.pos = 0
   fk_staff_Allocated = staff_member!fk_staff
   
End

Public Sub Reset_Keys()
   
   staff = Null
   fk_staff_Allocated = Null 
   
End

Public Sub Editarea_Clear()
   
   modEditAreaHelpers.EditArea_Clear(Vbox_Editarea)
   
End

Public Sub EditArea_Buttons_Click()
   
   ' Select Case Last.tag
   '    Case "new issue"
   '       Issue_New 
   '    Case "save issue"
   '       Issue_Save
   ' End Select
   
End

Public Sub EditArea_TextBox_GotFocus()
   
   Last.BackGround = Color.rgb(95, 255, 175)
   If Last.tag = "staff allocated" Then
      With columnview1
         .Visible = False  
         .top = Last.Parent.parent.top + Last.Parent.height 
         .left = Last.Parent.Left
         .width = txtProposedAction.Width
      End With
   End If      

End

Public Sub EditArea_TextBox_LostFocus()
   
   Last.BackGround = Color.White
   
End

Public Sub EditAreaButtons_Click()
   
   Select Case Last.tag
      Case "save"
         Save
      Case "new"
         New_Agenda_Item
      Case "save note"
      Case "new note"
         
   End Select
   
End

Public Sub Save()
   
End

Public Sub New_Agenda_Item()
   '-------------------------------------------- 
   ' Add a new agenda item for the staff meeting
   '-------------------------------------------- 
   
   Editarea_Clear
   Reset_Keys
   txtDateLogged.text = Format(Now, "dd/mm/yyyy")
   txtStaffLogged.text = modDBConnect.currentUser!wholename
   txtIssue.SetFocus
   
End

Public Sub Label8_MouseDown()
   
End

Public Sub EditArea_TextBox_KeyRelease()
   
   If Last.tag = "staff allocated" Then
      Staff_Find
   Endif
   
End
