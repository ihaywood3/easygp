' Gambas class file

Private cvwMeasurements_Key As Integer 
Private cvwMeasurementValues_Key As Integer
Private currentconsult As CConsult

Public Sub _new()
   
   Measurement_Available_Refresh 
   
End

Public Sub Current_Consult_Exists() As Boolean
   
   If Not IsNull(currentconsult) Then Return True 
   
End

Public Sub Init(cons As CConsult)
   
   currentconsult = cons
   
End

Public Sub Gui_Clear()
   
  currentconsult = Null
  modUtilGUI.Columnview_Clear_Properly(cvwMeasurementValues)
  modUtilGUI.Columnview_Clear_Properly(cvwMeasurements) 
   
End

Public Sub cvwMeasurementValues_Select()
   
   cvwMeasurementValues.MoveCurrent()
   cvwMeasurementValues_key = cvwMeasurementValues.Item.Key
   
End

Public Sub cvwMeasurementValues_Menu()
   
   If cvwMeasurementValues.count Then
      mnuMeasurementValues.popup()
   Endif
   
End

Public Sub mnuMeasurementValues_Click()
   
   Select Case Last.tag
      Case "delete"
         cvwMeasurementValues.MoveCurrent
         If modMeasurementsDBI.Measurement_Delete(currentconsult, cvwMeasurements[cvwMeasurements_Key][0], cvwMeasurementValues[cvwMeasurementValues_Key][1], cvwMeasurementValues[cvwMeasurementValues_Key][0], cvwMeasurementValues_key) Then    'true = success
            Measurement_Show_Values(const.Measurement_Types[cvwMeasurements_Key])
            ' If ActiveGraphButton.tag = const.Measurement_Types[cvwMeasurements_Key]!name_full Then
            '    Measurements_Make_Graph
            ' Endif
         End If   
   End Select
Catch
   Return 
   
End

Public Sub Measurement_Show_Values(measurement_type As Collection)
   '-----------------------------------------------------
   'when user clicks on the tabbed lists for measurments
   'show list for bp/height/weight in a numerical list
   '-----------------------------------------------------
   
   Dim M As Collection
   Dim Measurement_value As String
   
   With cvwMeasurementValues
      .Clear
      .Columns.count = 2
      .Columns[0].width = 80
   End With
   currentconsult.Refresh("measurements")
   For Each M In currentconsult!measurements
      If M!fk_type = measurement_type!pk Then
         'bad bug in measurements Ive not found FIXME
         'MEASUREMENT can be null bad bug
         If Not IsNull(M!measurement) Then
            Select Case measurement_type!pk
               Case const.Measurement_BP
                  measurement_value = modMeasurementsDBI.BP_Format(M!measurement)
               Case const.Measurement_Height
                  measurement_value = Format(M!measurement, "##.##")
               Case const.Measurement_Weight
                  measurement_value = Format(M!measurement, "##.##")
               Case const.Measurement_Hip
                  measurement_value = Format(M!measurement, "##.##")
               Case const.Measurement_Waist
                  measurement_value = Format(M!measurement, "##.##")
            End Select
            cvwMeasurementValues.Add(M!pk_measurement, 0)
            cvwMeasurementValues[M!pk_measurement][0] = Format(M!consult_date, "dd/mm/yyyy")
            cvwMeasurementValues[M!pk_measurement][1] = measurement_value
         End If
      Endif
   Next
Catch
   Message.Info("Richard crashed in measurments_show_data_list")
   
End

Public Sub cvwMeasurements_Select()
   
   cvwMeasurements.MoveCurrent()
   cvwMeasurements_Key = cvwMeasurements.Item.Key 
   Measurement_Show_Values(const.Measurement_Types[cvwMeasurements_Key])
   
End

Public Sub Measurement_Available_Refresh()
   '--------------------------------------------------------------------------------
   'Display a list of measurements available to anyone on the tabbed lists container
   '--------------------------------------------------------------------------------
   
   Dim Measurement As Collection
   
   cvwMeasurements.clear()
   For Each measurement In const.Measurement_Types
      cvwMeasurements.add(measurement!pk, 0)
      cvwMeasurements[measurement!pk][0] = measurement!name_full
   Next
   
End


