' Gambas class file

Private TBOption As CToolBarConfig
Private max_label_width As Integer
Private obs As Observer
Private parent_form As String
Private module As Collection
Private modules As Collection 
Private icon_path As String 
Private fk_module As Integer 

Public Sub Run() As Boolean
   
   'Return Not Me.ShowModal()
   
End


Public Sub Init(Optional pf As String = "")
   
   parent_form = pf 
   If Parent_Form = "Admin" Then
     tbAdd.Visible = True
   Else
     btnCancel.Visible = False   
     btnOk.Visible = True
     btnOk.text = "Ok"
   Endif
   Reload()

End

Public Sub Reload()
   
   Dim hCtrl As Control
   
   For Each hCtrl In ScrollView1.Children 'seems no other way to clear a scrollview
      hCtrl.Delete()
   Next
   modules = modAdminDBI.Clinical_Modules_Get_Names()
   For Each module In modules
      lblMeasure.text = module!name & "   "
      max_label_width = Max(max_label_width, lblMeasure.Width)
   Next
   Me.Title = "Configure Clinical Toolbar"
   
   For Each module In modules
      
      If parent_form = "Admin" Then icon_path = module!icon_path
      TBOption = New CToolBarConfig(ScrollView1, module, max_label_width, Parent_Form) As "ToolButton"
   Next
   tbAdd.Enabled = True
End

Public Sub Save()
   '-----------------------------------------------------------
   'Saves any changes to or additions to the modules collection
   '-----------------------------------------------------------   
   Dim hCtrl As Control
   Dim pnl As Panel
   Dim module As Collection
   Dim tb As TextBox
   
   For Each hCtrl In ScrollView1.Children 'all of these are CToolBarConfig
       pnl = hctrl
       module = New Collection
       fk_module = 0    'new module has tag of 0
       If pnl.tag <> 0 Then
         module!pk = pnl.tag
         fk_module = pnl.Tag
       End If  
             
        For Each hCtrl In pnl.Children
        If Hctrl Is TextBox Then
           If hctrl.tag = "module name" Then
              tb = hctrl
              module!name = tb.Text
           End If
           If hctrl.tag = "icon path" Then
             tb = hctrl
             module!icon_path = tb.Text
           Endif
        Endif
       Next
       modAdminDBI.Clinical_Module_Save(modules, fk_module, module)
      
    Next
     modDBConnect.CommitTrans()
     Reload()
End



Public Sub ToolButton_MouseDrag()
   
   Dim pic As Picture
   Dim Module_Properties As New Collection
   Dim v As Variant
   
   Module_Properties!module = Last.tag
   Module_Properties!icon = Last.$hImage 
   
   pic = Picture.Load("icons/20/workcover2020.png")
   Drag.Icon = Last.$hImage.Picture 
   Try Drag(Last.$hpanel, "data")
   
End 

Public Sub btnOK_Click()
   
   If Parent_Form = "Admin" Then
      Save()
   Else
       Me.Close(True)
   End If   
   
End

Public Sub btnCancel_Click()

   If Parent_Form <> "Admin" Then
      Me.Close
   Else
      Reload()
   End If   
   
End

Public Sub New_Section()
   '----------------------------------------------------------
   'Add a new icon, name and path to be available in FClinical
   '----------------------------------------------------------  
   
   Dim TBObption As CToolBarConfig
   Dim Module As New Collection
   module!pk = 0
   module!name = "New Section"
   module!icon_path = "icon:/small/question"
   With TBOption = New CToolBarConfig(ScrollView1, module, max_label_width, parent_form) As "ToolButton"
      .$hModuleTextBox.ReadOnly = False   
      .$hModuleTextBox.Background = Color.TextBackground
      .$hModuleTextBox.SetFocus()
      .$hModuleTextBox.Pos = 0
   End With

End

Public Sub tbAdd_Click()
   
   New_Section()
   tbAdd.enabled = False   

End
