' Gambas class file

' Copyright (C) 2008-2013 Dr Richard TERRY

' This program is free software: you can redistribute it and/or modify
' it under the terms of the GNU General Public License as published by
' the Free Software Foundation, either version 3 of the License, or
' (at your option) any later version.

' This program is distributed in the hope that it will be useful,
' but WITHOUT ANY WARRANTY; without even the implied warranty of
' MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
' GNU General Public License for more details.

' You should have received a copy of the GNU General Public License
' along with this program.  If not, see <http://www.gnu.org/licenses/>.
'---------------------------------------------------------------------
' PURPOSE  : quickndirty graphing utility
' USED BY  : FClinical and Finbox and FStaffTasks
' HOW WORKS: current consult gives us access to patients measurements
'            if loinc code and graphable will be graphed
' TODO     : EVERYTHING, Including, after a little thought, using
'            this in FClinical
'---------------------------------------------------------------------

Private currentconsult As CConsult
Private loinc As String
Private measurement As String
Private GraphData As Collection
Private fk_patient As Integer

Public Sub Form_Open()
   
   lblMeasure.text = "  Cumulative  "
   cmbLineStyle.Width = lblMeasure.Width 
   
End

Public Sub Set_fk_Patient(key As Integer)
   'sloppy but just mucking around, set from FdiabetesResearch   
  fk_patient = key 
   
End

Public Function Graph(cons As CConsult, L As String, M As String) As Boolean
   'fix me just quickly knocked together by RT sick of not being able
   'to view cumulative graphs in my inbox!!!
   
   currentconsult = cons
   loinc = L
   measurement = M
   Return Measurement_Graph(L, M)

End

Public Function Measurement_Graph(loinc As String, Measurement As String) As Boolean
   '-----------------------------------------------------------
   'Graph a measurement
   'if Loinc = "" then measurement is BP, height, weight or PF
   'if Loinc <> "" then graph an observable measurement
   '-----------------------------------------------------------

   Dim Interval As Integer = 0
   Dim Astring As String 
   Dim GraphableItem_Data As New Collection 
 
   If Not IsNull(currentconsult) Then
        fk_patient = currentconsult!patient!fk_patient
   End If   
   GraphData = New Collection 
   GraphData = modMeasurementsDBI.Make_Graph(fk_patient, loinc, Measurement, pbMeasurementGraph.H, pbMeasurementGraph.W, slGraphFontSize.value, cmbLineStyle.text, interval)
   GraphData!name = Measurement
   GraphData!fontsize = slGraphFontSize.value
   GraphableItem_Data!loinc = loinc
   GraphableItem_Data!name = Measurement
   
   Try pbMeasurementGraph.picture = Picture.Load(GraphData!graph_filename)
   If Error
      Measurement_Graph_Picture_Clear()
      Return False
   Else
      pbGraphName.tag = GraphableItem_Data
      Return True
   End If
   
End

Public Sub Measurement_Graph_Picture_Clear()

   With pbMeasurementGraph
      .picture = Null
      .tag = ""
      .Refresh()
   End With

End

Public Sub slGraphFontSize_Change()
    If Loinc = "" Then Return 
     Measurement_Graph(Loinc, Measurement)
End
