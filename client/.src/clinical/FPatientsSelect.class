' Gambas class file
' Copyright (C) 2008,2009 Dr. Richard Terry Dr. Ian Haywood

' This program is free software: you can redistribute it and/or modify
' it under the terms of the GNU General Public License as published by
' the Free Software Foundation, either version 3 of the License, or
' (at your option) any later version.

' This program is distributed in the hope that it will be useful,
' but WITHOUT ANY WARRANTY; without even the implied warranty of
' MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
' GNU General Public License for more details.

' You should have received a copy of the GNU General Public License
' along with this program.  If not, see <http://www.gnu.org/licenses/>.
' Name            FPatientsSelect
' Function        Allow user to select a patient to diplay their medical records
'-------------------------------------------------------------------------------
             
Private allpatients As Collection
Private currentpatient As Collection
Private form_clinical As FClinical

Public Sub Form_Open()
    Me.Title = "Select Patient"                   'add title
    cvpersons.MoveFirst()                          'move to first visible row                      
    cvpersons.item.Selected = True                'highlight the row
 End

Public Sub btnOK_Click()
   '--------------------------------------------
   'Accept current patient and load their record
   '--------------------------------------------
   If Not IsNull(currentpatient)
     Me.Close(True)
     form_clinical.patient_load_record(currentpatient)
   Endif
End


Public Sub SetPatientList(allpatients2 As Collection, sql_in_english As String, fc As FClinical)
   '-----------------------
   'Show multiple patients for selection
   'In this routine we:
   '       : loop through the data_persons recordset 
   '       : for each  of these, then fetch 1-n addresses
   '       : if one address, put in column 3,4
   '       : ie same row as name,surname,sex,dob
   '       : if > one address put on next row, without name,surname,sex,dob
   '-------------------------------------------------------------------------
   Dim patient As Collection                                        
   Dim iaddress As Collection
   Dim icomm As Collection
   Dim iLastPatient_pk As Integer
   Dim iAddressCount As Integer
   Dim x As Integer 
   txtSqlInEnglish.Text = sql_in_english
   allpatients = allpatients2
   form_clinical = fc
   '-------------------------------------------------------------------------
   'columns: 0=surname 1=firstname 2=sex 3=street 4= town/postcode 5=contacts
   '-------------------------------------------------------------------------
   cvPersons.Columns.count = 7     
   cvpersons.Columns[0].width = 200               
   iLastPatient_pk = -1
   For Each patient In allpatients   
      If patient!fk_patient <> iLastPatient_pk Then
        iLastPatient_pk = patient!fk_patient
        iAddressCount = 0
        cvPersons.Add(patient!pk_view, 0)    
        cvPersons[patient!pk_view][0] = patient!surname  
        cvPersons[patient!pk_view][1] = patient!firstname
        cvPersons[patient!pk_view][2] = patient!sex
        cvPersons[patient!pk_view][3] = Format(patient!birthdate, "dd/mm/yyyy")
        cvPersons[patient!pk_view][4] = "Age: " & Str(modUtil.Calc_age(patient!birthdate))
        '---------------------------    
        'Next to this show the comms
        '---------------------------- 
        patient!comms = modContactsDBI.person_comms_get(patient!fk_person)
        For Each icomm In patient!comms 
           cvPersons[patient!pk_view][7] = cvPersons[patient!pk_view][7] & "    " & icomm!comm_type & ": " & icomm!value
        Next
       '----------------------------------------------------------------------
       'For the first address put it on the same row as surname/name and coms
       '---------------------------------------------------------------------
       cvPersons[patient!pk_view][5] = patient!street 
       cvPersons[patient!pk_view][6] = patient!town & " " & patient!postcode
     Else
         '---------------------------------------------
         'patient is the same, just add the address
         cvPersons.Add(patient!pk_view, 0)
         cvPersons[patient!pk_view][0] = "" 
         cvPersons[patient!pk_view][1] = ""
         cvPersons[patient!pk_view][2] = ""
         cvPersons[patient!pk_view][3] = ""
         cvPersons[patient!pk_view][4] = ""
         cvPersons[patient!pk_view][5] = patient!street 
         cvPersons[patient!pk_view][6] = patient!town & " " & patient!postcode
      End If
  Next   
  cvPersons.Enabled = True                       
  cvPersons.SetFocus()
End

Public Sub SetPatientList_sortaold(allpatients2 As Collection, sql_in_english As String, fc As FClinical)
   '-----------------------
   'Show multiple patients for selection
   'In this routine we:
   '       : loop through the data_persons recordset 
   '       : for each  of these, then fetch 1-n addresses
   '       : if one address, put in column 3,4
   '       : ie same row as name,surname,sex,dob
   '       : if > one address put on next row, without name,surname,sex,dob
   '-------------------------------------------------------------------------
   Dim patient As Collection                                        
   Dim iaddress As Collection
   Dim icomm As Collection
   Dim iLastPatient_pk As Integer
   Dim iAddressCount As Integer
   Dim x As Integer 
   txtSqlInEnglish.Text = sql_in_english
   allpatients = allpatients2
   form_clinical = fc
   '-------------------------------------------------------------------------
   'columns: 0=surname 1=firstname 2=sex 3=street 4= town/postcode 5=contacts
   '-------------------------------------------------------------------------
   cvPersons.Columns.count = 6                    
   iLastPatient_pk = -1
   For Each patient In allpatients   
      If patient!fk_patient <> iLastPatient_pk Then
        iLastPatient_pk = patient!fk_patient
        iAddressCount = 0
        cvPersons.Add(x, 0)    
        cvPersons[x][0] = patient!surname  
        cvPersons[x][1] = patient!firstname
        cvPersons[x][2] = patient!sex
        '---------------------------    
        'Next to this show the comms
        '---------------------------- 
        patient!comms = modContactsDBI.person_comms_get(patient!fk_person)
        For Each icomm In patient!comms 
           cvPersons[x][5] = cvPersons[x][5] & "    " & icomm!comm_type & ": " & icomm!value
        Next
         '------------------------------------------
         'now get all the addresses for each patient
         'If an address exists for this patient 
         'If only one, show on same row as name
         'otherwise create a new row under the name,
         ' but show only address
         'fixme these already exist as rows in the allpatients collection 
         '------------------------------------------
         patient!addresses = modContactsDBI.person_addresses_get(patient!fk_person)
         iAddressCount = 0
         For Each iaddress In patient!addresses
          If iAddressCount = 0 Then  
            '-----------------------------------------
            'Add the first row to the same row as name
            '-----------------------------------------
            cvPersons[x][3] = iaddress!street 
            cvPersons[x][4] = iaddress!town & " " & iaddress!postcode
          Else
            '---------------------------------------------
            'If any more exist,add them to subsequent rows
            '---------------------------------------------
            Inc x
          '  patient!pk_view = Str$(patient!fk_patient) & "_" & Str$(iAddressCount) 
            cvPersons.Add(x, 0)
            cvPersons[x][0] = "" 
            cvPersons[x][1] = ""
            cvPersons[x][2] = ""
            cvPersons[x][3] = iaddress!street 
            cvPersons[x][4] = iaddress!town & " " & iaddress!postcode
          Endif
         Inc iAddressCount
       Next 
       '-----------------------------------------
       'now get all the comms for each patient
       'If an comms exists for this patient 
       'show preferred contact method in next column
       '-----------------------------------------
      ' patient!comms = modContactsDBI.person_comms_get(patient!fk_person)
      ' For Each icomm In patient!comms 
      '   cvPersons[patient!pk_view][5] = cvPersons[patient!pk_view][5] & "    " & icomm!comm_type & ": " & icomm!value
      ' Next
      '                   
      Inc x
     Endif
  Next   
  cvPersons.Enabled = True                       
  cvPersons.SetFocus()
End


Public Sub cvPersons_Select()
  '----------------------------------------------------------------
  ' The main patients list has been clicked on
  ' Each row in this can be either name  +  first address or
  '                                blank +  second address for name
  '----------------------------------------------------------------
  If cvPersons.Count Then 
    currentpatient = allpatients[cvpersons.Item.key]  
  End If
End

Public Sub cvPersons_DblClick()
  btnOK_Click
End
