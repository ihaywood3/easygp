' Gambas class file

' Copyright (C) 2008-2011 Dr. Richard Terry Dr. Ian Haywood

' This program is free software: you can redistribute it and/or modify
' it under the terms of the GNU General Public License as published by
' the Free Software Foundation, either version 3 of the License, or
' (at your option) any later version.

' This program is distributed in the hope that it will be useful,
' but WITHOUT ANY WARRANTY; without even the implied warranty of
' MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
' GNU General Public License for more details.

' You should have received a copy of the GNU General Public License
' along with this program.  If not, see <http://www.gnu.org/licenses/>.
' Name            FPatientsSelect
' Function        Allow user to select a patient to diplay their medical records
'-------------------------------------------------------------------------------

Private allpatients As Collection
Private currentpatient As Collection
Private form_clinical As FClinical

Public Sub Form_Open()
   
   Me.Title = "Select Patient"                   'add title
   cvpersons.MoveFirst()                          'move to first visible row                      
   cvpersons.item.Selected = True                'highlight the row
   
End

Public Sub btnOK_Click()
   '--------------------------------------------
   'Accept current patient and load their record
   '--------------------------------------------
   
   If Not IsNull(currentpatient)
      Me.Close(True)
      form_clinical.patient_load_record(currentpatient)
   Endif
   
End

Public Sub SetPatientList_old(allpatients2 As Collection, sql_in_english As String, fc As FClinical)
   '-----------------------
   'Show multiple patients for selection
   'In this routine we:
   '       : loop through the data_persons recordset 
   '       : for each  of these, then fetch 1-n addresses
   '       : if one address, put in column 3,4
   '       : ie same row as name,surname,sex,dob
   '       : if > one address put on next row, without name,surname,sex,dob
   '-------------------------------------------------------------------------
   
   Dim patient As Collection                                        
   Dim iaddress As Collection
   Dim icomm As Collection
   Dim iLastPatient_pk As Integer
   Dim iAddressCount As Integer
   Dim x As Integer 
   
   txtSqlInEnglish.Text = sql_in_english
   allpatients = allpatients2
   form_clinical = fc
   '-------------------------------------------------------------------------
   'columns: 0=surname 1=firstname 2=sex 3=street 4= town/postcode 5=contacts
   '-------------------------------------------------------------------------
   cvPersons.Columns.count = 7     
   cvpersons.Columns[0].width = 200               
   iLastPatient_pk = -1
   For Each patient In allpatients   
      If patient!fk_patient <> iLastPatient_pk Then
         iLastPatient_pk = patient!fk_patient
         iAddressCount = 0
         cvPersons.Add(patient!pk_view, 0)    
         cvPersons[patient!pk_view][0] = patient!surname  
         cvPersons[patient!pk_view][1] = patient!firstname
         cvPersons[patient!pk_view][2] = patient!sex
         cvPersons[patient!pk_view][3] = Format(patient!birthdate, "dd/mm/yyyy")
         If patient!age_numeric < 5 Then 
            cvPersons[patient!pk_view][4] = "Age: " & patient!age_display
         Else
            cvPersons[patient!pk_view][4] = "Age: " & Str(patient!age_numeric)
         End If
         '---------------------------    
         'Next to this show the comms
         '---------------------------- 
         patient!comms = modContactsDBI.person_comms_get(patient!fk_person)
         For Each icomm In patient!comms 
            cvPersons[patient!pk_view][7] = cvPersons[patient!pk_view][7] & "    " & icomm!comm_type & ": " & icomm!value
         Next
         '----------------------------------------------------------------------
         'For the first address put it on the same row as surname/name and coms
         '---------------------------------------------------------------------
         cvPersons[patient!pk_view][5] = Trim(patient!street1 & " " & patient!street2)
         cvPersons[patient!pk_view][6] = patient!town & " " & patient!postcode
      Else
         '---------------------------------------------
         'patient is the same, just add the address
         cvPersons.Add(patient!pk_view, 0)
         cvPersons[patient!pk_view][0] = "" 
         cvPersons[patient!pk_view][1] = ""
         cvPersons[patient!pk_view][2] = ""
         cvPersons[patient!pk_view][3] = ""
         cvPersons[patient!pk_view][4] = ""
         cvPersons[patient!pk_view][5] = Trim(patient!street1 & " " & patient!street2) 
         cvPersons[patient!pk_view][6] = patient!town & " " & patient!postcode
      End If
   Next   
   cvPersons.Enabled = True                       
   cvPersons.SetFocus()
   
End

Public Sub SetPatientList(allpatients2 As Collection, sql_in_english As String, fc As FClinical)
   '-----------------------
   'Show multiple patients for selection
   'In this routine we:
   '       : loop through the data_persons recordset 
   '       : for each  of these, then fetch 1-n addresses
   '       : if one address, put in column 3,4
   '       : ie same row as name,surname,sex,dob
   '       : if > one address put on next row, without name,surname,sex,dob
   'FIXME  : put option somewhere for users not to see the pictures.
   '-------------------------------------------------------------------------
   
   Dim pPicture As PictureBox
   Dim HB As HBox
   Dim tl As TextLabel
   Dim patient As Collection                                        
   Dim iaddress As Collection
   Dim icomm As Collection
   Dim iLastPatient_pk As Integer
   Dim iAddressCount As Integer
   Dim x As Integer 
   Dim I As Image
   Dim P As Picture
   Dim sPath As String = Temp()
   Dim sep As Separator
   Dim Pnl As Panel

   txtSqlInEnglish.Text = sql_in_english
   allpatients = allpatients2
   form_clinical = fc
   '-------------------------------------------------------------------------
   'columns: 0=surname 1=firstname 2=sex 3=street 4= town/postcode 5=contacts
   '-------------------------------------------------------------------------
   cvPersons.Columns.count = 7     
   cvpersons.Columns[0].width = 200               
   iLastPatient_pk = -1
   For Each patient In allpatients  
      If Not IsNull(patient!image.data) Then 
         P = modGraphics.Blob_Convert_To_Picture(patient!image) 'this is blob data, not an image
      Else
         P = Picture.Load("icons/misc/no_photo.png") 
      Endif
      If patient!fk_patient <> iLastPatient_pk Then
         
         iLastPatient_pk = patient!fk_patient 
         patient!comms = modContactsDBI.person_comms_get(patient!fk_person)
         
         iAddressCount = 0
         With HB = New HBox(lcPatients)
            .expand = False
            Try .height = P.height
            If Error Then .height = 80
            .AutoResize = True   
            .tag = patient!pk_view 'to find place in the collection when row is clicked.
         End With
         With pPicture = New PictureBox(HB)
            .Border = True   
            .Picture = P
            .Stretch = True   
            .Width = P.width
            .width = 70
            .Height = 80
            .Expand = False
         End With
         With pnl = New Panel(HB)
            .width = 50 
         End With
         
         With tl = New TextLabel(HB)
            .Expand = True 
            .AutoResize = False  
            .font = Font["Arial,13"]
            
            .text = "<P><FONT COLOR=\"#280099\"><B>" & patient!surname & " " & patient!firstname & " " & "Age: "
            If patient!age_numeric < 5 Then 
               .text &= patient!age_display
            Else
               .text &= patient!age_numeric
            End If   
            .text &= " (" & patient!sex & ")</B></P>"
            .text &= "<TABLE>"
            .text &= "<Tr><TD WIDTH=15%><small>Birthdate</TD><TD><small>" & Format(patient!birthdate, "dd/mm/yyyy") & "</small></TD></TR>"
            .text &= "<TR><TD WIDTH=15%><small>Address</TD><TD><small>" & Trim(patient!street1 & " " & patient!street2) & " " & patient!town & " " & patient!postcode & "</small></TD></TR>"
            .text &= "<TR><TD WIDTH=15%><small>Contacts</TD><TD><small>"
            For Each icomm In patient!comms 
               .text &= icomm!type & ": " & icomm!value & "  "
            Next
            .text &= "</small></TD></TR>"
            .text &= "</TABLE>"
            .text &= ""
         End With
         With sep = New Separator(lcPatients)
            .Height = 3
            .Foreground = Color.Black
         End With
         
         cvPersons.Add(patient!pk_view, 0)    
         cvPersons[patient!pk_view][0] = patient!surname  
         cvPersons[patient!pk_view][1] = patient!firstname
         cvPersons[patient!pk_view][2] = patient!sex
         cvPersons[patient!pk_view][3] = Format(patient!birthdate, "dd/mm/yyyy")
         If patient!age_numeric < 5 Then 
            cvPersons[patient!pk_view][4] = "Age: " & patient!age_display
         Else
            cvPersons[patient!pk_view][4] = "Age: " & Str(patient!age_numeric)
         End If
         '---------------------------    
         'Next to this show the comms
         '---------------------------- 
         For Each icomm In patient!comms 
            cvPersons[patient!pk_view][7] = cvPersons[patient!pk_view][7] & "    " & icomm!type & ": " & icomm!value
         Next
         '----------------------------------------------------------------------
         'For the first address put it on the same row as surname/name and coms
         '---------------------------------------------------------------------
         cvPersons[patient!pk_view][5] = Trim(patient!street1 & " " & patient!street2)
         cvPersons[patient!pk_view][6] = patient!town & " " & patient!postcode
      Else
         '---------------------------------------------
         'patient is the same, just add the address
         cvPersons.Add(patient!pk_view, 0)
         cvPersons[patient!pk_view][0] = "" 
         cvPersons[patient!pk_view][1] = ""
         cvPersons[patient!pk_view][2] = ""
         cvPersons[patient!pk_view][3] = ""
         cvPersons[patient!pk_view][4] = ""
         cvPersons[patient!pk_view][5] = Trim(patient!street1 & " " & patient!street2) 
         cvPersons[patient!pk_view][6] = patient!town & " " & patient!postcode
      End If
   Next   
   cvPersons.Enabled = True                       
   cvPersons.SetFocus()
   
End
Public Sub cvPersons_Select()
   '----------------------------------------------------------------
   ' The main patients list has been clicked on
   ' Each row in this can be either name  +  first address or
   '                                blank +  second address for name
   '----------------------------------------------------------------
   
   If cvPersons.Count Then 
      currentpatient = allpatients[cvpersons.Item.key]  
   End If
   
End

Public Sub cvPersons_DblClick()
   
   btnOK_Click
   
End

Public Sub lcPatients_Click()
 
   If lcPatients.Count Then
      
      currentpatient = allpatients[Last.children[Last.index].tag] 
   Endif
   
   
End

Public Sub lcPatients_DblClick()

            btnOK_Click()
End
