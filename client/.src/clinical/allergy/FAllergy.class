' Gambas class file

' Copyright (C) 2008-2012 Dr. Richard Terry

' This program is free software: you can redistribute it and/or modify
' it under the terms of the GNU General Public License as published by
' the Free Software Foundation, either version 3 of the License, or
' (at your option) any later version.

' This program is distributed in the hope that it will be useful,
' but WITHOUT ANY WARRANTY; without even the implied warranty of
' MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
' GNU General Public License for more details.

' You should have received a copy of the GNU General Public License
' along with this program.  If not, see <http://www.gnu.org/licenses/>.

Private currentconsult As CConsult
Private the_allergy As CRow
Private bExit As Boolean
Private widget_running As String

Public Sub Init(cons As CConsult)
'   '--------------------------------
'   'Do all the initialization things
'   '--------------------------------
    Try Settings_Load()
'   EditArea_Set_Label_widths()
'   EditArea_Clear()
   currentconsult = cons  
 
   
End

Public Sub form_Close()
  
   Settings_Save()
  
End


Public Sub Form_Save()
  
   FClinical.Refresh_AllPreviousNotes()
  
End

Public Sub Settings_Save()

Settings["Allergies/VSplit_Allergies.Layout"] = VSplit_Allergies.layout
 
End

Public Sub Settings_Load()

     VSplit_Allergies.layout = Settings["Allergies/VSplit_Allergies.Layout"]

End
 
Public Sub EditArea_Clear()
    'Clear the editing area, re-set current Allergy
     bExit = True                                      'stop re-entrance into change routines
     Vbox_EditArea.BackGround = Color.White             'remove red outline around edit area  ?remove colour leave red
     Vbox_EditArea.Padding = 0                         
     listview1.Visible = False                         'remove popup list if showing
     txtDate.text = ""                            'clear the text boxes
     txtBrand.text = ""
     txtGeneric.text = "" 
     listview1.Clear()
     listview1.Visible = False
     chkGenericSpecific.Value = False
     txtDate.text = Format(Now, "dd/mm/yyyy")
     txtBrand.SetFocus()
     bExit = False
     the_allergy = New CRow
End
 
Public Sub txtEditArea_GotFocus()
 
 Last.BackGround = Color.rgb(95, 255, 175)

End

Public Sub txtEditArea_LostFocus()
 
   Last.BackGround = Color.White 
End


Public Sub listview1_KeyPress()
   
      If Key.code = Key.return Then
        listview1_DblClick()
      End If
   
End

Public Sub listview1_DblClick()
      Select Case widget_running
      
      Case "brand"
         Brand_Select()
      Case "generic"
         Generic_Select()
      Case "class"
      Case "reaction"
      End Select
        
End

Public Sub Brand_Select()
     listview1.MoveCurrent
     txtBrand.text = listview1.Item.Text
     the_allergy!brand = listview1.Item.Text
     the_allergy!atccode = listview1.Item.Key
     ListView1.Visible = False
   
End

Public Sub Generic_Select()
     listview1.MoveCurrent
     txtGeneric.text = listview1.Item.Text
     the_allergy!atccode = listview1.Item.Key
     ListView1.Visible = False
End



Public Sub Editarea_KeyPress()
    Select Case Key.Code
    Case Key.Down
       If listview1.Visible Then
            listview1.MoveFirst
            listview1.Item.Selected = True
            listview1.setfocus
       End If
    Case Key.Return
    End Select
    If Last.tag = "generic" Or Last.tag = "brand" Then
       Timer1.Enabled = True
       widget_running = Last.tag
    Endif
End
 
Public Sub EditArea_GotFocus()
 
  Select Case Last.tag
     Case "brand"
       With listview1
         .left = txtBrand.Left
         .top = HBox_Product.top + hBox_Product.Height
         .width = HBox_Product.width / 2
       End With
     Case "generic"
       With listview1
         .left = txtBrand.Left
         .top = HBox_Generic.top + hBox_Generic.Height
         .width = HBox_Generic.width / 2
       End With  
  End Select
   
End

Public Sub Timer1_Timer()
   
  If bExit Then Return
  Select Case widget_running
    Case "brand"
       Brands_Get(txtBrand.Text)
    Case "generic"
       Generics_Get(txtGeneric.Text)
  End Select
  listview1.Visible = True
  Timer1.Enabled = False
   
End

Private Sub Brands_Get(brand As String)
   Dim r As Result
   
   listview1.Clear()
   r = modPrescribingDBI.Brands_Get_Basic(brand)
   For Each r
      listview1.Add(r!atccode, r!brand)
   Next
   listview1.Visible = True
   
End

Private Sub Generics_Get(generic As String)
   Dim r As Result
   
   listview1.Clear()
   r = modPrescribingDBI.Generics_Get_Basic(generic)
   For Each r
      listview1.Add(r!atccode, r!generic)
   Next
   listview1.Visible = True
   
End


Public Sub Form_Open()

  

End


Public Sub mnuHealthIssues_Click()
   '---------------------------------------------------
   'User wants to link a request form to a health issue
   'The menu tag = the pk_pasthistory
   '---------------------------------------------------
  
  Select Case Last.tag
  Case "general notes", "remove link"
    txtHealthIssue.text = "General Notes"
  Case Else
    txtHealthIssue.text = currentconsult!past_history[Last.tag]!description
  End Select
End


