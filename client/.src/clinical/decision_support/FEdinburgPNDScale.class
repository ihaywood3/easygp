' Gambas class file

' Copyright (C) 2008-2013 Dr. Richard Terry

' This program is free software: you can redistribute it and/or modify
' it under the terms of the GNU General Public License as published by
' the Free Software Foundation, either version 3 of the License, or
' (at your option) any later version.

' This program is distributed in the hope that it will be useful,
' but WITHOUT ANY WARRANTY; without even the implied warranty of
' MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
' GNU General Public License for more details.

' You should have received a copy of the GNU General Public License
' along with this program.  If not, see <http://www.gnu.org/licenses/>.
' please note the ownership of this material
' 
' A form class to allow the GP to adminster the Edinburg Depression Scale
' Questions reproduced with permission of the authors
' 
' Source:
' Cox, J.L., Holden, J.M., and Sagovsky, R. 1987. Detection of postnatal depression: Development of the 10-item
' Edinburgh Postnatal Depression Scale.  British Journal of Psychiatry 150:782-786."
' Users may reproduce the scale without further permission providing they respect copyright by quoting the names of the
' authors, the title and the source of the paper in all reproduced copies.
'--------------------------------------------------------------------------------------------------------------
Private currentconsult As CConsult
Private questions_answered As Integer
Private score As Integer   

Public Sub Init(c As Cconsult)
   
   currentconsult = c  
   tlheading.text = "<P>Please check the answer that comes closest to how you have felt "
   "<B>IN THE PAST 7 DAYS</B>, not just how you feel today.</P>"
   
   Make_Questionaire
   tlacknowledgement.text = ""
   "Source: Cox, J.L., Holden, J.M., and Sagovsky, R. 1987. Detection of postnatal depression: Development of the 10-item"
   "Edinburgh Postnatal Depression Scale.  British Journal of Psychiatry 150:782-786."
   
End

Public Function Make_Questionaire()
   
    Dim HBox_Question_Row As HBox       'will contain eg question 1 and question 6 etc
   Dim options As String[]
   Dim question As String
   
   With HBox_Question_Row = New HBox(ScrollView1)              'make a new row    
      .Expand = False
      .height = 125 
   End With  
   
   question = "1. I have been able to laugh and see the funny side of things"
   options = New String[]                                     'add the questions
   options.add("As much as I always could")
   options.add("Not quite so much now")
   options.add("Definitely not so much now")
   options.add("Not at all")
   Question_Box(1, question, options, HBox_Question_Row)
   question = "6. Things have been getting on top of me"
   options = New String[]  
   options.add("Yes, most of the time I haven’t been able to cope at all")
   options.add("Yes, sometimes I haven’t been coping as well as usual")
   options.add("No, most of the time I have coped quite well")
   options.add("No, I have been coping as well as ever")
   question_box(6, question, options, HBox_Question_Row)
   With HBox_Question_Row = New HBox(ScrollView1)              'make a new row    
      .Expand = False
      .height = 125 
   End With  
   question = "2. I have looked forward with enjoyment to things"
   options = New String[]  
   options.add("As much as I ever did")
   options.add("Rather less than I used to")
   options.add("Definitely less than I used to")
   options.add("Hardly at all")
   question_box(2, question, options, HBox_Question_Row)
   question = "7. I have been so unhappy that I have had difficulty sleeping"
   options = New String[]  
   options.add("Yes, most of the time")
   options.add("Yes, sometimes")
   options.add("Not very often")
   options.add("No, not at all")
   question_box(7, question, options, HBox_Question_Row)
   With HBox_Question_Row = New HBox(ScrollView1)              'make a new row    
      .Expand = False
      .height = 125 
   End With  
   question = "3. I have blamed myself unnecessarily when things went wrong"
   options = New String[]  
   options.add("Yes, most of the time")
   options.add("Yes, some of the time")
   options.add("Not very often")
   options.add("No, never")
   question_box(3, question, options, HBox_Question_Row)
   question = "8. I have felt sad or miserable"
   options = New String[]  
   options.add("Yes, most of the time")
   options.add("Yes, quite often")
   options.Add("Not very often")
   options.add("No, not at all")
   question_box(8, question, options, HBox_Question_Row)
   With HBox_Question_Row = New HBox(ScrollView1)              'make a new row    
      .Expand = False
      .height = 125 
   End With  
   question = "4. I have been anxious or worried for no good reason"
   options = New String[]  
   options.add("No, not at all")
   options.add("Hardly ever")
   options.add("Yes, sometimes")
   options.add("Yes, very often")
   question_box(4, question, options, HBox_Question_Row)
   question = "9. I have been so unhappy that I have been crying"
   options = New String[]
   options.add("Yes, most of the time")
   options.add("Yes, quite often")
   options.add("Only occasionally")
   options.add("No, never")
   question_box(9, question, options, HBox_Question_Row)
   With HBox_Question_Row = New HBox(ScrollView1)              'make a new row    
      .Expand = False
      .height = 125 
   End With  
   question = "5. I have felt scared or panicky for no very good reason"
   options = New String[]  
   options.add("Yes, quite a lot")
   options.add("Yes, sometimes")
   options.add("No, not much")
   options.add("No, not at all")
   question_box(5, question, options, HBox_Question_Row)
   question = "10.The thought of harming myself has occurred to me"
   options = New String[]  
   options.add("Yes, quite often")
   options.add("Sometimes")
   options.add("Hardly ever")
   options.add("Never")
   question_box(10, question, options, HBox_Question_Row)
  
   
End

Public Function Question_Box(question_number As Integer, question As String, options As String[], parent_box As Hbox) As HBox
   
   Dim VBox_Questions As VBox
   Dim option_row As HBox
   Dim chkbox As CheckBox
   Dim lblQuestion As Label
   Dim x As Integer
   Dim option As String
   Dim spacer As HBox
   
   With VBox_Questions = New Vbox(parent_box) 'attatch new box which will contain label and questions to the parent box
      .Expand = True  
   End With
   
   With lblQuestion = New Label(VBox_Questions)
      .text = question
      .Font.bold = True
      .height = 24
   End With 
   For Each option In options                'for each question
      With option_row = New HBox(VBox_Questions)   'create new hbox to contain checkbox and question
         .height = 24
         .Expand = False
      End With
      With Spacer = New HBox(option_row)           'add a bit of space
         .width = 12
      End With
      With chkbox = New CheckBox(option_row) As "chkboxScore"   
         .Height = 24
         .Value = False 
         .text = option 
         .Expand = True
         Select Case question_number               'for scoring 1,2,4 value of question = 0,1,2,3
            Case 1, 2, 4
               .tag = x
            Case Else                              'reverse scored
               .tag = 3 - x                        'ie checkbox 0 scores 3, checkbox 1 scores 2, checkbox 2 scores 1 checkbox 3 scores 0
         End Select
      End With
      Inc x   
   Next
   Return parent_box
   
End

Public Sub chkboxScore_Click()
   '-----------------------------------------------------------------------
   'Add the score, but first, uncheck all other boxes
   'bit fiddley but need to do this by hand
   'If the checkbox being clicked is true then
   'its parent.parent control tag (ie the main container for the options)
   'is set to "answered"
   'when all are answered show the score
   '-----------------------------------------------------------------------

   Dim Option_Box As HBox
   Dim hCtrl As Control
   Dim cb As CheckBox
    
   Last.parent.parent.tag = ""
   If Last.value = True Then 
      Last.parent.tag = "skip"                        'designate the Hbox holding the checked box to be skipped over
      For Each hCtrl In Last.parent.parent.children   'parent.parent = the Hbox holding the question and rows of checkboxes and spacers
         If hctrl Is Hbox Then
            Option_Box = hctrl
            If Option_Box.tag <> "skip" Then    
               For Each hctrl In Option_Box.Children  'otherwise if find a checkbox set its value back to false   
                  If hctrl Is CheckBox Then
                     cb = hctrl  
                     cb.value = False  
                  Endif
               Next
            Else                                     'it is the one being skipped, so is checked, add the score
               score += Last.tag 
               Last.parent.parent.tag = "answered"   'set the the Hbox holding the question and rows of checkboxes and spacers = answered.
               Last.parent.tag = ""        'remove the skip
            End If   
         Endif
      Next
   Else
        score -= Last.tag  
   End If   
   If Last.parent.parent.tag = "answered" Then
      Inc questions_answered
   Else
      Dec questions_answered
   End If   
   Print questions_answered   
   If questions_answered = 10 Then
      With lblScore
         .text = "Score:" & Str(score) & "/30 "
         If score > 9 Then  
            .text &= " depression possible  "
         Else
            .text &= " depression unlikely  "
         End If   
         
      End With
   Else
      lblScore.text = ""
   End If   
   
End

