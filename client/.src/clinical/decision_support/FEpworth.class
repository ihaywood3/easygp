' Gambas class file

' Copyright (C) 2008-2016 Dr. Richard Terry

' This program is free software: you can redistribute it and/or modify
' it under the terms of the GNU General Public License as published by
' the Free Software Foundation, either version 3 of the License, or
' (at your option) any later version.

' This program is distributed in the hope that it will be useful,
' but WITHOUT ANY WARRANTY; without even the implied warranty of
' MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
' GNU General Public License for more details.

' You should have received a copy of the GNU General Public License
' along with this program.  If not, see <http://www.gnu.org/licenses/>.
'----------------------------------------------------------------------
Private total As Integer            'the total score
Private Text_Summary As String      'summary of the results to insert into the progress notes
Private iRowCount As Integer        'used in deciding if can insert into progress notes

Public Sub _new()
   
   Reset
   
End

Public Sub Form_Open()
   
End

Public Sub RadioButtons_Click()
   
   Check_Controls("counting")
   
End

Public Sub Check_Controls(sMode As String)
   'Either counts up the score or sets all radiobuttons to false
   
   Dim HB As HBox
   Dim rb As RadioButton 
   Dim hctrl As Control
   Dim line_ctrl As Control
   Dim Row_HB As HBox
   Dim Inner_Box As HBox
   Dim Inner_Ctrl As Control
   Dim sChance As String
   Dim sQuestionText As String
   Dim lblQuestion As Label
   Dim srowText As String
   
   total = 0
   iRowCount = 0
   Hbox_Score_Low.Padding = 0
   Hbox_Score_Medium.Padding = 0
   Hbox_Score_High.Padding = 0
   text_summary = "<BR>"
   Text_Summary &= Row_Template()
   Text_Summary = Replace(Text_Summary, "col1", "<B>Epworth Sleepiness Scale Questionaire</B>")
   Text_Summary = Replace(Text_Summary, "col2", "<B>Chance of Dozing</B>")
   For Each Hctrl In VBox_Container.Children
      If hctrl.tag <> "ignore" Then
         Row_HB = hctrl
         For Each line_ctrl In Row_HB.Children
            If line_ctrl Is RadioButton Then
               rb = line_ctrl
               If sMode = "counting" Then
                  If rb.Value = True Then 
                     total += rb.Tag
                     lblScore.text = "Score:" & Str(total)
                     Select Case rb.Tag
                        Case 0
                           sChance = "Never"
                        Case 1
                           sChance = "Low"
                        Case 2
                           sChance = "Moderate"
                        Case 3
                           sChance = "High"
                     End Select
                     Inc iRowCount
                  End If  
               Else
                  rb.Value = False               'turn the button off when re-setting form
               End If 
            Else
               If line_ctrl Is Label Then
                  lblQuestion = line_ctrl
                  sQuestionText = lblQuestion.Text
                  Text_Summary &= Row_Template()
                  Text_Summary = Replace(Text_Summary, "col1", sQuestionText)
                  Text_Summary = Replace(Text_Summary, "col2", schance)
               Endif
            Endif
         Next
      End If 
   Next
   text_summary &= "</TABLE><BR><BR>"
   If iRowCount = 8 Then
      tbInsertIntoNotes.Enabled = True   
      If total < 10 Then
         Hbox_Score_Low.Padding = 2
         Hbox_Score_Medium.Padding = 0
         Hbox_Score_High.Padding = 0
         Text_Summary &= "A score of " & Str(total) & " means the patient is probably getting enough sleep."
      Else If total > 16 Then 
         Hbox_Score_Low.Padding = 0
         Hbox_Score_Medium.Padding = 0
         Hbox_Score_High.Padding = 2
         Text_Summary &= "A score of " & Str(total) & " means the patient may have a severe sleep problem."
      Else   
         Hbox_Score_Low.Padding = 0
         Hbox_Score_Medium.Padding = 1
         Hbox_Score_High.Padding = 0
         Text_Summary &= "A score of " & Str(total) & " means is is quite possible the patient may have a sleep problem."
      End If 
   Else
      tbInsertIntoNotes.Enabled = False   
   End If   
   
   Print text_summary
   
End

Public Function Row_Template() As String
   'for each row in the quiz
   'col 1 = the question, col2 = the text eg high, medium, low, none, col3 = a spacer
   
   Return ""
   "<COL WIDTH=50%>"
   "<COL WIDTH=20%>"
   "<COL WIDTH=30%>"
   "<TR VALIGN=TOP>"
   "<TD WIDTH=50%>"
   "col1"
   "</TD>"
   "<TD WIDTH=20%>"
   "col2"
   "</TD>"
   "<TD WIDTH=30%>"
   "</TD>"
   "</TR>"
   
End

Public Sub tbForm_Click()
   
   Select Case Last.tag
      Case "insert into notes"
         FProgressNoteEditor.Insert_text_External(".sometext", Text_Summary)
      Case "reset"
         reset
   End Select
   
End

Public Sub Reset()
   
   'clear the form and variables
   Hbox_Score_Low.Padding = 0
   Hbox_Score_Medium.Padding = 0
   Hbox_Score_High.Padding = 0
   Total = 0
   Check_Controls("reset")
   tbInsertIntoNotes.Enabled = False   
   
End

Public Function Epworth_Summary_GetRichText() As String
   
   Return "<BR>Epworth Sleepiness Scale Results</B>"
   ""
   
End
