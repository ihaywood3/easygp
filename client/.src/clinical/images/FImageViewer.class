' Gambas class file

' Copyright (C) 2008-2013 Dr. Richard Terry

' This program is free software: you can redistribute it and/or modify
' it under the terms of the GNU General Public License as published by
' the Free Software Foundation, either version 3 of the License, or
' (at your option) any later version.

' This program is distributed in the hope that it will be useful,
' but WITHOUT ANY WARRANTY; without even the implied warranty of
' MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
' GNU General Public License for more details.

' You should have received a copy of the GNU General Public License
' along with this program.  If not, see <http://www.gnu.org/licenses/>.
'----------------------------------------------------------------------
' PURPOSE      A form to load the patients pictures in for viewing
'              Can add tag if needed
'----------------------------------------------------------------------

Private Form_Magnify As FMagnify
Private Pictures As Collection
Private Picture As Collection
Private obs As Observer
Private NotesViewer As FHtmlViewer
Private Selected_Picture As Collection
Private bExit As Boolean

Private currentconsult As CConsult

Public Sub Init(cons As CConsult, sp As Collection)
   currentconsult = cons
   Selected_Picture = sp
   Form_Magnify = New FMagnify(VBox_DisplayArea)
   Reload()
   With NotesViewer = New FHtmlViewer(Vbox_ProgressNotes)
      .lblHtmlViewerHeading.Visible = True   
   End With
   Image_Display()
End

Public Sub Save()
   
  Dim I As New Collection
  Dim old_data As New Collection
     
  If Vbox_EditArea.Padding = 0 Then Return
  txtImageTag.Background = Color.White
  I!pk = Selected_Picture!pk
  I!tag = Trim(txtImageTag.text)
  modDBConnect.update("Blobs.images", Null, I)    
  txtImageTag.Background = Color.white 
  Vbox_EditArea.Padding = 0     
  FClinical.Refresh_Section(const.cSection_Images)
End
  
Public Sub Zoom_In()
   
    NotesViewer.Zoom_In()
   
End

Public Sub Zoom_Out()
   
   NotesViewer.Zoom_Out()
   
End

Public Sub EditArea_Clear()
   
    bexit = True
    txtImageTag.Text = ""
    Selected_Picture = New Collection
    txtImageTag.Background = Color.white
    bexit = False 
End

Public Sub Reload()
   
   Dim PB As PictureBox
   Dim Pic As Picture
   Dim HB As HBox
   Dim C As Collection
   Return 
   'Pictures = modImagesDBI.Patient_Images_Get(currentconsult!patient!fk_patient) 
   Pictures = currentconsult!images
   For Each HB In Scrollview1.Children
      HB.Delete
   Next
   For Each Selected_Picture In Pictures
      C = modGraphics.Blob_Convert_To_Picture(Selected_Picture!image)
      Pic = C!picture
      Selected_Picture!path = C!path
      With HB = New HBox(Scrollview1)
         .width = 100
         .background = Color.White
         .padding = 2 
      End With
      With PB = New PictureBox(HB) As "PictureBoxes"
         .Picture = Pic
         .Stretch = True 
         .Width = 100
         .tag = Selected_Picture
      End With
   Next
   Scrollview1.SetFocus()
End

Public Sub PictureBoxes_MouseUp()

   Dim pn As Collection 
   
   bExit = True
   Vbox_EditArea.Padding = 0
   Selected_Picture = Last.tag   
   Form_Magnify.Picture_Load(Last.tag!path)
   Try txtImageTag.text = Last.tag!tag
   For Each PN In currentconsult!progress_notes
      If PN!fk_consult = Last.tag!fk_consult Then
          PN!notes = Replace(PN!notes, "800", "25")
         PN!notes = Replace(Pn!notes, "600", "25")
         With NotesViewer
       
             PN!notes = modConsultDBI.Images_Get(PN!notes)
             .WebView1.HTML = PN!notes
            .lblHtmlViewerHeading.text = "Consult:" & Format(PN!consult_date, "dd/mm/yyyy") & " -  " & PN!title & " " & PN!firstname & " " & pn!surname
         End With
         Break
      End If
   Next
  bExit = False
End

Public Sub txtImageTag_Change()
  If bexit Then Return 
  Vbox_EditArea.padding = 1
   
End

Public Sub txtImageTag_LostFocus()
   
  Last.background = Color.White 
   
End

Public Sub txtImageTag_GotFocus()

   Last.BackGround = Color.rgb(95, 255, 175)

End

Public Sub Image_Display()
   
   Dim pn As Collection 
   Dim C As Collection
   
   bExit = True
   Vbox_EditArea.Padding = 0
   C = modGraphics.Blob_Convert_To_Picture(Selected_Picture!image)
 '  Pic = C!picture
   Selected_Picture!path = C!path
   Form_Magnify.Picture_Load(Selected_Picture!path)
   Try txtImageTag.text = Selected_Picture!tag
   For Each PN In currentconsult!progress_notes
      If PN!fk_consult = Selected_Picture!fk_consult Then
         PN!notes = Replace(PN!notes, "800", "25")
         PN!notes = Replace(Pn!notes, "600", "25")
         With NotesViewer
             PN!notes = modConsultDBI.Images_Get(PN!notes)
             .WebView1.HTML = PN!notes
            .lblHtmlViewerHeading.text = "Consult:" & Format(PN!consult_date, "dd/mm/yyyy") & " -  " & PN!title & " " & PN!firstname & " " & pn!surname
         End With
         Break
      End If
   Next
  bExit = False  
   
End
