' Gambas class file

' Copyright (C) 2008-2011 Dr. Richard Terry

' This program is free software: you can redistribute it and/or modify
' it under the terms of the GNU General Public License as published by
' the Free Software Foundation, either version 3 of the License, or
' (at your option) any later version.

' This program is distributed in the hope that it will be useful,
' but WITHOUT ANY WARRANTY; without even the implied warranty of
' MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
' GNU General Public License for more details.

' You should have received a copy of the GNU General Public License
' along with this program.  If not, see <http://www.gnu.org/licenses/>.
'-------------------------------------------------------------------------
' PURPOSE   An exerimental form to allow editing of consults data <> today
'-------------------------------------------------------------------------
Private bExit As Boolean
Private currentconsult As CConsult  
Private progressnote As Collection
Static Private form_editnotes As FEditNotes
Public Active_Editor As Object
Public Active_HBox As Object
Public Active_Webview As Object
Public fk_progressnote As Integer 
Public ProgressNotes_Keys As Integer[]  

Public ProgressNote_Before_Editing As String

Public Sub Adjust_Editor_Size()
   
   tlMeasure.text = "<P STYLE=\"background: #ffffff\"><FONT COLOR=\"#000000\">" & Active_Editor.teNotes.RichText & "</FONT></P>"
   
   Active_Editor.parent.height = tlMeasure.height + 50
   lcNotes.Refresh()
   
End

Public Sub Init(Cons As CConsult)
   
   currentconsult = Cons
   Load_Notes()
   form_editnotes = Me
   
End

Public Sub Load_Notes()
   '---------------------------------------------------------------------------
   'Loads the entire progress notes as individual lines into the list container
   '---------------------------------------------------------------------------   
   
   Dim NotesViewer As WebView
   Dim NotesEditor As TextEdit
   Dim sep As Separator
   Dim HB As HBox        'container to hold each days notes
   Dim tl As TextLabel
   Dim last_fk_consult As Integer
   Dim fk_consult As Integer
   Dim NotesBox As VBox
   Dim sNotesHtml As String
   Dim Editor As FEditor
   
   lcNotes.Clear()                                                      'clear the list container
   Wait
   Inc Application.Busy                                                 'notify 'work in progress' for some reasons this can be slow ?why FIXME
   ProgressNotes_Keys = New Integer[]
   currentconsult.Refresh("progress_notes")                             'ensure have latest data (e.g) this could be after a deletion
   tlMeasure.width = lcNotes.Width - 300                                'using tlMeasure to give us the editor height of the webview.
   For Each progressnote In currentconsult!progress_notes
      ProgressNotes_Keys.Add(progressnote!pk_progressnote) 
      '-------------------------------------------------------------------------
      'This is the 'container' stuck onto the list container
      'which contains all the other controls
      '1) the textlabel showing the data/drs details  'fixme not done
      '2) the notes_box - which contains initially a webview 
      '                   and a hidden editor form in case user wants to edit
      '                   This is BAD........ fixme to only put one in if needed
      '-------------------------------------------------------------------------
      With HB = New HBox(lcNotes)
         .width = lcNotes.Width
         .tag = progressnote
         .AutoResize = True
         .Padding = 1
         .Background = Color.White
      End With
      With tl = New TextLabel(HB) As "lcNotes_Date"
         .width = 120
         .Font.Bold = True   
         .Expand = False   
         .Background = Color.white
         If last_fk_consult <> progressnote!fk_consult Then
            .text = "<P STYLE=\"background: #ffffff\"><FONT COLOR=\"#000000\">" & Format(progressnote!consult_date, "dd/mm/yyyy") & "</FONT></P>"
            last_fk_consult = progressnote!fk_consult
         End If  
      End With 
      sNotesHtml = modConsultDBI.Images_Get(progressnote!notes)
      tlMeasure.text = "<P STYLE=\"background: #ffffff\"><FONT COLOR=\"#000000\">" & sNotesHtml & "</FONT></P>"
      With NotesBox = New VBox(HB)
         .Expand = True 
         .height = tlMeasure.Height + 50
      End With
      
      With NotesViewer = New Webview(NotesBox) As "WebView_Notes"
         .html = sNotesHtml
         ' .tag = progressnote 
         .Expand = True   
      End With
      With Editor = New FEditor(NotesBox)
         .Visible = False 
         .lblHeading.visible = False  
         .teNotes.RichText = sNotesHtml
         .Init("FEditNotes") 'init with the form's name see static stuff
         .Border = False  
      End With
   Next 
   Dec Application.Busy
   
End

Public Sub mnuEditNotes_Click()
   
   Dim sMsg As String
   
   Select Case Last.tag
      Case "edit"
         bExit = True 
         Edit() 
         bExit = False  
      Case "mark deleted"
         sMsg = "Deleting progress notes is quite a serious action and should never be undertaken lightly.\n\n"
         "A complete audit trail will be kept of your actions, and the progress not will not be actually "
         "removed from the database, just flagged as hidden.\n\n"
         "Should a medico-legal audit take place of this patients notes, the deleted notes will be visible to "
         "the audit, along with your name, the time the note was deleted, and the reason you gave.\n\n"
         " Are you sure you wish to do this?"
         Message.Title = "Deleting Progress Notes"
         Message.Question(sMsg, "Yes, Proceed and Delete the notes", "No")
         Wait
         Inc Application.Busy
         If modAudit.MakeAudit(currentconsult, "mark deleted", "clin_consult.progressnotes", fk_progressnote, const.cSection_GeneralNotes, "Progress Note") Then
            modDBConnect.update("clin_consult.progressnotes", Null, ["pk": fk_progressnote, "deleted": True])
            modDBConnect.CommitTrans()
         Else
            Dec Application.Busy 
            Message.Info("An unspecified error occurred and the record was not deleted") 
            Return 
         Endif
         Dec Application.Busy
         FClinical.Refresh_AllPreviousNotes()
         Load_Notes()
      Case "print"
   End Select 
   
End

Public Sub webview_Notes_Menu()
   
   Stop Event
   Active_Webview = Last
   mnuEditNotes.popup()
   
End

Public Sub WebView_Notes_dblClick()
   
   Active_Webview = Last
   Edit()   
   
End

Public Sub Edit()
   '-------------------------------------
   'FIXME:  THIS DOES NOT WORK AT ALL?WHY
   '-------------------------------------
   
   Dim hctrl As Control
   Dim args As New Variant[]
   
   args.Add("FEditNotes")
   args.Add(Me) 
   
   Active_Webview.Visible = False   
   Active_Editor = Active_Webview.parent.children[1]
   Active_Editor.Visible = True 
   Object.Call(Active_Editor, "init", args)
   ProgressNote_Before_Editing = Object.Call(Active_Editor, "Get_Copy_of_Editor_Richtext")
   Active_Editor.SetFocus()
   
End

Public Sub Settings_Save()
   
End

Public Sub Settings_Load()
   
End

Public Sub lcNotes_Click() 
   '-----------------------------------------------
   'User has clicked on a row of the progress notes
   'Set fk_progress note to the correct key 
   '-----------------------------------------------
   
   Dim Changed_Text As String
   
   If Bexit Then Return 
   Print "Last fk_progressnote=", fk_progressnote
   If Not IsNull(Active_Editor) Then    
      Changed_text = Object.Call(Active_Editor, "Get_Copy_of_Editor_RichText")
      
      If Changed_text <> ProgressNote_Before_Editing Then
         Stop Event
         '----------------------------------------------------------------------------------------------
         'Now, the fk_progress now is that of the last row clicked, not the one the user just clicked on
         '----------------------------------------------------------------------------------------------
         If Message.Question("Save changes?", "Yes", "No") = 1 And Active_Editor.parent.children[1].visible = True Then 
            Inc Application.Busy
            If modAudit.MakeAudit(currentconsult, "progress note edited", "clin_consult.progressnotes", fk_progressnote, const.cSection_GeneralNotes, "Progress Note") Then
               modDBConnect.update("clin_consult.progressnotes", Null, ["pk": fk_progressnote, "notes": Changed_text])
               modDBConnect.CommitTrans()
            Else
               Dec Application.Busy 
               Message.Info("An unspecified error occurred and the record was not deleted") 
               Return 
            Endif
            Dec Application.Busy
            Active_Editor.parent.children[0].html = Changed_text
         Else
            Active_Editor.parent.children[0].html = ProgressNote_Before_Editing
         End If  
      End If
      
      Active_Editor.parent.children[0].visible = True  
      Active_Editor.parent.children[1].visible = False 
      ProgressNote_Before_Editing = ""
      Active_Editor = Null
   End If
   Try Active_Webview = Last.Children[1].Children[1].Children[0]
   If Error Then
      
      Try Active_Webview = Last.Children[0].Children[1].Children[0]
   End If 
   fk_progressnote = ProgressNotes_Keys[Last.index]
   Print "next fk_progressNote:", fk_progressnote
   
End
