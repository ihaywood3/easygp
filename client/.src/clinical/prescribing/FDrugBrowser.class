' Gambas class file

Private brands As Collection
Private brand As Collection
Private Form_PDF As FPdf
Private generics As Collection
Private drug_forms As Collection
Private bKeyValid As Boolean
Private bExit As Boolean  
Private fk_form As Integer

Public Sub Form_Open()
   
   Init() 
   
End

Public Sub Form_Close()
   
   Settings_Save() 
   
End

Public Sub Settings_Save()
   
   '  Settings["Drugs/HSplit_EditArea.Layout"] = HSplit_EditArea.Layout
   Settings["Drugs/VSplit_DataEntry.Layout"] = VSplit_DataEntry.Layout
   Settings["Drugs/HSplit1.Layout"] = HSplit1.Layout
   Settings["Drugs/Form_PDF.Zoom"] = Form_PDF.CurrentZoom

End

Private Sub Settings_Load()
   
   '  Try HSplit_EditArea.Layout = Settings["Drugs/HSplit_EditArea.Layout"]
   Try VSplit_DataEntry.Layout = Settings["Drugs/VSplit_DataEntry.Layout"]
   Try HSplit1.Layout = Settings["Drugs/HSplit1.layout"]
   Try Form_PDF.CurrentZoom = Settings["Drugs/Form_PDF.Zoom"]
   
End

Public Sub Init()
   
   lblMeasure.text = " Occupation "
   modEditAreaHelpers.Resize_labels(Vbox_EditArea_Outer, lblMeasure)
   Try Settings_Load()
   With cvwDrugs
      .Columns.count = 5
   End With
   With Form_PDF = New (FPDF, VBox_PDF)
      .btZoomIn.Visible = True
      .btZoomOut.Visible = True
      .BtPrint.Visible = True  
      Try .Load_PDF(User.home &/ "Documents/alphamox.pdf")
   End With
   Reload()
   
End Sub

Public Sub Reload()
   
   brands = modPrescribingDBI.Brands_Get(Trim(txtSearch.text))
   Brands_Show()
   
End

Public Sub Brands_Show()
   
   Dim x As Integer
   
   cvwDrugs.Clear()
   
   For Each brand In brands
      cvwDrugs.Add(brand!pk_view, brand!brand)
      cvwDrugs[brand!pk_view][0] = brand!brand
      cvwDrugs[brand!pk_view][1] = brand!generic
      cvwDrugs[brand!pk_view][2] = brand!strength & " " & brand!form
   Next
   
End

Public Sub txtSearch_KeyRelease()
   
   Reload()
   
End

Public Sub cvwDrugs_Select()

   cvwDrugs.MoveCurrent
   txtBrand.text = brands[cvwDrugs.Item.key]!brand
   txtGeneric.text = brands[cvwDrugs.Item.key]!generic
   txtStrength.text = brands[cvwDrugs.Item.key]!strength
   txtForm.text = brands[cvwDrugs.Item.key]!form
   '  Print 
   
End

Public Sub EditArea_Notify_Data_Change(flag As Boolean)
   
   If flag Then
      Vbox_EditArea_Outer.Padding = 1
      Vbox_EditArea_Outer.Background = Color.red
      '  tbOk.Foreground = Color.Red
      
   Else
      Vbox_EditArea_Outer.Padding = 0
      Vbox_EditArea_Outer.Background = Color.white
      '  tbOk.Foreground = Color.black
   End If
   
End

Public Sub Drug_New()
   
   modEditAreaHelpers.EditArea_Clear(Vbox_EditArea_Outer)   
   EditArea_Notify_Data_Change(False)
 
   EditArea_TextBoxes_SetRead_Status(False)
   cvwDrugs.Clear()
   fk_form = 0
   txtBrand.SetFocus()
   
End

Public Sub EditArea_TextBoxes_SetRead_Status(bflag As Boolean)
   
   txtBrand.ReadOnly = bflag
   txtGeneric.ReadOnly = bflag   
   txtForm.ReadOnly = bflag
   txtStrength.ReadOnly = bflag  
   txtPackSize.ReadOnly = bflag  
   
End

Public Sub Drug_Forms_Get()
   
   Dim drug_form As Collection
   
    listview2.Clear()
    drug_forms = modPrescribingDBI.Formulations_Get(Trim(txtForm.text))  
    For Each drug_form In drug_forms
      listview2.Add(drug_forms.pk, drug_forms.form)
   Next
    If listview2.count Then
        listview2.Visible = True

    Endif 
   
End

Public Sub Save()
   '-----------------------------
   'Save a new user defined drug
   '-----------------------------   

   If Vbox_EditArea_Outer.padding = 0 Then Return 
   If Not Drug_Valid() Then Return 
   
   EditArea_TextBoxes_SetRead_Status(True)
   Reload()
   txtSearch.SetFocus
End

Public Function Drug_Valid() As Boolean
   '------------------------------------------
   'Returns true if adequate drug information
   '------------------------------------------
   
   Return True

End

Public Sub EditArea_Buttons_Click()
   
   Select Case Last.tag
      Case "new"
         Drug_New()
      Case "save"
         Save()
   End Select
   
End

Public Function EditAreaTextBox_ExcludeKeys(keycode As Integer, tag As String) As Boolean
   
   Select Case tag
      Case "pack size"
         bKeyValid = modUtil.AllowKeys(Const.AllowKeys_NumbersOnly, keycode)
      Case Else  
         bKeyValid = True  
   End Select  
   Return bKeyValid
   
End

Public Sub EditArea_TextBox_KeyPress()
   
   If Not EditAreaTextbox_ExcludeKeys(key.code, Last.tag) Then    'validate key input first
      Stop Event                                                  'no good? don't show key output
      Return
   End If
   Select Case Key.Code
      Case key.Down
         If listview2.Visible Then
            listview2.MoveFirst
            listview2.SetFocus()            
         End If 
      Case key.Return, key.Tab
   
      Select Case Last.tag
         Case "brand"
            txtGeneric.SetFocus()
         Case "generic"
            txtStrength.SetFocus()
         Case "strength"
            txtForm.SetFocus()
         Case "form"
            txtAmount.SetFocus()
         Case "packsize"
            txtPIFile.SetFocus()
      End Select
      
   End Select

End Sub

Public Sub listview2_KeyPress()
   
   If key.code = key.enter Then
      listview2_DblClick
   Endif
   
End Sub

Public Sub listview2_DblClick()
   
   listview2.MoveCurrent
   txtForm.text = drug_forms(listview2.Item.key)
   fk_form = listview2.Item.key 
   
End

Public Sub EditArea_TextBox_LosttFocus()
   
   Last.BackGround = Color.white
   
End

Public Sub EditArea_TextBox_GotFocus()
   
   Last.BackGround = Color.rgb(95, 255, 175)   
   Select Case Last.tag                         
         Case "form"
                              
         With listview2                        
            .top = Last.Parent.Parent.top
            .Left = Last.Parent.Left           
            .width = Last.width   
            .Visible = False                   
            .Raise                             
            End With                              
      End Select                                   
End  

Public Sub EditArea_TextBox_KeyRelease()
   
    
    Select Case Last.tag
       Case "form"
          Drug_Forms_Get()
    End Select
  
      

End


