' Gambas class file

' Copyright (C) 2008-2012 Dr. Richard Terry  rterry@pacific.net.au Dr. Ian Haywood

' This program is free software: you can redistribute it and/or modify
' it under the terms of the GNU General Public License as published by
' the Free Software Foundation, either version 3 of the License, or
' (at your option) any later version.

' This program is distributed in the hope that it will be useful,
' but WITHOUT ANY WARRANTY; without even the implied warranty of
' MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
' GNU General Public License for more details.

' You should have received a copy of the GNU General Public License
' along with this program.  If not, see <http://www.gnu.org/licenses/>.

Private pro As Process
Private host As String
Private prompt_waiting As Boolean
Private input_buf As String
Private jobs As Collection[]

Private Sub PrepareProcess()
  Dim prg As String
     
  If Not IsNull(pro) Then
    If pro.State <> Process.Running Then
       pro = Null
    Endif
  Endif
  If IsNull(pro) Then
     prg = modUtil.FindProgram("sftp", "ssh")
     If IsNull(prg) Then Return
     pro = Exec [prg, "-b", "-", host] For Read Write As "Sftp" 
     prompt_waiting = True
     input_buf = ""
     jobs.Add(["cmd": "start"])
  Endif
  
End

Public Sub _new(host1 As String)
   
  host = host1
  jobs = New Collection[]
  prompt_waiting = False 
  
End



Public Sub Sftp_Read()
   
   Dim pos As Integer
   
   input_buf &= Read #pro, Lof(pro)
   pos = InStr(input_buf, "sftp>")
   If pos >= 0 Then
      prompt_waiting = False
      input_buf = Right$(input_buf, - (pos + 5))
   Endif
   If Not prompt_waiting Then
      If jobs.Length > 0 Then
         jobs.Delete(0)
      Endif
      If jobs.Length > 0 Then
        ' StartJob()
      Endif
   Endif
End

Public Sub Sftp_Error(err As String)
   
  Log.DebugMsg("Sftp Process wrote to standard error:" & err)
  pro = Null 
   
End

Public Sub PutFile(local As String, remote As String)
   
  jobs.Add(["local": local, "remote": remote, "cmd": "put"])
  'If Not prompt_waiting Then StartJob()
   
End

Public Sub GetFile(remote As String)
   
   
   
End
