' Gambas class file

Private Views_addresses As Collection
Private pk_view As String 'compound key because view has multiple addreses, I could change this and call addreses as needed
Private pk_view_address As Integer
Private fk_category As Integer
Private fk_country As Integer
Private bKeyValid As Boolean
Private seach_delay As Integer
Private PersonPicture As Collection
Private bNewOrgContact As Integer
Private bNewPersonContact As Integer
Private iLastKeycode As Integer
Private iSaveYesNo As Integer
Private $TownResult As Result
Private bRefreshing As Boolean
Private bNewAddress As Boolean
Private bAddingOrgAddress As Boolean
Private bAddFamilyMember As Boolean
Private bList2HasFocus As Boolean
Private Const cStatusMsg_Info As Integer = 0 
Private Const cStatusMsg_Warning As Integer = 1 
Private bExit As Boolean 'fix me remove to a single flag later

Private bNewCommunication As Boolean
Private iAddNew As Integer              'true if adding new patient
Private patients As Collection

Private cTowns As Collection
Private isubsection As Integer
Private Const cNameSearch As Integer = 0
Private Const cFamilySearch As Integer = 1

Private arraySex As New String[]  'was 6
Private arraymarital As New String[] 'was 7
Private arrayAddressType As New String[]
Private arrayConctactType As New String[]

Private bDisplayingData As Boolean
Private currentdisplayedpersonspk As Integer
Private lastdisplayedpersonspk As Integer
Private Const cSection_Patients As Integer = 0 'these section
Private Const cSection_Persons As Integer = 1

Private pk_last_comm_deleted As Integer         'the primary key of the last key deleted in contacts.data_communications
Private iSection As Integer
Private iaddress As Integer
Private fk_organisation As Integer
Private fk_address As Integer
Private fk_image As Integer
Private fk_person As Integer
Private fk_patient As Integer
Private fk_occupation As Integer
Private fk_town As Integer
Private country_code As String
Private fk_language As Integer
Private fk_ethnicity As Integer
Private fk_next_of_kin As Integer
Private fk_family As Integer
Private fk_payer As Integer
Private rows_in_view As Collection 
Private row_in_view As Collection 'current row we are on
Private iCommunication As Integer
Private person As Collection 
Private patient As Collection 
Private address As Collection
Private addresses As Collection
Private views_comms As Collection
Private Comms As Collection
Private Comm As Collection
Private The_Collection As Collection
Private Member As Collection
Private FImport As FImportPatientsWizard
Private bEmbedded As Boolean
Private FHelp As FHtmlViewer

Public Sub set_embedded(flag As Boolean)
   
   bEmbedded = flag
   
End

Public Sub Set_Section(section As Integer)
   
   isection = section  '0 = patients = cSectionPatients 1 =cSectionStaff
   
End 

Public Sub Form_Open()
   
   Init()
   
End

Public Sub Form_Close()
   
   Settings_Save()
   
End

Public Sub Settings_Save()
   
   Settings["Contacts Patients/HSplit_EditArea"] = HSplit_EditArea.Layout
   Settings["Contacts Patients/VSplit_DataEntry"] = VSplit_DataEntry.Layout
   Settings["Contacts Patients/HSplit_Patients_MiniHelp"] = HSplit_Patients_MiniHelp.Layout
   Settings["Contacts Patients/FHelp_zoom"] = FHelp.WebView1.Zoom
   
End

Private Sub Settings_Load()
   
   Try HSplit_EditArea.Layout = Settings["Contacts Patients/HSplit_EditArea"]
   Try VSplit_DataEntry.Layout = Settings["Contacts Patients/VSplit_DataEntry"]
   Try HSplit_Patients_MiniHelp.Layout = Settings["Contacts Patients/HSplit_Patients_MiniHelp"]
   Try FHelp.WebView1.Zoom = Settings["Contacts Patients/FHelp_zoom", 1]
   
End

Public Sub Init()
   modEditAreaHelpers.Resize_labels(VBox_EditArea_Left, lblMeasure)
   FHelp = New FHtmlViewer(Vbox_Help)
   Try Settings_Load()
   Combos_Fill()
   bExit = True
   If iSection = cSection_Persons Then
      tbAddPerson.text = "New Person"
      tbAddFamilyMember.Visible = False
   End If
   bExit = False
   Person_New()
   cvwPersons.columns.Count = 9
   cvwContacts.Columns.count = 3
   cvwAddresses.Columns.count = 3
   lblMeasure.text = " Deceased "
   chkDeceased.width = txtOccupation.Width
End

Public Sub Combos_Fill()
   
   cmbSex.Add("Male", 0)
   cmbSex.Add("Female", 1)
   cmbSex.Add("Unknown", 2)
   cmbSex.Add("Transexual", 3)
   cmbSex.Add("Hermaphrodite", 4)
   arraysex.Resize(5)
   arraysex[0] = "M"
   arraysex[1] = "F"
   arraysex[2] = "U"
   arraysex[3] = "T"
   arraysex[4] = "H"
   
   cmbTitle.Add("Mr", 0)
   cmbTitle.Add("Mrs", 1)
   cmbTitle.Add("Master", 2)
   cmbTitle.Add("Miss", 3)
   cmbTitle.Add("Dr", 4)
   cmbTitle.Add("Prof", 5)
   cmbTitle.Add("Ms")
   
   cmbMarital.Add("Unknown", 0)
   cmbMarital.Add("Single", 1)
   cmbMarital.Add("Married", 2)
   cmbMarital.Add("Divorced", 3)
   cmbMarital.Add("Defacto", 4)
   cmbMarital.Add("Widow", 5)
   cmbMarital.Add("Widower", 6)
   
   arraymarital.Resize(7)
   arraymarital[0] = "U"
   arraymarital[1] = "S"
   arraymarital[2] = "M"
   arraymarital[3] = "D"
   arraymarital[4] = "F" 
   arraymarital[5] = "W" 
   arraymarital[6] = "WD" 
   
   cmbAddressType.Add("Home", 0)
   cmbAddressType.Add("Work", 1)
   cmbAddressType.Add("PO Box", 2)
   cmbAddressType.Add("Parents", 3)
   cmbAddressType.Add("Nursing Home", 4)
   cmbAddressType.Add("Refuge", 5)
   
   cmbCommunicationType.Add("At Home", 0)
   cmbCommunicationType.Add("At Work", 1)
   cmbCommunicationType.Add("Fax", 2)
   cmbCommunicationType.Add("Email", 3)
   cmbCommunicationType.Add("Mobile", 4)
   cmbCommunicationType.Add("VOIP", 5)
   cmbCommunicationType.Add("Web URL", 6)
   cmbCommunicationType.Add("Phone", 7)
   cmbCommunicationType.Add("Toll Free ", 8)
   
End

Public Sub txtSearch_Change()
   
   If bExit = True Then 
      Return
   End If
   
End

Public Sub DataInputArea_Visible(bflag As Boolean)
   
   VBox_EditArea.Visible = bflag 
   
End

Public Sub cvwPersons_DblClick()
   
   If cvwPersons.count = 0 Then Return
   If VBox_EditArea.Visible = False Then
      
      DataInputArea_Visible(True)
      
      cvwPersons_Select()
   End If  
   
End

Public Sub cvwPersons_Select()
   
   Person_Display()
   
End

Public Sub Persons_Find()
   
   Inc Application.Busy
   Timer1.stop()
   If Isection = cSection_Patients Then
      rows_in_view = modContactsDBI.Person_Get(Trim(txtSearch.text), const.contacttype_patient)
   Else
      rows_in_view = modContactsDBI.Person_Get(Trim(txtSearch.text), const.contacttype_person)
   End If
   
   Persons_List_Fill()
   Dec Application.Busy
   
End

Public Sub Persons_List_Fill()
   
   Dim iKey As Integer
   
   Dim comm As Collection
   Dim sTemp As String
   Dim sStatusMessage As String
   Dim person As Collection 
   Dim iLastperson_pk As Integer
   
   cvwPersons.Clear                           'clear current list persons
   views_comms = New Collection 
   If rows_in_view.count Then       
      Try rows_in_view.Remove("sql_in_english") 'ian included this for FClinical patient search     
      sStatusMessage = Str$(rows_in_view.count) & " records found for search criteria '" & Trim(txtSearch.text) & "'" 
      SetStatus("persons", sStatusMessage, False, 0)
      For Each row_in_view In rows_in_view
         
         cvwPersons.Add(row_in_view!pk_view, 0)
         
         If iLastperson_pk <> row_in_view!fk_person Then
            cvwPersons[row_in_view!pk_view][0] = row_in_view!surname
            cvwPersons[row_in_view!pk_view][1] = row_in_view!firstname 
            cvwPersons[row_in_view!pk_view][2] = row_in_view!sex       
            Try cvwPersons[row_in_view!pk_view][3] = Format(row_in_view!birthdate, "dd/mm/yyyy")
            iLastperson_pk = row_in_view!fk_person
         Else
            cvwPersons[row_in_view!pk_view][0] = ""
         End If
         cvwPersons[row_in_view!pk_view][5] = ""
         cvwPersons[row_in_view!pk_view][6] = row_in_view!street & " " & row_in_view!town & " " & row_in_view!postcode
         cvwPersons[row_in_view!pk_view][7] = ""
      Next
      cvwPersons.Enabled = True                       'enable list for clicking on 
   End If
   
End 

Public Sub Person_Picture_Clear()
   
   With PictureBox2
      .Picture = Picture.Load("icons/misc/no_photo.png")
      .tag = ""
      .Refresh()
   End With
   Wait        'otherwise, visually, picture won't disappear
   
End

Public Sub Person_Display()
   
   Dim bFoundPerson As Boolean
   Dim x As Integer
   
   If cvwPersons.Count = 0 Then Return  
   Check_For_Unsaved_Data()
   cvwPersons.MoveCurrent()
   pk_view = cvwPersons.Current.Key
   row_in_view = rows_in_view[cvwPersons.Current.Key]
   bExit = True  
   
   EditArea_Clear()   'clear the display fields and the patients picture
   
   fk_person = row_in_view!fk_person
   Try fk_patient = row_in_view!fk_patient 'missing if a person
   
   country_code = row_in_view!country_code
   Try fk_ethnicity = row_in_view!fk_ethnicity
   Try fk_language = row_in_view!fk_language
   Try fk_address = row_in_view!fk_address
   Try fk_next_of_kin = row_in_view!fk_next_of_kin
   Try fk_family = row_in_view!fk_family
   Try fk_occupation = row_in_view!fk_occupation
   Try fk_payer = row_in_view!fk_payer
   Try fk_image = row_in_view!fk_image
   Try fk_category = row_in_view!fk_category 'will not be in the patients view
   If Isection = cSection_Patients Then
      txtCategory.text = "Patient"
   Else   
      Try txtCategory.text = row_in_view!category 'will not be in the patients view
   End If 
   
   If iSection = cSection_Persons Then
      lblContactType.text = "Edit Existing Person's Details"
   Else
      lblContactType.text = "Edit Existing Patient's Details"
   End If
   lblPerson.text = row_in_view!title & " " & row_in_view!firstname & " " & row_in_view!surname
   txtSurname.text = row_in_view!surname
   txtFirstname.text = row_in_view!firstname
   Try txtBirthdate.text = Format(row_in_view!birthdate, "dd/mm/yyyy")
   If Not Error Then
       txtage.text = DateDiff(row_in_view!birthdate, Now, gb.Year)
   End If
   Try txtDateDeceased.text = Format(row_in_view!date_deceased, "dd/mm/yyyy")
   If row_in_view!deceased Then
      chkDeceased.value = True
   Else
      chkDeceased.Value = False  
   Endif
   txtSalutation.text = row_in_view!salutation
   txtCountry.text = row_in_view!country
   txtethnicity.text = row_in_view!ethnicity
   txtlanguage.text = row_in_view!language
   If row_in_view!language_problems = True Then
      chkLanguageProblems.value = True
   Else
      chkLanguageProblems.Value = False  
   Endif
   txtOccupation.text = row_in_view!occupation
   txtMemo.text = row_in_view!memo
   Try cmbMarital.index = row_in_view!fk_marital
   cmbTitle.Index = row_in_view!fk_title
   cmbSex.index = row_in_view!fk_sex 
   chkRetired.value = row_in_view!retired   
   Select Case row_in_view!atsi
      Case 0
         rbAboriginalityNone.value = True
      Case 1
         rbAboriginalityAboriginal.value = True
      Case 2
         rbAboriginalityTSI.value = True
   End Select
   
   cvwAddresses.Clear  
   address = New Collection
   addresses = New Collection
   Views_addresses = New Collection 
   
   For Each row_in_view In rows_in_view
      
      If Not IsNull(row_in_view!fk_address) Then
         Views_addresses.Add(row_in_view, row_in_view!fk_address)
         If row_in_view!fk_person = fk_person Then
            bFoundPerson = True  
            address = New Collection 
            address!fk_address = row_in_view!fk_address
            address!street = row_in_view!street
            address!postal_address = row_in_view!postal_address
            address!head_office = row_in_view!head_office
            address!country_code = row_in_view!country_code
            address!town = row_in_view!town
            address!fk_lu_address_type = row_in_view!fk_lu_address_type
            
            Try address!fk_town = row_in_view!fk_town
            address!state = row_in_view!state
            address!postcode = row_in_view!postcode
            addresses.Add(address, cvwAddresses.count)
            cvwAddresses.Add(cvwAddresses.count, address!street & " " & UCase(address!town) & " " & address!postcode)
         Else
            
            If bFoundPerson Then Break
         End If
      End If
   Next
   Communications_Reload()  'Finally show the communications in the list
   Communication_New()
   If fk_image Then
      Patient_Picture_Display()
   End If 
   tbSave.Enabled = True
   VBox_EditArea.Enabled = True  
   Notify_Data_Changed(False)
   Address_New() 'default to new address in case they type here
   bExit = False
   
End

Public Sub Patient_Picture_Display()
   
   Dim tempFile As String
   Dim tempPicture As Variant
   
   tempFile = Temp() & ".png"
   tempPicture = rows_in_view[pk_view]!image
   
   If tempPicture.data Then 
      File.Save(tempFile, tempPicture.data)
      PictureBox2.Picture = Picture.Load(Tempfile)
      PersonPicture = New Collection
      PersonPicture!fk_image = rows_in_view[pk_view]!fk_image
      PersonPicture!picture = PictureBox2.Picture
      PersonPicture!path = Tempfile
   End If
   
End

Public Sub EditArea_Clear()
   modEditAreaHelpers.EditArea_Clear(VBox_EditArea_Left)
   modEditAreaHelpers.EditArea_Clear(VBox_EditArea_Right)
   ' txtSurname.text = ""
   ' txtFirstname.text = ""
   ' txtBirthdate.text = ""
   ' txtSalutation.text = ""
   ' txtStreet1.text = ""
   ' txtStreet2.text = ""
   ' txtSuburb.text = ""
   ' txtPostcode.text = ""
   ' txtstate.Text = ""
   ' lblPerson.text = ""
   bExit = True  
   If isection = cSection_Patients Then
      txtCategory.text = "Patient"
      txtCategory.ReadOnly = True
   Else
      txtCategory.text = ""
   End If  
   
   ' txtEthnicity.text = ""
   ' txtCountry.text = ""
   ' txtLanguage.text = ""
   ' txtMemo.text = ""
   ' txtCommValue.text = ""
   ' txtAge.text = ""
   ' txtOccupation.text = ""
   ' txtCommNotes.text = ""
   tbnAddContact.text = "Add to list"
   tbnAddAddress.text = "Add to list"
   cvwAddresses.Clear
   cvwContacts.Clear   
   ' chkPostal.Value = False
   ' chkAddressPreferred.value = False
   ' chkCommunicationConfidential.Value = False
   ' chkCommunicationPreferred.Value = False
   rbAboriginalityNone.value = True 
 '  chkRetired.Value = False
   Notify_Data_Changed(False)
   pk_last_comm_deleted = 0
   listview1.Visible = False  
   listview2.Visible = False  
   Person_Picture_Clear()
   bExit = False
   
End

Public Function check_field_valid(ctrl As Textbox) As Boolean
   
   If ctrl.text = "" Then
      ctrl.SetFocus()
      Return False
   End If
   Return True
   
End

Public Function Valid_Data() As Boolean
   
   Dim sMsg As String 
   
   If Not check_field_valid(txtsurname) Then Return False               'always have a surname
   If Not check_field_valid(txtFirstname) Then Return False             'always have a firstname   
   If Not check_field_valid(txtCategory) Then Return False              'everyone must have a category
   If iSection = cSection_Patients Then                                
      If Not check_field_valid(txtBirthdate) Then 
         Return False                                                   'patients must have valid birthdate
      End If
   End If  
   
   If iSection = cSection_Persons Then                                  'insist on occupation for a person
      If Not check_field_valid(txtOccupation) Then
         Return False   
      End If
      If Trim(txtBirthdate.text) <> "" Then
         If Not check_field_valid(txtBirthdate) Then                    'not mandetory but must be valid if present
             Return False                                                 
         Endif
      End If
   End If
   If Trim(txtDateDeceased.text) <> "" Then
      If Not check_field_valid(txtDateDeceased) Then
        Return False
      Endif
   Endif
   Return True  
   
End

Public Sub Save()
   
   Dim Returned_collection As Collection
   Dim x As Integer 
   
   If Vbox_EditArea.Padding = 0 Then Return     'no padding = no data
   If Not Valid_Data() Then Return 
   
   If fk_town <> 0 Then 
      Address_Accept() 'if not already accepted
   End If
   For Each address In addresses
      address.Remove("type")
      address.Remove("town")
      address.Remove("state")
      address.Remove("postcode")
   Next
   
   If isection = cSection_Patients Then
      patient = New Collection 
      If fk_patient Then
         patient!fk_patient = fk_patient
      End If
      If rbAboriginalityNone.value = True Then
         patient!atsi = Const.aboriginality_none
      End If
      If rbAboriginalityAboriginal.value = True Then
         patient!atsi = Const.aboriginality_aboriginal
      End If
      If rbAboriginalityTSI.value = True Then
         patient!atsi = Const.aboriginality_Torres_Strait_Islander
      End If
   End If   
   
   person = New Collection 
   If fk_person <> 0 Then
      person!fk_person = fk_person
   End If
   person!firstname = Trim(txtFirstname.text)
   person!surname = Trim(txtSurname.text)
   person!salutation = Trim(txtSalutation.text)
   Try person!birthdate = Format(Val(txtBirthdate.text), "dd/mm/yyyy")
   person!fk_title = cmbTitle.index
   person!fk_sex = cmbSex.index
   person!fk_marital = cmbMarital.index
   If chkRetired.value Then
      person!retired = True
   Else
      person!retired = False 
   End If  
   If chkDeceased.value = True Then
       person!deceased = True
   Else
       person!deceased = False   
   Endif
  Try person!date_deceased = Format(Val(txtDateDeceased.text), "dd/mm/yyyy")

   person!memo = Trim(txtMemo.text)
   
   person!country_code = country_code
   person!fk_ethnicity = fk_ethnicity
   
   person!fk_occupation = fk_occupation
   If fk_occupation <> 0 Then  
      
      person!fk_occupation = fk_occupation
      Try person.Remove("occupation")
   Else
      
      If Not IsNull(rows_in_view) Then
         If rows_in_view[pk_view]!fk_occupation = 0 Or IsNull(rows_in_view[pk_view]!fk_occupation) Then 'the original data had no occupation
            person.Remove("fk_occupation")
            person!occupation = Trim(txtOccupation.text)
         Else
            
            If fk_occupation = 0 Then
               If Trim(txtOccupation.text) <> "" Then
                  person.Remove("fk_occupation")
                  person!occupation = Trim(txtOccupation.text)
               Else
                  person!fk_occupation = 0
               End If
            End If
         End If  
      End If   
   End If            
   
   If Isection = cSection_Persons Then
      '----------------------------------------------------------------
      'I've had stacks of problems with category saving for some reason
      'FIXME.1) Editing a record:
      '-----------------------------------------------------------------
      If Not IsNull(rows_in_view) Then
         If rows_in_view[pk_view]!fk_category = 0 Or IsNull(rows_in_view[pk_view]!fk_category) Then 'the original data had no occupation
            If fk_category = 0 Then 
               person.Remove("fk_category")
               person!category = Trim(txtCategory.text)
            Else
               person!fk_category = fk_category
            End If
         Else
            If fk_category = 0 Then
               If Trim(txtCategory.text) <> "" Then
                  person.Remove("fk_category")
                  person!category = Trim(txtCategory.text)
               Else
                  person!fk_category = 0
               End If
            Else
               person!fk_category = fk_category
            End If
         End If  
      Else
            If fk_category = 0 Then 
               person.Remove("fk_category")
               person!category = Trim(txtCategory.text)
            Else
               person!fk_category = fk_category
            End If
      End If   
   End If   
   
   person!fk_language = fk_language
   If chkLanguageProblems.value = True Then
      person!language_problems = True
   Else
     person!language_problems = False
   End If
 
   For Each comm In comms
      Try comm.Remove("comm_type")
   Next
   
   modDBConnect.BeginTrans()
   
   If PersonPicture!path Then
      person!fk_image = modContactsDBI.Image_Save(PersonPicture)
   End If  
   person!fk_person = modContactsDBI.Person_Save(rows_in_view, pk_view, person, comms, views_comms)
   modContactsDBI.Person_Addresses_Save(views_addresses, pk_view, addresses, person)
   
   If Isection = cSection_Patients Then
      patient!fk_person = person!fk_person
      patient!fk_patient = modContactsDBI.Patient_Save(rows_in_view, pk_view, patient) ', person, comms, views_comms)
   End If
   modDBConnect.CommitTrans()
   
   Notify_Data_Changed(False)
   
   If Isection = cSection_Patients Then
      
      If fk_patient > 0 And person.Exist("fk_image") Then
         If person!fk_image > 0 And If FClinical.IsSamePatient(fk_patient) Then
            FClinical.Patient_Picture_Refresh(personpicture!path)
            FClinical.Patient_Demographics_Refresh()
         End If
         
      End If
      
      rows_in_view = modContactsDBI.Patient_Get_Using_Pk(patient!fk_patient)
   Else
      
      rows_in_view = modContactsDBI.Person_Get_Using_PK(person!fk_person)
   End If   
   Persons_List_Fill()
   If cvwPersons.Count > 0 Then
      cvwPersons.MoveFirst
      cvwPersons.Item.Selected = True
      cvwPersons_Select()
   End If
   
End

Public Sub Reset_Gui()
   
   Check_For_Unsaved_Data()
   bExit = True
   lblContactType.text = ""
   EditArea_Clear() 
   
   tbSave.Picture = Picture.Load("icons/12/filesave.png")
   txtSearch.text = ""
   bDisplayingData = True
   bExit = False       
   isubsection = cNameSearch
   VBox_EditArea.Enabled = False  
   cvwPersons.Clear()
   txtSearch.SetFocus
   
End Sub 

Public Sub mnuAddressesPopup_Click()
   
   Select Case Last.tag
      Case "edit"
         Address_Edit()
      Case "new"
         Address_New()
      Case "delete"
         Address_Delete()
      Case "unlink"
         
   End Select 
   
End

Public Sub PopupPersonsMenu_Click()
   
   Select Case Last.tag
      Case "add address"
         Address_New
      Case "add contact"
      Case "add person"
         bAddFamilyMember = False
         Person_New()
      Case "add family member"
         bAddFamilyMember = True
         Person_New()
      Case "show family members"
         
         isubsection = cFamilySearch
         
      Case "link as next of kin"
      Case "select as next of kin"    
         
      Case "delete address"
         Address_Delete
      Case "delete person"
   End Select
   
End

Sub Address_Delete()
   
   Return 
   modDBConnect.BeginTrans()
   modContactsDBI.person_address_delete(fk_address)
   modDBConnect.CommitTrans()
   rows_in_view = modContactsDBI.Patient_Get_Using_Pk(fk_patient)
   Persons_List_Fill()
   cvwPersons.MoveFirst
   cvwPersons.Item.Selected = True
   cvwPersons_Select()
   
End

Public Sub Person_New()
   
   Dim keepaddress As Collection 
   Dim keepcomm As Collection
   Dim iFk_Family As Integer ' the family table pk
   Dim sSurname As String
   
   txtSearch.text = ""       
   cvwPersons.Clear()
   bExit = True
   
   If bAddFamilyMember Then 
      
   Else 
      
      EditArea_Clear()
      PersonPicture = New Collection 
      addresses = New Collection 
      Views_addresses = New Collection
      rows_in_view = Null
      Comms = New Collection
      pk_view_address = -1
      fk_category = 0
      fk_person = 0
      fk_address = 0
      fk_town = 0
      fk_patient = 0
      fk_image = 0
      fk_ethnicity = 0
      fk_country = 0
      country_code = ""
      iCommunication = 0
      pk_view = 0
      
      Address_New()       'res-sets variables for new address
   End If
   Communication_New()
   If iSection = cSection_Patients Then
      txtCategory.text = "Patient"
      rbAboriginalityNone.Value = True
      lblContactType.text = "New Patient"
   Else
      lblContactType.text = "New Person"
   End If  
   bExit = False  
   Vbox_EditArea.Enabled = True
   txtSurname.SetFocus() 
   
End

Public Sub Address_New()
   
   bExit = True
   bNewAddress = True
   txtStreet1.text = ""
   txtStreet2.Text = ""
   txtSuburb.text = ""
   txtPostcode.text = ""
 '  txtstate.text = ""
   address = New Collection 
   chkPostal.value = False
   chkAddressPreferred.Value = False  
   If iSection = cSection_Patients Then   
      cmbAddressType.Index = Const.AddressType_Home
   Else
      cmbAddressType.Index = const.AddressType_Work
   End If
   
   iAddress = cvwaddresses.count
   fk_town = 0
   bExit = False
   
   tbnAddAddress.text = "Add to list"
   tbnAddAddress.Foreground = Color.Black
   
End

Public Function Display_Mode(searchtext As String) As String
   
End

Public Sub cvwAddresses_Click()
   
End

Public Function Address_Valid() As Boolean
   
   If Trim(txtStreet1.text) = "" Then
      If fk_town = 0 Then
         txtSuburb.text = ""
      End If
      txtStreet1.SetFocus()
      Return False
   End If
   If fk_town = 0 Then
      txtSuburb.text = ""
      txtSuburb.SetFocus()
      Return False
   End If
   Return True
   
End

Public Sub Address_Accept()
   
   Dim sMsg As String           'used to show message on status bar as to what we are doing
   Dim i As Integer             'used as a loop counter in this routine
   Dim iCurrentRow As Integer   'keep to allow moving back to this row after update
   
   If Not Address_Valid() Then Return
   
   If bNewaddress Then
      
      address = New Collection  
      cvwAddresses.Add(iAddress, cmbAddressType.text & ": " & txtStreet1.text & " " & txtSuburb.text)                     
      address!fk_lu_address_type = cmbAddressType.Index
      address!type = cmbAddressType.Text           'kept for display purposes
      address!street = Trim(txtStreet1.text)
      address!fk_town = fk_town
      address!country_code = "AU"
      address!town = Trim(txtsuburb.text)
      address!state = Trim(txtState.text)
      address!postcode = Trim(txtPostcode.text)
      If chkPostal.value = True Then
         address!postal_address = True
      End If   
      If chkAddressPreferred.value = True Then
         address!preferred_address = True
      End If
      addresses.Add(address, iAddress)
   Else 
      
      addresses[iAddress]!fk_lu_address_type = cmbAddressType.Index
      addresses[iAddress]!type = cmbAddressType.text
      addresses[iAddress]!street = Trim(txtStreet1.text)
      addresses[iAddress]!fk_town = fk_town
      addresses[iAddress]!country_code = "AU"
      addresses[iAddress]!town = Trim(txtsuburb.text)
      addresses[iAddress]!state = Trim(txtState.text)
      addresses[iAddress]!postcode = Trim(txtPostcode.text)
      If chkPostal.value = True Then
         addresses[iAddress]!postal_address = True
      End If   
      If chkAddressPreferred.value = True Then
         addresses[iAddress]!preferred_address = True
      End If
      
      Addresses_FillList()
   End If
   
   Address_New()
   txtStreet1.SetFocus()
   
End

Public Sub Addresses_FillList()
   
   Dim address As Collection
   
   If IsNull(Addresses) Then Return 
   cvwAddresses.Clear()
   If Addresses.count Then            
      For Each address In Addresses
         cvwAddresses.Add(cvwAddresses.count, address!type & ": " & address!street & " " & address!town)                     
      Next
   End If 
   
End

Public Sub Address_Edit()
   
   bExit = True
   bNewAddress = False  
   cvwAddresses.MoveCurrent
   iAddress = cvwAddresses.Item.Key
   address = addresses[iAddress]
   Try fk_address = address!fk_address 'FIXME make sure this is ok to do
   txtStreet1.text = addresses[iAddress]!street
   txtsuburb.text = addresses[iAddress]!town
   Try fk_town = addresses[iAddress]!fk_town
   txtState.text = addresses[iAddress]!state
   txtPostcode.text = addresses[iAddress]!postcode
   Try cmbAddressType.index = addresses[iAddress]!fk_lu_address_type
   If addresses[iAddress]!preferred_address = True Then
      chkAddressPreferred.Value = True
   Else
      chkAddressPreferred.Value = False
   End If
   If addresses[iAddress]!postal_address = True Then
      chkPostal.value = True
   Else
      chkPostal.value = False
   End If
   tbnAddAddress.text = "Save modifications to list"
   cvwAddresses.SelectAll(False)
   txtStreet1.SetFocus()
   bExit = False
   
End

Public Sub cvwAddresses_Menu()
   
   If cvwAddresses.Count Then 
      mnuAddressesPopup.Popup
   End If
   
End

Public Sub Form_KeyPress()
   
   Select Case key.Code
      Case key.F12
         Save()
      Case key.Esc
         Reset_Gui()
         
   End Select 
   
End

Public Sub cvwPersons_Menu()
   
End

Public Sub popupMnuContacts_Click()
   
   Select Case Last.tag
      Case "add"
         Communication_New()
         txtCommValue.SetFocus()
      Case "edit"
         Communication_Edit()
      Case "delete"
         Communication_Delete()
      Case "undelete"
         Communication_UnDelete()
   End Select
   
End

Public Sub cvwContacts_Menu()
   
   If cvwContacts.Count = 0 Then                  'no contacts in list
      popupMnuContacts_add.Enabled = True         'allow add new or undo if appropriate
      If pk_last_comm_deleted <> 0 Then popupMnuContacts_UnDelete.Enabled = True
      popupMnuContacts_Edit.Enabled = False       'no items to edit
      popupMnuContacts_Delete.Enabled = False     'no items to delete
   Else
      popupMnuContacts_Edit.Enabled = True 
      popupMnuContacts_Delete.Enabled = True 
   End If   
   popupMnuContacts.Popup
   
End

Sub SetStatus(section As String, statustext As String, bOff As Boolean, message_severity As String)
   
End

Public Sub tbAddFamilyMember_Click()
   
End

Public Sub ListView2_DblClick()
   
   Select Case Last.Tag.tag
      Case "country"
         Country_Selection("accept", "list")
      Case "language"
         Language_Selection("accept", "list")
      Case "ethnicity"
         Ethnicity_Selection("accept", "list")
   End Select
   listView2.visible = False
   
End

Public Sub ListView1_DblClick()
   
   Select Case Last.Tag.tag
      Case "category"
         Category_Selection("accept", "list")
      Case "occupation"
         occupation_selection("accept", "list")
      Case "firstname" 
         Firstname_Selection("accept", "list")
      Case "surnames"
         Surname_Selection()
      Case "suburb"
         Suburb_Selection("accept", "list")
   End Select
   listView1.visible = False
   
End

Public Sub ListView1_KeyPress()
   
   If Key.Code = Key.RETURN Then 
      ListView1_DblClick()
   End If
   
End

Public Sub ListView2_KeyPress()
   
   If Key.Code = Key.RETURN Then 
      ListView2_DblClick()
   End If
   
End

Public Sub toolbar_enable()
   
End

Public Sub txtSearch_KeyRelease()
   
   If pk_view Then
      pk_view = 0                      'no row is now actively selected
      cvwPersons.SelectAll(False)      'remove marquee from list of persons
      EditArea_Clear()                 'visually clear the screen
      Vbox_EditArea.Enabled = False    'user can't click in the edit area
   End If
   Select Case Last.tag
      Case "search text"
         Timer1.start()
   End Select   
   
End

Public Sub Timer1_Timer()
   
   Persons_Find()
   
End

Public Function EditArea_TextBox_ExcludeKeys(keycode As Integer) As Boolean
   
   Select Case Last.Tag
      Case "birthdate"
         bKeyValid = modUtil.AllowKeys(const.AllowKeys_DateFormat, keycode)
      Case Else
         bKeyValid = True
   End Select
   Return bKeyValid
   
End

Public Sub EditArea_TextBox_Change()
   
   If bexit Then Return 
   Select Case Last.tag
      Case "category"
         If Trim(Last.text) = "" Then 
            fk_category = 0
            listview2.Visible = False  
         End If
      Case "language"
         If Trim(Last.text) = "" Then 
            fk_language = 0
            listview2.Visible = False  
         End If
      Case "country"
         If Trim(Last.text) = "" Then 
            fk_country = 0
            country_code = ""
            listview2.Visible = False  
         End If
      Case "ethnicity"
         If Trim(Last.text) = "" Then 
            fk_ethnicity = 0
            listview2.Visible = False  
         End If
      Case "street", "street1"
         tbnAddAddress.Foreground = Color.Red        
      Case "suburb"
         
         If Trim(txtSuburb.text) = "" Then  
            txtState.Text = ""
            txtPostcode.text = ""
            fk_town = 0
            listview1.Visible = False  
            tbnAddAddress.Foreground = Color.Red
         End If
      Case "memo"
         If InStr(Last.text, "\n\n") Then 
            txtMemo.text = Replace(txtMemo.text, "\n", "")
            cmbCommunicationType.SetFocus()
         End If
      Case "comm value"
         If InStr(Last.text, "@") Then 
            cmbCommunicationType.index = const.CommModalityEmail
         Else If Left$(Trim(Last.text), 2) = "04" Then 'fix me put in the rest
            cmbCommunicationType.index = const.CommModalityMobile
         Else If InStr(Last.text, "www") Or InStr(Last.text, "http://") Then 
            cmbCommunicationType.index = const.CommModalityWeb
         Else If InStr(Last.text, "1800") Then
            cmbCommunicationType.index = Const.CommModalityTollFree
         End If
         If InStr(Lower(Last.text), "f") Then
            If cmbCommunicationType.text <> "Fax" Then
               cmbCommunicationType.index = cmbCommunicationType.Find("Fax")
            End If
            bExit = True
            Last.text = Trim(Replace(Last.text, "f", ""))
            bExit = False
         End If
         tbnAddContact.Foreground = Color.red
      Case "comm notes"
         tbnAddContact.Foreground = Color.red
      Case "birthdate"
         If txtBirthdate.text <> "" Then
            Try txtAge.text = DateDiff(Val((Trim(txtBirthdate.text))), Now, gb.Year)
         Else
            txtAge.text = ""
         End If
   End Select
   
   Notify_Data_Changed(True)
   
End

Public Sub EditArea_TextBox_KeyRelease()
   
   If bexit Then Return 
   Select Case Last.tag
      Case "surname"
         Surname_Duplicates_Selection("get")
      Case "firstname" 
         Firstname_Selection("get")
      Case "occupation"
         Occupation_Selection("get")
      Case "suburb"
         Suburb_Selection("get")
      Case "category"
         Category_Selection("get")
      Case "country"
         Country_Selection("get")
      Case "ethnicity"
         Ethnicity_Selection("get")
      Case "language"
         Language_Selection("get") 
   End Select  
   
End

Public Sub EditArea_TextBox_KeyPress()
   
   If bExit Then Return
   
   If Not EditArea_TextBox_ExcludeKeys(key.code) Then
      Stop Event
      Return
   End If
   Select Case key.Code
      Case key.Return, key.Tab
         Select Case Last.tag
            Case "surname"
               cmbTitle.Setfocus()
            Case "firstname"
               Firstname_Selection("accept", "textbox")
            Case "salutation"
               cmbMarital.SetFocus()
            Case "birthdate"
               txtOccupation.SetFocus()
            Case "occupation"
               Occupation_Selection("accept", "textbox")
            Case "category"
               Category_Selection("accept", "textbox")   
            Case "street1"
               
               If Trim(Last.text) = "" Then
                  cmbCommunicationType.SetFocus()
               Else
                  txtSuburb.SetFocus()
               End If
            Case "street2"
               txtSuburb.SetFocus
            Case "suburb"
               
               tbnAddAddress.SetFocus()
            Case "country"
               Country_Selection("accept", "textbox")
            Case "ethnicity"
               Ethnicity_Selection("accept", "textbox")
            Case "language"
               Language_Selection("accept", "textbox")
            Case "memo"
               cmbCommunicationType.SetFocus()
            Case "comm value"
               txtCommNotes.SetFocus()
            Case "comm notes"
               tbnAddContact.SetFocus()
         End Select
         
      Case Key.Down
         Select Case Last.tag
            Case "occupation", "firstname", "suburb", "category", "surname"
               If listview1.Visible Then
                  listview1.SetFocus
                  listview1.MoveFirst
                  listview1.Item.Selected = True
               End If
            Case "country", "ethnicity", "language"
               If listview2.Visible Then
                  listview2.SetFocus
                  listview2.MoveFirst
                  listview2.Item.Selected = True
               End If
               
         End Select
   End Select
   
End

Public Sub EditArea_TextBox_GotFocus()
   
   Last.BackGround = Color.rgb(95, 255, 175)
   With listview1 
      .top = Last.Parent.top + Last.Parent.height
      .left = Last.left + VBox_EditArea_Left.Padding
      .width = 200 'just a guess
      .Clear
      .Visible = False   
   End With
   With listview2 
      .top = Last.Parent.top + Last.Parent.height
      .left = Last.left + VBox_EditArea_Right.Padding
      .width = 200 'just a guess
      .Clear()
      .Visible = False   
   End With
   
End

Public Sub EditArea_TextBox_LostFocus()
   
   Last.BackGround = Color.White
   Select Case Last.tag
      Case "birthdate", "date deceased"
         If Not IsDate(Last.text) Then
            Last.text = ""
         End If
   End Select
   
   Try Last.pos = 0
   
End

Public Sub Patient_Picture_Import()
   
   Dim filepath As String 
   Dim sMsg As String 
   
   Dialog.Title = "Select Image File"
   Dialog.Filter = ["*.png", "Image Files", "*", "All files"]
   
   If Dialog.OpenFile() Then Return
   Try PictureBox2.picture = Picture.Load(Dialog.Path) 
   If Error Then
      sMsg = "An error occurred the file couldn't be loaded.\n\n"
      sMsg &= "Filename:" & Dialog.Path & "\n\n"
      sMsg &= "Perhaps it was not a valid picture file?"
      Message.Info(sMsg)
      Person_Picture_Clear()
      Return
   End If 
   Try PictureBox2.tag = Dialog.Path
   PersonPicture = New Collection
   PersonPicture!path = Dialog.Path
   PersonPicture!picture = Picturebox2.picture
   Notify_Data_Changed(True)
   
End

Public Sub Notify_Data_Changed(flag As Boolean)
   
   If flag Then  
      Vbox_EditArea.Padding = 1  
      tbSave.Foreground = Color.Red  
   Else
      Vbox_EditArea.Padding = 0  
      tbSave.Foreground = Color.Black 
   End If
   
End

Public Sub EditArea_Buttons_Click()
   
   Select Case Last.tag
      Case "accept address"
         Address_Accept()
      Case "new address"
         Address_New()
         txtStreet1.SetFocus()
      Case "accept communication"
         Communication_Accept()
      Case "new communication"
         Communication_New() 
         txtCommValue.SetFocus()
      Case "load photo"
         Patient_Picture_Import()
      Case "acquire photo"
      Case "remove photo"   
         Person_Picture_Clear()
         
         If fk_image Then
            PersonPicture!path = "icons/misc/no_photo.png"
            PersonPicture!picture = Picturebox2.picture 
            Notify_Data_Changed(True)
         End If  
      Case "export"
      Case "reset"
         Reset_Gui()
      Case "save"
         Save()
      Case "new person"
         Person_New()
      Case "new family member"
         
   End Select
   
End

Public Sub Communication_Edit()
   
   If cvwContacts.Count = 0 Then Return
   bExit = True 'stop triggering a popup list on the textboxes
   bNewCommunication = False 'must be existing or not saved if clicking on it
   
   txtcommValue.text = Comms[iCommunication]!value
   txtcommnotes.text = Comms[iCommunication]!note
   cmbCommunicationType.index = Comms[iCommunication]!fk_lu_address_type
   chkCommunicationConfidential.value = Comms[iCommunication]!confidential
   chkCommunicationpreferred.Value = Comms[iCommunication]!preferred_method
   tbnAddContact.text = "Save modifications to list"
   bExit = False
   
End

Public Sub Communication_UnDelete()
   
   modContactsDBI.Communication_UnDelete(pk_last_comm_deleted)
   modDBConnect.CommitTrans()
   popupMnuContacts_UnDelete.Enabled = False 
   pk_last_comm_deleted = 0
   Communications_Reload() 
   
End

Public Sub Communication_Delete()
   
   Message.Title = "Delete contact method"
   If Message.Question("Confirm delete\n\n" & comm!type & ": " & comm!value, "Yes", "No") = 1 Then 
      comm!deleted = True  
      Try modDBConnect.update("contacts.data_communications", views_comms[comm!pk], comm, "pk")
      If Not Error Then
         modDBConnect.CommitTrans()
         popupMnuContacts_UnDelete.Enabled = True  
         pk_last_comm_deleted = comm!pk
         Communications_Reload()
      End If   
   End If
   
End

Public Sub Communications_Reload()
   
   views_comms = modContactsDBI.person_comms_get(fk_person)
   comms = New Collection 
   For Each Member In views_comms
      comm = New Collection 
      comm!type = Member!type
      comm!value = Member!value
      comm!note = Member!note
      comm!pk = Member!pk
      comm!preferred_method = Member!preferred_method
      comm!confidential = Member!confidential
      comm!fk_type = Member!fk_type
      comm!type = Member!type
      comms.Add(comm, comms.count)
   Next 
   Communications_FillList()
   
End

Public Sub Communication_New()
   
   bExit = True
   iCommunication = cvwContacts.Count 'if 3, then this is 0,1,2 so 3 will be new
   txtCommValue.text = ""
   txtCommNotes.text = ""
   If iSection = cSection_Patients Then   
      cmbCommunicationType.index = Const.CommModalityHome
   Else
      cmbCommunicationType.index = Const.CommModalityPhone
   End If
   chkCommunicationConfidential.Value = False
   chkCommunicationPreferred.Value = False
   bNewCommunication = True
   txtCommValue.enabled = True
   txtCommNotes.enabled = True
   chkCommunicationConfidential.Enabled = True
   chkCommunicationPreferred.Enabled = True
   comm = New Collection 
   tbnAddContact.text = "Add to list"
   tbnAddContact.Foreground = Color.black
   
   bExit = False
   
End

Public Sub Communication_Accept()
   
   Dim sMsg As String           'used to show message on status bar as to what we are doing
   Dim i As Integer             'used as a loop counter in this routine
   Dim iCurrentRow As Integer   'keep to allow moving back to this row after update
   
   If Trim(txtCommValue.Text) = "" Then 
      
      txtCommValue.SetFocus
      sMsg = "Hint: Contacts must consist of at least one value eg phone number, email address etc"
      SetStatus("Contacts", sMsg, False, const.cStatusMsg_Info)
      Return
   End If
   
   If bNewCommunication = True Then
      
      comm = New Collection       
      cvwContacts.Add(iCommunication, 0)   
      cvwContacts[iCommunication][0] = cmbCommunicationType.text
      cvwContacts[iCommunication][1] = txtCommValue.text
      cvwContacts[iCommunication][2] = txtCommNotes.Text
      Comm!fk_type = cmbCommunicationType.Index
      Comm!type = cmbCommunicationType.text 'need this for display
      Comm!value = txtCommValue.Text
      Comm!note = txtCommNotes.Text
      If chkCommunicationPreferred.value Then
         Comm!preferred_method = True
      Else
         Comm!preferred_method = False
      End If  
      If chkCommunicationConfidential.Value Then
         Comm!confidential = True
      Else
         Comm!confidential = False
      End If  
      Comms.Add(Comm, iCommunication)
   Else 
      
      Comms[iCommunication]!value = txtCommValue.Text
      Comms[iCommunication]!note = txtCommNotes.Text
      
      If chkcommunicationpreferred.value Then
         Comms[iCommunication]!preferred_method = True
      Else
         Comms[iCommunication]!preferred_method = False
      End If  
      If chkCommunicationConfidential.Value Then
         Comms[iCommunication]!confidential = True
      Else
         Comms[iCommunication]!confidential = False
      End If  
      Comms[iCommunication]!fk_type = cmbCommunicationType.index
      Comms[iCommunication]!type = cmbCommunicationType.text
      
      Communications_FillList()
   End If
   
   Communication_New()
   txtCommValue.SetFocus
   
End

Public Sub Communications_FillList()
   
   Dim comm As Collection
   Dim x As Integer
   
   If IsNull(Comms) Then Return 
   cvwContacts.Clear()
   If comms.count Then            
      For Each Comm In comms
         x = cvwContacts.Count
         cvwContacts.Add(x, 0)
         cvwContacts[x][0] = comm!type
         cvwContacts[x][1] = comm!value 
         cvwContacts[x][2] = comm!note
      Next
   End If 
   
End

Public Sub EditArea_CheckBox_KeyPress()
   
   Select Case key.Code
      Case key.return, key.tab
         Select Case Last.tag
            Case "postal address"
               
            Case "preferred address"
               
            Case "retired"
               txtStreet1.SetFocus()         
            Case "comm confidential"
               tbnAddContact.SetFocus()
            Case "comm preferred"
               chkCommunicationConfidential.SetFocus()
         End Select
   End Select 
   
End

Public Sub EditArea_CheckBox_Click()
   
   If bExit Then Return
   
   Select Case Last.tag
      Case "communication confidential"
         tbnAddContact.Foreground = Color.red
      Case "communication preferred"
         tbnAddContact.Foreground = Color.red
   End Select
   Notify_Data_Changed(True)
   
End

Public Sub EditArea_Combo_KeyPress()
   
   If bExit Then Return 
   Select Case key.Code
      Case key.return, key.tab
         Select Case Last.tag  
            Case "sex"
               txtSalutation.SetFocus()
            Case "title"
               txtFirstname.SetFocus()
            Case "marital"
               txtBirthdate.SetFocus()
            Case "address type"
            Case "comm type"
               txtCommValue.SetFocus
               
         End Select
   End Select
   
End

Public Sub EditArea_Combo_Click()
   
   If bExit Then Return 
   Notify_Data_Changed(True)
   
End

Public Sub Category_Selection(action As String, Optional calling_control As String)
   
   Dim x As Integer
   
   Select Case action
      Case "get"
         
         listview1.Visible = False  
         If Trim$(txtCategory.text) = "" Then Return 
         The_Collection = modContactsDBI.Get_Category(Lower(Trim$(txtCategory.text)))
         listview1.Clear
         
         If The_Collection.count Then 
            For Each Member In The_Collection
               listview1.Add(Member!pk, Member!category)
            Next 
            listview1.Visible = True
            listview1.Raise
            listview1.tag = txtCategory
            Return 
         End If
         listview1.Visible = False  
      Case "accept"
         fk_category = 0
         bExit = True
         If calling_control = "textbox" Then
            
            If listview1.Visible Then
               listview1.MoveFirst
               For x = 0 To listview1.count - 1
                  If Lower(listview1.Item.text) = Trim(Lower(txtCategory.text)) Then
                     fk_category = listview1.Item.Key
                     Break
                  End If
                  listview1.MoveNext()
               Next
            End If
         Else
            If listview1.Visible Then
               listview1.MoveCurrent   'set internal cursor to match marquee
               fk_category = listview1.Item.key
               txtCategory.Text = listview1.Item.Text
            End If
         End If
         listview1.Visible = False  
         bExit = False
         txtStreet1.SetFocus()
   End Select
   
End

Public Sub Firstname_Selection(action As String, Optional calling_control As String)
   
   Dim x As Integer
   
   Select Case action
      Case "get"
         If Trim(txtFirstname.text) = "" Then Return 
         The_Collection = modContactsDBI.Firstname_Get(Trim(txtFirstname.text))
         listview1.Clear
         
         If The_Collection.count Then 
            For Each Member In The_Collection
               listview1.Add(Member!pk, Member!firstname)
            Next 
            If The_Collection.count = 1 Then 
               If Trim(Lower(txtFirstname.text)) = Lower(Member!firstname) Then
                  Firstname_Selection("select", "list")
                  Return
               End If
            End If
            listview1.Visible = True
            listview1.Raise
            listview1.tag = txtFirstname
            Return 
            
         Else
            
         End If
         listview1.Visible = False  
      Case "accept"
         
         bExit = True
         If calling_control = "textbox" Then
            
            If listview1.Visible Then
               listview1.MoveFirst
               For x = 0 To listview1.count - 1
                  If Lower(listview1.Item.text) = Trim(Lower(txtFirstname.text)) Then
                     listview1.Visible = False  
                     Break
                  End If
               Next
            End If
            
         Else
            
            If listview1.Visible Then
               listview1.MoveCurrent   'set internal cursor to match marquee
               txtFirstname.Text = listview1.Item.Text
            End If
         End If
         listview1.Visible = False  
         cmbsex.SetFocus
         bExit = False  
   End Select
   
End

Public Sub surname_Selection(action As String, Optional calling_control As String)
   
   cmbTitle.SetFocus()
   
End

Public Sub Occupation_Selection(action As String, Optional calling_control As String)
   
   Dim x As Integer
   
   Select Case action
      Case "get"
         
         If Len(Trim(txtOccupation.text)) = 0 Then
            fk_occupation = 0
            Return
         End If
         The_Collection = modContactsDBI.Occupation_Get(Trim(txtOccupation.text))
         listview1.Clear
         
         If The_Collection.count Then 
            For Each Member In The_Collection
               listview1.Add(Member!pk, Member!occupation)
            Next 
            If The_Collection.count = 1 Then 
               If Trim(Lower(txtOccupation.text)) = Lower(Member!occupation) Then
                  Occupation_Selection("select", "list")
                  Return
               End If
            End If
            listview1.Visible = True
            listview1.Raise
            listview1.tag = txtOccupation
         Else
            listview1.Visible = False  
         End If
         
      Case "accept"
         
         bExit = True
         If calling_control = "textbox" Then
            fk_occupation = 0 
            If listview1.Visible Then
               listview1.MoveFirst
               For x = 0 To listview1.count - 1
                  If Lower(listview1.Item.text) = Trim(Lower(txtOccupation.text)) Then
                     fk_occupation = listview1.Item.Key
                     Break
                  End If
                  listview1.MoveNext()
               Next
            End If
            listview1.Visible = False     
         Else
            
            If listview1.Visible Then
               listview1.MoveCurrent   'set internal cursor to match marquee
               fk_occupation = listview1.Item.key
               txtOccupation.Text = listview1.Item.Text
            End If
         End If
         If Isection = cSection_Patients Then
            txtStreet1.SetFocus
         Else
            txtCategory.SetFocus()
         End If  
         
         bExit = False  
   End Select
   
End

Public Sub Suburb_Selection(action As String, Optional calling_control As String) 
   
   Dim iMatched As Boolean
   Dim x As Integer
   
   Select Case action
      Case "get"
         
         If Trim$(txtSuburb.text) = "" Then Return
         listview1.Visible = False  
         The_Collection = modContactsDBI.Get_Town(Lower(Trim$(txtSuburb.text)))
         listview1.Clear
         If The_Collection.count Then 
            For Each Member In The_Collection
               listview1.Add(Member!pk, Member!town & " " & Member!state & " " & Member!postcode)
            Next 
            If The_Collection.count = 1 Then 
               Suburb_Selection("accept")
            Else 
               listview1.Visible = True
               listview1.Raise
               listview1.tag = txtSuburb
            End If
         Else
            listview1.Visible = False  
         End If
      Case "accept"
         
         bExit = True
         If calling_control = "textbox" Then
            
            If listview1.Visible Then
               listview1.MoveFirst
               For x = 0 To listview1.count - 1
                  If InStr(Lower(listview1.Item.text), Trim(Lower(txtsuburb.text))) Then
                     
                     iMatched = True 
                     Break
                  End If
               Next
               If Not iMatched Then
                  listview1.Visible = False
                  txtSuburb.SetFocus()
                  fk_town = 0
                  Return 'no match found for suburb user typed in 
               End If 
            End If
         Else
            
            If listview1.Visible Then
               
               listview1.MoveCurrent()             'match internal cursor to marquee
            End If
         End If
         
         txtSuburb.text = The_Collection[listview1.Item.key]!town
         txtState.text = The_Collection[listview1.Item.key]!state 
         txtPostcode.text = The_Collection[listview1.Item.key]!postcode
         fk_town = The_Collection[listview1.Item.key]!pk
         tbnAddAddress.SetFocus()
         listview1.Visible = False  
         bExit = False  
   End Select
   
End

Public Sub Country_Selection(action As String, Optional calling_control As String) 
   
   Dim iMatched As Boolean
   Dim x As Integer
   
   Select Case action
      Case "get"
         
         listview2.Visible = False   
         If Trim$(txtCountry.text) = "" Then Return 
         The_Collection = modContactsDBI.country_get(Lower(Trim$(txtCountry.text)))
         Listview2.Clear
         If The_Collection.count Then 
            For Each Member In The_Collection
               Listview2.Add(Member!pk, Member!country)
            Next 
            If The_Collection.count = 1 Then 
               Country_Selection("accept")
            Else 
               Listview2.Visible = True
               Listview2.Raise
               Listview2.tag = txtCountry
            End If
         Else
            Listview2.Visible = False  
         End If
      Case "accept"
         
         bExit = True
         If calling_control = "textbox" Then
            
            If Listview2.Visible Then
               Listview2.MoveFirst
               For x = 0 To listview2.count - 1
                  If InStr(Lower(listview2.Item.text), Trim(Lower(txtCountry.text))) Then
                     iMatched = True 
                     Break
                  End If
               Next
               If Not iMatched Then
                  Listview2.Visible = False
                  txtCountry.SetFocus()
                  bExit = False
                  Return 'no match found for country user typed in 
               End If 
            Else
               txtEthnicity.SetFocus()
               bexit = False
               Return 
            End If
         Else
            
            If Listview2.Visible Then
               Listview2.MoveCurrent()             'match internal cursor to marquee
            End If
         End If
         
         txtCountry.text = The_Collection[listview2.Item.key]!country
         country_code = The_Collection[listview2.Item.key]!country_code
         txtEthnicity.SetFocus
         Listview2.Visible = False  
         bExit = False  
   End Select
   
End

Public Sub Ethnicity_Selection(action As String, Optional calling_control As String) 
   
   Dim iMatched As Boolean
   Dim x As Integer
   
   Select Case action
      Case "get"
         
         listview2.Visible = False  
         If Trim$(txtEthnicity.text) = "" Then Return 
         
         The_Collection = modContactsDBI.Ethnicity_Get(Lower(Trim$(txtEthnicity.text)))
         Listview2.Clear
         If The_Collection.count Then 
            For Each Member In The_Collection
               Listview2.Add(Member!pk, Member!ethnicity)
            Next 
            If The_Collection.count = 1 Then 
               Ethnicity_Selection("accept")
            Else 
               Listview2.Visible = True
               Listview2.Raise
               Listview2.tag = txtEthnicity
            End If
         Else
            Listview2.Visible = False  
         End If
      Case "accept"
         
         bExit = True
         If calling_control = "textbox" Then
            
            If Listview2.Visible Then
               Listview2.MoveFirst
               For x = 0 To listview2.count - 1
                  If InStr(Lower(listview2.Item.text), Trim(Lower(txtEthnicity.text))) Then
                     iMatched = True 
                     Break
                  End If
               Next
               If Not iMatched Then
                  Listview2.Visible = False
                  bexit = False
                  txtEthnicity.SetFocus()
                  Return 'no match found for suburb user typed in 
               End If 
            Else
               bexit = False
               txtLanguage.SetFocus()
               Return 
            End If
         Else
            
            If Listview2.Visible Then
               Listview2.MoveCurrent()             'match internal cursor to marquee
            End If
         End If
         
         txtEthnicity.text = The_Collection[listview2.Item.key]!ethnicity
         fk_ethnicity = The_Collection[listview2.Item.key]!pk
         txtLanguage.SetFocus
         Listview2.Visible = False  
         bExit = False  
   End Select
   
End

Public Sub Language_Selection(action As String, Optional calling_control As String) 
   
   Dim iMatched As Boolean
   Dim x As Integer
   
   Select Case action
      Case "get"
         
         listview2.Visible = False  
         If Trim$(txtLanguage.text) = "" Then Return 
         The_Collection = modContactsDBI.Language_Get(Lower(Trim$(txtLanguage.text)))
         Listview2.Clear
         If The_Collection.count Then 
            For Each Member In The_Collection
               Listview2.Add(Member!pk, Member!language)
            Next 
            
            Listview2.Visible = True
            Listview2.Raise
            Listview2.tag = txtLanguage
            
         Else
            Listview2.Visible = False  
         End If
      Case "accept"
         bExit = True
         If calling_control = "textbox" Then
            
            If Listview2.Visible Then
               Listview2.MoveFirst
               For x = 0 To listview2.count - 1
                  
                  If Lower(listview2.Item.text) = Trim(Lower(txtLanguage.text)) Then
                     iMatched = True 
                     Break
                  End If
               Next
               If Not iMatched Then
                  Listview2.Visible = False
                  bExit = False
                  fk_language = 0
                  txtLanguage.SetFocus()
                  Return 
               End If 
            Else
               bExit = False
               Return  
            End If
         Else
            
            If Listview2.Visible Then
               Listview2.MoveCurrent()             'match internal cursor to marquee
            End If
         End If
         
         txtLanguage.text = The_Collection[listview2.Item.key]!language
         fk_language = The_Collection[listview2.Item.key]!pk
         txtMemo.SetFocus()
         Listview2.Visible = False  
         bExit = False  
   End Select
   
End

Public Sub EditArea_Buttons_KeyPress()
   
   If key.code = key.return Then
      EditArea_Buttons_Click
   End If   
   
End

Public Sub EditArea_RadioButtons_Click()
   
   Notify_Data_Changed(True)
   
End

Public Sub EditArea_RadioButtons_KeyPress()
   
   Select Case key.Code
      Case key.return
         Select Case Last.tag
            Case "aboriginality none"
               rbAboriginalityAboriginal.SetFocus()
            Case "aboriginal"
               rbAboriginalityTSI.SetFocus()
            Case "torres strait islander"
               txtCountry.SetFocus()
               
         End Select
   End Select
   
End

Public Sub Check_For_Unsaved_Data()
   
   Return 
   If Vbox_EditArea.Padding = 1 Then
      Select Case Message.Warning("Do you want to save the changes before proceeding?", "Yes", "Discard changes")
         Case 1
            Save()
         Case 2
            Notify_Data_Changed(False)
      End Select
   End If  
   
End

Public Sub txtSearch_GotFocus()
   
   bExit = True
   EditArea_Clear()
   bExit = False  
   lblContactType.text = "Find Patient"
   Check_For_Unsaved_Data()
   If isection = cSection_Patients Then
      modEditAreaHelpers.Help_Show("help/finding-patients.html", FHelp)
   Endif
   
End

Public Sub cvwContacts_GotFocus()
   
   modEditAreaHelpers.Help_Show("help/add-contact-method.html", FHelp)
   
End

Public Sub cvwAddresses_GotFocus()
   
   modEditAreaHelpers.Help_Show("help/adding-addresses.html", FHelp)
   
End

Public Sub cvwPersons_GotFocus()
   
   If isection = cSection_Patients Then
      modEditAreaHelpers.Help_Show("help/finding-patients.html", FHelp)
   Endif
   
End

Public Sub cvwContacts_Select()
   
   cvwContacts.MoveCurrent()
   iCommunication = cvwContacts.Item.Key
   Comm = comms[iCommunication]
   
End

Public Sub txtSearch_KeyPress()
   
   If key.code = key.down Then
      If cvwPersons.count Then
         cvwPersons.SetFocus
         cvwPersons.MoveFirst
         cvwPersons.Item.Selected = True
         
      Endif
   Endif
   
End

Public Sub Surname_Duplicates_Selection(action As String, Optional calling_control As String) 
   
   Select Case action
      Case "get"
         
         Listview1.Clear
         Listview1.Visible = False  
         If Trim(txtSurname.text) = "" Then 
            Listview1.Visible = False  
            Return 
         End If
         If Isection = cSection_Patients Then
             The_Collection = modContactsDBI.Person_Get(Trim(txtSurname.text), const.contacttype_patient)
         Else
            The_Collection = modContactsDBI.Person_Get(Trim(txtSurname.text), const.contacttype_person)
         End If
         The_Collection.Remove("sql_in_english")
         
         If The_Collection.count Then 
            Listview1.Clear()
            For Each Member In The_Collection
               Listview1.Add(Member!pk_view, Member!firstname & " " & Member!surname & " (" & Member!occupation & ")")
            Next 
            Listview1.Visible = True
            Listview1.Raise
            Listview1.tag = txtSurname
         End If
      Case "accept"
         Message.Warning("the person already exists in the database")
         
   End Select
   
End
