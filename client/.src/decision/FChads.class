' Gambas class file
' Copyright (C) 2008-2011 Dr Richard Terry

' This program is free software: you can redistribute it and/or modify
' it under the terms of the GNU General Public License as published by
' the Free Software Foundation, either version 3 of the License, or
' (at your option) any later version.

' This program is distributed in the hope that it will be useful,
' but WITHOUT ANY WARRANTY; without even the implied warranty of
' MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
' GNU General Public License for more details.

' You should have received a copy of the GNU General Public License
' along with this program.  If not, see <http://www.gnu.org/licenses/>.
'----------------------------------------------------------------------
' PURPOSE      Calculate Chads score for patient in Atrial fibrillation
' REFERENCES   http://en.wikipedia.org/wiki/CHADS_score#cite_note-Gage2001-1
'-----------------------------------------------------------------------

Private Score As Integer
Private CurrentConsult As CConsult
Private Chad As String[]

Public Sub _new()

   TextLabel3.text = Chads_Heading()
   TextLabel1.text = Stroke_Risk() 
   TextLabel2.TEXT = Anticoagulation_Recommendations()
   modEditAreaHelpers.Resize_labels(Vbox1, lblmeasure)
   Chad = New String[]
   Chad.Add("1.9")
   Chad.Add("2.8")
   Chad.Add("4.0")
   Chad.Add("5.9")
   Chad.Add("8.5")
   Chad.Add("12.5")
   Chad.Add("18.2")
   
End

Public Sub Init(Cons As CConsult)
   
   CurrentConsult = Cons
   If CurrentConsult!patient!age_numeric > 75 Then rbAgeOver75Yes.value = True
   
End

Public Function Stroke_Risk() As String 
   
   Return ""
   "<TABLE BORDER=0 CELLPADDING=0 CELLSPACING=2>"
   " <TR>"
   "  <TH BGCOLOR=\"#e6e6e6\">"
   "   <P>CHADS<SUB>2</SUB> Score</P>"
   "  </TH>"
   "  <TH BGCOLOR=\"#e6e6e6\">"
   "   <P>&nbsp;&nbsp;Stroke Risk&nbsp;%</P>"
   "  </TH>"
   "  <TH BGCOLOR=\"#e6e6e6\">"
   "   <P>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;95% <A HREF=\"/wiki/Confidence_interval\">CI</A>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</P>"
   "  </TH>"
   " </TR>"
   " <TR>"
   "  <TD BGCOLOR=\"#e6e6e6\">"
   "   <P ALIGN=CENTER><B>0</B></P>"
   "  </TD>"
   "  <TD BGCOLOR=\"#e6e6e6\">"
   "   <P ALIGN=CENTER>1.9</P>"
   "  </TD>"
   "  <TD BGCOLOR=\"#e6e6e6\">"
   "   <P ALIGN=CENTER>&nbsp;1.2-3.0</P>"
   "  </TD>"
   " </TR>"
   " <TR>"
   "  <TD BGCOLOR=\"#e6e6e6\">"
   "   <P ALIGN=CENTER><B>1</B></P>"
   "  </TD>"
   "  <TD BGCOLOR=\"#e6e6e6\">"
   "   <P ALIGN=CENTER>2.8</P>"
   "  </TD>"
   "  <TD BGCOLOR=\"#e6e6e6\">"
   "   <P ALIGN=CENTER>&nbsp;2.0-3.8</P>"
   "  </TD>"
   " </TR>"
   " <TR>"
   "  <TD BGCOLOR=\"#e6e6e6\">"
   "   <P ALIGN=CENTER><B>2</B></P>"
   "  </TD>"
   "  <TD BGCOLOR=\"#e6e6e6\">"
   "   <P ALIGN=CENTER>4.0</P>"
   "  </TD>"
   "  <TD BGCOLOR=\"#e6e6e6\">"
   "   <P ALIGN=CENTER>&nbsp;3.1-5.1</P>"
   "  </TD>"
   " </TR>"
   " <TR>"
   "  <TD BGCOLOR=\"#e6e6e6\">"
   "   <P ALIGN=CENTER><B>3</B></P>"
   "  </TD>"
   "  <TD BGCOLOR=\"#e6e6e6\">"
   "   <P ALIGN=CENTER>5.9</P>"
   "  </TD>"
   "  <TD BGCOLOR=\"#e6e6e6\">"
   "   <P ALIGN=CENTER>&nbsp;4.6-7.3</P>"
   "  </TD>"
   " </TR>"
   " <TR>"
   "  <TD BGCOLOR=\"#e6e6e6\">"
   "   <P ALIGN=CENTER><B>4</B></P>"
   "  </TD>"
   "  <TD BGCOLOR=\"#e6e6e6\">"
   "   <P ALIGN=CENTER>8.5</P>"
   "  </TD>"
   "  <TD BGCOLOR=\"#e6e6e6\">"
   "   <P ALIGN=CENTER>&nbsp;6.3-11.1</P>"
   "  </TD>"
   " </TR>"
   " <TR>"
   "  <TD BGCOLOR=\"#e6e6e6\">"
   "   <P ALIGN=CENTER><B>5</B></P>"
   "  </TD>"
   "  <TD BGCOLOR=\"#e6e6e6\">"
   "   <P ALIGN=CENTER>12.5</P>"
   "  </TD>"
   "  <TD BGCOLOR=\"#e6e6e6\">"
   "   <P ALIGN=CENTER>&nbsp;8.2-17.5</P>"
   "  </TD>"
   " </TR>"
   " <TR>"
   "  <TD BGCOLOR=\"#e6e6e6\">"
   "   <P ALIGN=CENTER><B>6</B></P>"
   "  </TD>"
   "  <TD BGCOLOR=\"#e6e6e6\">"
   "   <P ALIGN=CENTER>18.2</P>"
   "  </TD>"
   "  <TD BGCOLOR=\"#e6e6e6\">"
   "   <P ALIGN=CENTER>10.5-27.4</P>"
   "  </TD>"
   " </TR>"
   "</TABLE>"
   "<BR>"

End

Public Function Anticoagulation_Recommendations() As String
   
   Return ""
   "<B><A NAME=\"Anticoagulation_based_on_the_CHADS2_score\"></A>Anticoagulation "
   "based on the CHADS<SUB>2</SUB> score:</B><BR>"
   "<TABLE CELLPADDING=2 CELLSPACING=2>"
   " <TR>"
   "  <TH BGCOLOR=\"#e6e6e6\">"
   "   <P>Score</P>"
   "  </TH>"
   "  <TH BGCOLOR=\"#e6e6e6\">"
   "   <P>Risk</P>"
   "  </TH>"
   "  <TH BGCOLOR=\"#e6e6e6\">"
   "   <P>Anticoagulation Therapy</P>"
   "  </TH>"
   "  <TH BGCOLOR=\"#e6e6e6\">"
   "   <P STYLE=\"background: #e6e6e6\">Considerations</P>"
   "  </TH>"
   " </TR>"
   " <TR>"
   "  <TD BGCOLOR=\"#e6e6e6\">"
   "   <P><B>0</B></P>"
   "  </TD>"
   "  <TD BGCOLOR=\"#e6e6e6\">"
   "   <P>Low</P>"
   "  </TD>"
   "  <TD BGCOLOR=\"#e6e6e6\">"
   "   <P><A HREF=\"http://en.wikipedia.org/wiki/Aspirin\">Aspirin</A></P>"
   "  </TD>"
   "  <TD BGCOLOR=\"#e6e6e6\">"
   "   <P>Aspirin daily</P>"
   "  </TD>"
   " </TR>"
   " <TR>"
   "  <TD BGCOLOR=\"#e6e6e6\">"
   "   <P><B>1</B></P>"
   "  </TD>"
   "  <TD BGCOLOR=\"#e6e6e6\">"
   "   <P>Moderate</P>"
   "  </TD>"
   "  <TD BGCOLOR=\"#e6e6e6\">"
   "   <P>Aspirin or Warfarin</P>"
   "  </TD>"
   "  <TD BGCOLOR=\"#e6e6e6\">"
   "   <P>Aspirin daily or raise <A HREF=\"http://en.wikipedia.org/wiki/International_normalized_ratio\">INR</A>"
   "   to 2.0-3.0, depending on factors such as patient preference</P>"
   "  </TD>"
   " </TR>"
   " <TR>"
   "  <TD BGCOLOR=\"#e6e6e6\">"
   "   <P><B>2 or greater</B></P>"
   "  </TD>"
   "  <TD BGCOLOR=\"#e6e6e6\">"
   "   <P>Moderate or High</P>"
   "  </TD>"
   "  <TD BGCOLOR=\"#e6e6e6\">"
   "   <P><A HREF=\"http://en.wikipedia.org/wiki/Warfarin\">Warfarin</A></P>"
   "  </TD>"
   "  <TD BGCOLOR=\"#e6e6e6\">"
   "   <P>Raise <A HREF=\"http://en.wikipedia.org/wiki/International_normalized_ratio\">INR</A>"
   "   to 2.0-3.0, unless contraindicated (e.g. clinically significant GI"
   "   bleeding, inability to obtain regular INR screening)</P>"
   "  </TD>"
   " </TR>"
   "</TABLE>"
   
End

Public Function Chads_Heading() As String
   
   Return ""
   
   "<P><Center><B>CHADS score<B></Center></P>" ""
   "<P>The CHADS score,  or CHADS2 score is a clinical prediction rule for estimating the risk of stroke in patients with non-rheumatic atrial fibrillatio</P> "

End

Public Function References() As String
   
   Return ""
   "<P><A NAME=\"cite_ref-pmid15477396_0-1\"></A><A NAME=\"cite_ref-Gage2001_1-2\"></A>"
   "The following treatment strategies were recommended in the table to"
   "the right:<A HREF=\"http://en.wikipedia.org/wiki/CHADS_score#cite_note-pmid15477396-0\">[1]</A><A HREF=\"http://en.wikipedia.org/wiki/CHADS_score#cite_note-Gage2001-1\">[2]</A></P>"
   "<UL>"
   " <LI><P STYLE=\"margin-bottom: 0cm\"><A NAME=\"cite_note-pmid15477396-0\"></A>"
   " ^ <A HREF=\"http://en.wikipedia.org/wiki/CHADS_score#cite_ref-pmid15477396_0-0\"><SUP><I><B>a</B></I></SUP></A>"
   " <A HREF=\"http://en.wikipedia.org/wiki/CHADS_score#cite_ref-pmid15477396_0-1\"><SUP><I><B>b</B></I></SUP></A>"
   " Gage BF, van Walraven C, Pearce L, <I>et al.</I> (2004). <A HREF=\"http://circ.ahajournals.org/cgi/content/full/110/16/2287\">&quot;Selecting"
   " patients with atrial fibrillation for anticoagulation: stroke risk"
   " stratification in patients taking aspirin&quot;</A>. <I>Circulation</I>"
   " <B>110</B> (16): 2287–92. <A HREF=\"http://en.wikipedia.org/wiki/Digital_object_identifier\">doi</A>:<A HREF=\"http://dx.doi.org/10.1161%2F01.CIR.0000145172.55640.93\">10.1161/01.CIR.0000145172.55640.93</A>."
   " <A HREF=\"http://en.wikipedia.org/wiki/PubMed_Identifier\">PMID</A>&nbsp;<A HREF=\"http://www.ncbi.nlm.nih.gov/pubmed/15477396\">15477396</A>."
   " <A HREF=\"http://circ.ahajournals.org/cgi/content/full/110/16/2287\">http://circ.ahajournals.org/cgi/content/full/110/16/2287</A>.&nbsp;"
   "  </P>"
   "</UL>"
   "<UL>"
   " <LI><P><A NAME=\"cite_note-Gage2001-1\"></A>^ <A HREF=\"http://en.wikipedia.org/wiki/CHADS_score#cite_ref-Gage2001_1-0\"><SUP><I><B>a</B></I></SUP></A>"
   " <A HREF=\"http://en.wikipedia.org/wiki/CHADS_score#cite_ref-Gage2001_1-1\"><SUP><I><B>b</B></I></SUP></A>"
   " <A HREF=\"http://en.wikipedia.org/wiki/CHADS_score#cite_ref-Gage2001_1-2\"><SUP><I><B>c</B></I></SUP></A>"
   " Gage BF, Waterman AD, Shannon W, Boechler M, Rich MW, Radford MJ"
   " (2001). <A HREF=\"http://jama.ama-assn.org/cgi/content/full/285/22/2864\">&quot;Validation"
   " of clinical classification schemes for predicting stroke: results"
   " from the National Registry of Atrial Fibrillation&quot;</A>. <I>JAMA</I>"
   " <B>285</B> (22): 2864–70. <A HREF=\"http://en.wikipedia.org/wiki/Digital_object_identifier\">doi</A>:<A HREF=\"http://dx.doi.org/10.1001%2Fjama.285.22.2864\">10.1001/jama.285.22.2864</A>."
   " <A HREF=\"http://en.wikipedia.org/wiki/PubMed_Identifier\">PMID</A>&nbsp;<A HREF=\"http://www.ncbi.nlm.nih.gov/pubmed/11401607\">11401607</A>."
   " <A HREF=\"http://jama.ama-assn.org/cgi/content/full/285/22/2864\">http://jama.ama-assn.org/cgi/content/full/285/22/2864</A>.</P>"
   "</UL>" 
   
End

Public Sub rbChad_Click()
   
   Add_Score()
   
End

Public Sub Add_Score()

   Dim hCtrl As Control
   Dim hb As HBox
   Dim rb As RadioButton

   score = 0
   For Each hCtrl In Vbox1.Children
      If hctrl Is Hbox Then 
         hb = hctrl
         For Each hctrl In hb.children
            If hctrl Is RadioButton Then
               rb = hctrl
               If rb.value = True And rb.text = "Yes" Then
                  Score += rb.Parent.Tag
                  Break
               End If
            End If
            Print "score is:" & score
         Next
         
      End If 
   Next
   Print "score is:" & score
   lblScore.text = "The patient's annual stroke risk based on the score of " & Str(score) & " is:" & Chad[score]

End
