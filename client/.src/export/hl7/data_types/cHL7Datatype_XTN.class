' Gambas class file

' Copyright (C) 2012-2014 Bernd Brinkmann brinkmann_bernd@gmx.de

' This program is free software: you can redistribute it and/or modify
' it under the terms of the GNU General Public License as published by
' the Free Software Foundation, either version 3 of the License, or
' (at your option) any later version.

' This program is distributed in the hope that it will be useful,
' but WITHOUT ANY WARRANTY; without even the implied warranty of
' MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
' GNU General Public License for more details.

' You should have received a copy of the GNU General Public License
' along with this program.  If not, see <http://www.gnu.org/licenses/>.
'----------------------------------------------------------------------

Public telecommunicationUseCode_ID As String
Public telecommunicationEquipmentType_ID As String
Public EmailAdress_ST As String
Public CountryCode_ST As String
Public AreaCode_ST As String
Public PhoneNumber_ST As String
Public Extension_ST As String
Public AnyText_ST As String

' accepts a collection of comms values such as returned for patients or staff
Public Sub Load(comm As Collection)
   
   Dim right_types As String[] = ["Mobile Phone", "Home", "Work", "Phone", "VOIP"]
   Dim p As Collection
   
   For Each p In comm
      If right_types.Exist(p!type) Then
         If p!preferred_method Then  'if this contact number is the preferred number set this as Phone number 
            
            'Telecommunication use code table 0201
            '          ' Asn Answering Service Number Nummer des Antwortdienstes    
            '          ' BPN Beeper Number    
            '          ' EMR Emergency Number Notfallnummer    
            '          ' NET Network(email)Address Netzwerkadresse(E - Mail)    
            '          ' ORN Other Residence Number Nebenwohnsitznummer    
            '          ' PRN Primary Residence Number Hauptwohnsitznummer    
            '          ' VHN Vacation Home Number Ferienwohnsitznummer    
            '          ' WPN Work Number Dienstnummer    
            '          
            'Telecommunication equipment type  table 0202
            '          ' BP     Beeper    
            '          ' CP     Cellular Phone Mobiltelephon    
            '          ' FX     Fax Fax    
            '          ' Internet Internet Address: Use Only If Telecommunication Use Code Is NET    
            '          ' MD     Modem Modem    
            '          ' PH     Telephone Telephon    
            '          ' X.400  X.400 email address: Use Only If Telecommunication Use Code Is Net
            '          
            If p!type = "Mobile Phone" Then 
               telecommunicationUseCode_ID = "PRN"
               telecommunicationEquipmentType_ID = "CP" 
            Else
               telecommunicationEquipmentType_ID = "PH"
            Endif
            
            If p!type = "Home" Then
               telecommunicationUseCode_ID = "PRN"
            Endif
            If p!type = "Work" Then 
               telecommunicationUseCode_ID = "WPN"
            Endif
            If p!type = "Phone" Then 
               telecommunicationUseCode_ID = "PRN"
            Endif
            
            PhoneNumber_ST = Replace$(p!value, " ", "") ' this removes spaces in the phone number because there are not allowed in the hl7 format
            PhoneNumber_ST = Replace$(PhoneNumber_ST, "(", "")
            PhoneNumber_ST = Replace$(PhoneNumber_ST, ")", "")
            If PhoneNumber_ST Like "0*" Then
               AreaCode_ST = Left$(PhoneNumber_ST, 2)
               PhoneNumber_ST = Right$(PhoneNumber_ST, -2)
            Endif
         End If
      Endif
   Next
   
End

Public Sub Emit(dest As Stream)
   '----------------------------------------------------------------------
   'This function puts the information contained by this class into HL7 format
   'Variables:
   '-dest:  a stream variable where the result will be written to 
   '----------------------------------------------------------------------
If PhoneNumber_ST <> "" Then
    modHL7Emitter.Emit("^", dest, ["", telecommunicationUseCode_ID, telecommunicationEquipmentType_ID, EmailAdress_ST, CountryCode_ST, AreaCode_ST, PhoneNumber_ST, Extension_ST, AnyText_ST])
Endif

End
