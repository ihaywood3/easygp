' Gambas class file

' Represents a ADT_A02 message structure (see chapter ?). This structure contains the following elements:

' 1: MSH(Message header segment)
' 2: EVN( Event type)
' 3: PID(Patient Identification)
' 4: PD1(Patient Demographic)Optional
' 5: PV1(Patient visit)
' 6: PV2(Patient visit - additional information)Optional
' 7: DB1(Disability Segment)Optional repeating
' 8: OBX(Observation segment)Optional repeating

' Function to fill all required fields for the message
' 

Public Sub CreateHL7Message_TransferPatient(ConsultingDoctor_XCN As CHL7Datatype_XCN, ReceivingFacility_HD As CHL7Datatype_HD, ToTransferPatient_fk_Patient As Integer, ReferralLetterText As String, Optional AdmissionType As String)
   
   Dim dest As Stream
   Dim MSH As CHL7Segment_MSH
   Dim PID As CHL7Segment_PID
   Dim PV1 As CHL7Segment_PV1
   Dim ORC As CHL7Segment_ORC
   Dim OBR As CHL7Segment_OBR
   Dim OBX1 As CHL7Segment_OBX
   Dim EVN As CHL7Segment_EVN
   
   Dim UserInformation As Collection
   Dim Patient As Collection
     UserInformation = New Collection
   
   UserInformation = modDBConnect.currentUser
   Patient = modContactsDBI.Patient_Get_Using_PK(ToTransferPatient_fk_Patient)

   MSH = New CHL7Segment_MSH(ReceivingFacility_HD, "ADT^A02")
   EVN = New CHL7Segment_EVN("A02", UserInformation)
   PID = New CHL7Segment_PID(Patient)
   PV1 = New CHL7Segment_PV1(UserInformation, ConsultingDoctor_XCN, AdmissionType)
   If ReferralLetterText <> "" Then ' When a referrel letter is included fill the OBX Segment wiht Data
   OBX1 = New CHL7Segment_OBX(1, ReferralLetterText)
   Endif

    
     
   If ReferralLetterText <> "" Then ' When a referrel letter the OBX segment has to be included
      modHL7Emitter.Emit("\n", File.Out, [MSH, EVN, PID, PV1, OBX1])    'NOTE: separator here should be \ r, but To be visible In a UNIX terminal use \ n
   Else
      modHL7Emitter.Emit("\n", File.Out, [MSH, EVN, PID, PV1])   'NOTE: separator here should be \ r, but To be visible In a UNIX terminal use \ n
   Endif
   
End
