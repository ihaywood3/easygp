' Gambas class file

' 
' Function to fill all required fields for the message
' 

Public Sub CreateHL7Message_TransferPatient(ConsultingDoctor_XCN As CHL7Datatype_XCN, ReceivingFacility_HD As CHL7Datatype_HD, ToTransferPatient_fk_Patient As Integer)
   
   Dim MSH As CHL7Segment_MSH
   Dim PID As CHL7Segment_PID
   Dim PV1 As CHL7Segment_PV1
   
   Dim UserInformation As Collection
   Dim Patient As Collection
   Dim PrimaryKey As Integer
   Dim P As Collection 
   
   MSH = New CHL7Segment_MSH
   PID = New CHL7Segment_PID
   PV1 = New CHL7Segment_PV1
   
   UserInformation = New Collection
   UserInformation = modDBConnect.currentUser
   
   PrimaryKey = modDBConnect.exec_query_first("select nextval('documents.hl7_messages_pk_seq') as Pk;")!pk   'gets the a unique value for the table were the massege will be strored an this value is also used to create a universalID
   
   MSH.SendingApplication_HD_OPT.ApplicationIdentifier = "EasyGP/" & Application.Version
   MSH.SendingFacility_HD_Opt.ApplicationIdentifier = UserInformation!organisation
   MSH.ReceivingFacility_HD_Opt = ReceivingFacility_HD
   MSH.MessageDateTime_TS_Opt.mydate = Now
   MSH.MessageType_CM_Req = "ADT^A02"
   MSH.MessageControlID_ST_Req = Year(Now) & "-" & Month(Now) & "-" & Day(Now) & "-" & Hour(Now) & "-" & Minute(Now) & "-" & Second(Now) & " - " & PrimaryKey
   MSH.ProcessingID_PT_Req.ProcessingID = "P" 
   MSH.VersionID_ID_Req = "2.3.1"
   
   ' 
   Patient = modContactsDBI.Patient_Get_Using_PK(ToTransferPatient_fk_Patient)
   
   For Each p In Patient         'this is just to access to the Patient array in the collection but there will never be more than one patient in this collection
      
      PID.SegmentID_ID_Req = "PID"
      PID.SetIDPatientID_SI_Opt = 1
      PID.PatientName_PN_Req.GivenName = P["firstname"]
      PID.PatientName_PN_Req.FamilyName = P["surname"]
      PID.PatientName_PN_Req.Degree = P["titel"]
      
      
      'storing the birthdate in a different format
      TempStringArray = Split(P["birthdate"], "/", " ")
      PID.ODateTimeOfBirth_TS_Opt.Day = TempStringArray[0]
      PID.ODateTimeOfBirth_TS_Opt.Month = TempStringArray[1]
      PID.ODateTimeOfBirth_TS_Opt.Year = TempStringArray[2]
      
      PID.Sex_Is_Opt = P["sex"]
      PID.PatientAddress_AD_Opt.City = P["town"]
      PID.PatientAddress_AD_Opt.StateOrProvince = p["state"]
      PID.PatientAddress_AD_Opt.StreetAdress = p["street1"] & p["street2"]
      PID.PatientAddress_AD_Opt.PostCode = p["postcode"]
      
      PID.PrimaryLanguage_CE_Opt.Text = p["language"]
      
'       
'       Patient identification list
'  Include all Id information here.It Is A repeating field.
' Medicare Number
' Pension Number
' Healthcare Number
' Safety Net Number
' Military Service Number
' See table on Entitlement Cards In
' Section
'  IDENTIFIED TABLES And OCCURENCES
' Surgery Or Hospital reference For this patient.
' Example:
'  987654321 JA ^ ^ ^ ^ PN
'  Pension Number
' 302668868 J ^ ^ ^ ^ HC
'  Health Card
' 4009887514 ^ ^ ^ AUSHIC ^ MC
'  Medicare Number
' QX321 ^ ^ ^ ^ DVA
'  DVA Number
' 1200340 ^ ^ ^ ^ MSN
'  Military Service Number
' JONESF00863 ^ ^ ^ ^ SR
'  Surgery Reference
' 41325865 ^ ^ ^ ^ SR
'  Numeric surgery refn
' 
'       
'       
'       
'       
      ' Public MaritalStatus_Is_Opt As String
      ' PID.Religion_Is_Opt As String
      ' Public PatientAccountNumber_CX_Opt As New CHL7Datatype_CX
      
      ' Public DriversLicenseNumberPatient_ST_Opt As String
      ' Public MothersIdentifier_CX_Opt As New CHL7Datatype_CX
      
      PID.EthnicGroup_Is_Opt = p["ethnicity"] 
      
      ' Public BirthPlace_ST_Opt As String
      ' Public VeteransMilitaryStatus_CE_Opt As New CHL7Datatype_CE
      ' Public Nationality_CE_Opt As New CHL7Datatype_CE
      
   Next
   
   PID.PhoneNumberHome_TN_Opt = FindTheRightPhoneNumber(ToTransferPatient_fk_Patient)
   
   PV1.SegmentID_ID_Req = "PV1"
   PV1.SetID_SI_Opt = "1"
   
   'PV1.tientClass_IS_Req = ?
   
   PV1.ReferringDoctor_XCN_Opt.ProviderNumber = UserInformation["provider_number"]
   PV1.ReferringDoctor_XCN_Opt.FamilyName = UserInformation["surrname"] 
   PV1.ReferringDoctor_XCN_Opt.GivenName = UserInformation["firstname"]
   PV1.ReferringDoctor_XCN_Opt.Prefix = UserInformation["titel"]
   PV1.ReferringDoctor_XCN_Opt.AssigningAuthority.UniversalID = "AUSHICPR"
   PV1.ReferringDoctor_XCN_Opt.NameTypeCode = "L"
   
   MSH_String = MSH.GetString(MSH)

End

Private Function FindTheRightPhoneNumber(Fk_Patient As Integer) As String
   
   Dim P As Collection
   Dim Contacts As Collection
   Dim Mobile As Integer
   Dim Home As Integer
   Dim Work As Integer
   Dim VOIP As Integer
   
   Contacts = modContactsDBI.person_comms_get(Fk_Patient)
   
   For Each p In Contacts
      If P["type"] = "Mobile  Phone" Or P["type"] = "Home" Or P["type"] = "Work" Or P["type"] = "Phone" Or P["type"] = "VOIP" Then 
         
         If P["preferred_method"] = True Then  'if this contact number is the preferred number set this as Phone number 
            Return P["value"]
         End If
         
         ' If P["type"] = "Mobile" Then
         '    If Mobile <> "" Then
         '    Else
         '       Mobile = P["value"]
         '    Endif
         ' Endif
         
      Endif
      
      ' PID.PhoneNumberHome_TN_Opt = 
      ' PID.Public PhoneNumberBusiness_TN_Opt = 
   Next
   
End
