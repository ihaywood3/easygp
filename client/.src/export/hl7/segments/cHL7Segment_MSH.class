' Gambas class file

' Copyright (C) 2012-2014 Bernd Brinkmann brinkmann_bernd@gmx.de

' This program is free software: you can redistribute it and/or modify
' it under the terms of the GNU General Public License as published by
' the Free Software Foundation, either version 3 of the License, or
' (at your option) any later version.

' This program is distributed in the hope that it will be useful,
' but WITHOUT ANY WARRANTY; without even the implied warranty of
' MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
' GNU General Public License for more details.

' You should have received a copy of the GNU General Public License
' along with this program.  If not, see <http://www.gnu.org/licenses/>.
'----------------------------------------------------------------------
'
'Variable name : Variablecontent_DataType_Required(Req)orOptional(Opt)
' 
' TODO:
' 
' Set Function For Each Optional variable To make this vatiale accessable form the outside And To be able To controll the value taht has To be set that it Is A proper value For this variable(syntax etc)

Public SegmentID_ST_Req As String = "MSH"
Public SendingApplication_HD_Opt As New CHL7Datatype_HD
Public SendingFacility_HD_Opt As New CHL7Datatype_HD
Public ReceivingApplication_HD_Opt As New CHL7Datatype_HD
Public ReceivingFacility_HD_Opt As New CHL7Datatype_HD
Public MessageDateTime_TS_Opt As New CHL7Datatype_TS
Public Security_ST_Opt As String
Public MessageType_CM_Req As New CHL7Datatype_CM
Public MessageControlID_ST_Req As String
Public ProcessingID_PT_Req As New CHL7Datatype_PT
Public VersionID_ID_Req As String
Public SequenceNumber_NM_Opt As String
Public ContinuationPointer_ST_Opt As String
Public AcceptAcknowledgmentType_ID_Opt As String
Public ApplicationAcknowledgmentType_ID_Opt As String
Public CountryCode_ID_Opt As String
Public CharacterSet_ID_opt As String
Public PrincipalLanguageOfMessage_CE_Opt As New CHL7Datatype_CE

Public Sub _new(MessageID As String, EventTypeCode As String, Optional ReceivingFacility_HD As CHL7Datatype_HD)
   '-------------------------------
   'this function is called when a new EVN object of this class is created and it automatically fills 
   'this object with all the required data
   'Variables:
   '-MessageID: has to be a string that contains the Message ID from the HL7 TABLE 9997 - UNIQUE MESSAGE ID and it says what type of message this is
   '-EventTypeCode: contains the event type code from the HL7 TABLE 3 - EVENT TYPE CODE 
   '-Message ControlID(Optional): If this is a answer to a previous referal message the GUID of the previous message can passed here
   '-ReceivingFacility_HD(optional): needs to be an object of the cHL7Datatype_HD class and contains information about the receifing facility
   '--------------------------------
   
   Dim UserInformation As Collection
   Dim primarykey As Integer
   
   UserInformation = New Collection
   UserInformation = modDBConnect.currentUser
   
   SegmentID_ST_Req = "1"
   SendingApplication_HD_OPT.ApplicationIdentifier = "EasyGP v" & Application.Version
   SendingFacility_HD_Opt.ApplicationIdentifier = UserInformation!organisation
   If Not IsNull(ReceivingFacility_HD) Then ReceivingFacility_HD_Opt = ReceivingFacility_HD 
   MessageDateTime_TS_Opt.TimeStamp = Now
   MessageType_CM_Req.EventTypeCode = EventTypeCode
   primarykey = modDBConnect.exec_query("select nextval('documents.hl7_messages') as pk")!pk   'gets the unique value
   MessageType_CM_Req.MessageID = MessageID
   ProcessingID_PT_Req.ProcessingID = "P" 
   VersionID_ID_Req = "2.3.1" 'this says which HL7 standard version is used to cread this message
   CountryCode_ID_Opt = "AU" ' this says in which country this message was created and because easy gp will only be used in australia it is always Au
   MessageControlID_ST_Req = Hex$(primarykey, 8)   
End

Public Function Emit(dest As Stream)
   '----------------------------------------------------------------------
   'This function puts the information contained by this class object into HL7 format
   'Variables:
   '-dest:  a stream variable where the result will be written to 
   '----------------------------------------------------------------------

   
   Print #dest, "MSH|^~\\&|";
   modHL7Emitter.Emit("|", dest, [SendingApplication_HD_Opt, SendingFacility_HD_Opt, ReceivingApplication_HD_Opt, ReceivingFacility_HD_Opt, MessageDateTime_TS_Opt,
      Security_ST_Opt, MessageType_CM_Req, MessageControlID_ST_Req, ProcessingID_PT_Req, VersionID_ID_Req, SequenceNumber_NM_Opt,
      ContinuationPointer_ST_Opt, AcceptAcknowledgmentType_ID_Opt, ApplicationAcknowledgmentType_ID_Opt, CountryCode_ID_Opt, CharacterSet_ID_opt, PrincipalLanguageOfMessage_CE_Opt])
   
End
