' Gambas class file

' PID - patient identification segment
' 
' The PID segment contains information about the patient, And Is Used To specifically identify the patient In the Ascend - IP Or BDidRx database.

Public SegmentID_ID_Req As String = "PID"
Public SetIDPatientID_SI_Opt As Integer
Public PatientIDExternalID_CX_Opt As New CHL7Datatype_CX
Public PatientIDInternalID_CX_Req As New CHL7Datatype_CX
Public AlternatePatientID_CX_Opt As New CHL7Datatype_CX
Public PatientName_PN_Req As New CHL7Datatype_PN
Public MothersMaidenName_PN_Opt As New CHL7Datatype_PN
Public DateTimeOfBirth_TS_Opt As New CHL7Datatype_TS
Public Sex_Is_Opt As String
Public PatientAlias_PN_Opt As New CHL7Datatype_PN
Public Race_Is_Opt As String
Public PatientAddress_AD_Opt As New CHL7Datatype_AD
Public CountryCode_Is_Opt As String
Public PhoneNumberHome_TN_Opt As String
Public PhoneNumberBusiness_TN_Opt As String
Public PrimaryLanguage_CE_Opt As New CHL7Datatype_CE
Public MaritalStatus_Is_Opt As String
Public Religion_Is_Opt As String
Public PatientAccountNumber_CX_Opt As New CHL7Datatype_CX
Public SsnNumberPatient_ST_Opt As String
Public DriversLicenseNumberPatient_ST_Opt As String
Public MothersIdentifier_CX_Opt As New CHL7Datatype_CX
Public EthnicGroup_Is_Opt As String
Public BirthPlace_ST_Opt As String
Public MultipleBirthIndicator_ID_Opt As String
Public BirthOrder_NM_Opt As Integer
Public Citizenship_Is_Opt As String
Public VeteransMilitaryStatus_CE_Opt As New CHL7Datatype_CE
Public Nationality_CE_Opt As New CHL7Datatype_CE
Public PatientDeathDateAndTime_TS_Opt As New CHL7Datatype_TS
Public PatientDeathIndicator_ID_Opt As String

Private Function FindTheRightPhoneNumber(cc As CConsult) As String
   
   Dim p As Collection
   Dim anyphone As String
   Dim right_types As String[] = ["Mobile  Phone", "Home", "Work", "Phone", "VOIP"]

   For Each p In cc!comms
      If right_types.Exist(p!type) Then
         anyphone = p!value
         If p!preferred_method Then  'if this contact number is the preferred number set this as Phone number 
            Return p!value
         End If
      Endif
   Next
   Return anyphone
End




Public Sub Populate(cc As CConsult)
   
   SetIDPatientID_SI_Opt = 1
   PatientName_PN_Req.GivenName = cc!patient!firstname
   PatientName_PN_Req.FamilyName = cc!patient!surname
   DateTimeOfBirth_TS_Opt.mydate = cc!patient!birthdate
   Sex_Is_Opt = cc!patient!sex
   PatientAddress_AD_Opt.City = cc!patient!town
   PatientAddress_AD_Opt.StateOrProvince = cc!patient!state
   PatientAddress_AD_Opt.StreetAdress = cc!patient!street1 & cc!patient!street2
   PatientAddress_AD_Opt.PostCode = cc!patient!postcode
   PrimaryLanguage_CE_Opt.Text = cc!patient!language
   ' FIXME: need to form ID list according to Aussie-specific standards
' 4009887514 ^ ^ ^ AUSHIC ^ MC
'  Medicare Number
' QX321 ^ ^ ^ ^ DVA
'  DVA Number
' 1200340 ^ ^ ^ ^ MSN
'  Military Service Number
' JONESF00863 ^ ^ ^ ^ SR   
   EthnicGroup_Is_Opt = cc!patient!ethnicity 
   PhoneNumberHome_TN_Opt = FindTheRightPhoneNumber(cc)
End


Public Sub Emit(dest As Stream)
   
 modHL7Emitter.Emit("|", dest, ["PID", SetIDPatientID_SI_Opt, PatientIDExternalID_CX_Opt, PatientIDInternalID_CX_Req, AlternatePatientID_CX_Opt, PatientName_PN_Req, 
 MothersMaidenName_PN_Opt, DateTimeOfBirth_TS_Opt, Sex_Is_Opt, PatientAlias_PN_Opt, Race_Is_Opt, PatientAddress_AD_Opt, CountryCode_Is_Opt, PhoneNumberHome_TN_Opt,
 PhoneNumberBusiness_TN_Opt, PrimaryLanguage_CE_Opt, MaritalStatus_Is_Opt, Religion_Is_Opt, PatientAccountNumber_CX_Opt, Null,
 DriversLicenseNumberPatient_ST_Opt, MothersIdentifier_CX_Opt, EthnicGroup_Is_Opt, BirthPlace_ST_Opt, MultipleBirthIndicator_ID_Opt,
 BirthOrder_NM_Opt, Citizenship_Is_Opt, VeteransMilitaryStatus_CE_Opt, Nationality_CE_Opt, PatientAccountNumber_CX_Opt,
 PatientDeathDateAndTime_TS_Opt, PatientDeathIndicator_ID_Opt])
   
End

