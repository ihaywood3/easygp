' Gambas class file

' Copyright (C) 2012-2014 Bernd Brinkmann brinkmann_bernd@gmx.de

' This program is free software: you can redistribute it and/or modify
' it under the terms of the GNU General Public License as published by
' the Free Software Foundation, either version 3 of the License, or
' (at your option) any later version.

' This program is distributed in the hope that it will be useful,
' but WITHOUT ANY WARRANTY; without even the implied warranty of
' MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
' GNU General Public License for more details.

' You should have received a copy of the GNU General Public License
' along with this program.  If not, see <http://www.gnu.org/licenses/>.
'----------------------------------------------------------------------
'
' PID - patient identification segment
' 
' The PID segment contains information about the patient, And Is Used To specifically identify the patient In the Ascend - IP Or BDidRx database.

Public SegmentID_ID_Req As String = "PID"
Public SetIDPatientID_SI_Opt As String
Public OldPatientID_CX_Opt As New CHL7Datatype_CX ' deprecated in HL7 2.3.1 which is the oldest Australian standard
Public PatientID_CX_Req As New CHL7Datatype_CX ' the real patient ID list 
Public AlternatePatientID_CX_Opt As New CHL7Datatype_CX
Public PatientName_PN_Req As New CHL7Datatype_PN
Public MothersMaidenName_PN_Opt As New CHL7Datatype_PN
Public DateTimeOfBirth_TS_Opt As New CHL7Datatype_TS
Public Sex_Is_Opt As String
Public PatientAlias_PN_Opt As New CHL7Datatype_PN
Public Race_Is_Opt As String
Public PatientAddress_AD_Opt As New CHL7Datatype_AD
Public CountryCode_Is_Opt As String
Public PhoneNumberHome_TN_Opt As New CHL7Datatype_XTN
Public PhoneNumberBusiness_TN_Opt As New CHL7Datatype_XTN
Public PrimaryLanguage_CE_Opt As New CHL7Datatype_CE
Public MaritalStatus_CE_Opt As New CHL7Datatype_CE
Public Religion_Is_Opt As String
Public PatientAccountNumber_CX_Opt As New CHL7Datatype_CX
Public SsnNumberPatient_ST_Opt As String
Public DriversLicenseNumberPatient_ST_Opt As String
Public MothersIdentifier_CX_Opt As New CHL7Datatype_CX
Public EthnicGroup_Is_Opt As String
Public BirthPlace_ST_Opt As String
Public MultipleBirthIndicator_ID_Opt As String
Public BirthOrder_NM_Opt As String
Public Citizenship_Is_Opt As String
Public VeteransMilitaryStatus_CE_Opt As New CHL7Datatype_CE
Public Nationality_CE_Opt As New CHL7Datatype_CE
Public PatientDeathDateAndTime_TS_Opt As New CHL7Datatype_TS
Public PatientDeathIndicator_ID_Opt As String
' 



Public Sub _new(P As Collection, comms As Collection, Optional PatientNumber As Integer = 1)
   
   Dim TempStringArray As String[]
   
   SegmentID_ID_Req = "PID"
   SetIDPatientID_SI_Opt = PatientNumber
   PatientName_PN_Req.GivenName = P["firstname"]
   PatientName_PN_Req.FamilyName = P["surname"]
   PatientName_PN_Req.Prefix = P["title"]         'contains stuff like Mr. Dr. Mis ....
   
   ' MaritalStatus_Is_Opt = modDBConnect.exec_query("Select marital From contacts.lu_marital where pk = " & p["fk_marital"] & ";")!marital
  ' converts the DB format into HL7 format
   If p["fk_marital"] = "0" Then MaritalStatus_CE_Opt.Identifier = "U" 'Unknown
   If p["fk_marital"] = "1" Then MaritalStatus_CE_Opt.Identifier = "S" 'Single
   If p["fk_marital"] = "2" Then MaritalStatus_CE_Opt.Identifier = "M" 'Married
   If p["fk_marital"] = "3" Then MaritalStatus_CE_Opt.Identifier = "D"  'Divorced
   If p["fk_marital"] = "4" Then MaritalStatus_CE_Opt.Identifier = "P"  'Defacto
   If p["fk_marital"] = "5" Then MaritalStatus_CE_Opt.Identifier = "W"  'Widow
   If p["fk_marital"] = "6" Then MaritalStatus_CE_Opt.Identifier = "W"  'Widower
   
   'storing the birthdate in a different format
   TempStringArray = Split(P["birthdate"], "/", " ")
   DateTimeOfBirth_TS_Opt.Day_NM = TempStringArray[0]
   DateTimeOfBirth_TS_Opt.Month_NM = TempStringArray[1]
   DateTimeOfBirth_TS_Opt.Year_NM = TempStringArray[2]
   
   Sex_Is_Opt = P["sex"]
   PatientAddress_AD_Opt.City = P["town"]
   PatientAddress_AD_Opt.StateOrProvince = p["state"]
   PatientAddress_AD_Opt.StreetAdress = p["street1"] & p["street2"]
   PatientAddress_AD_Opt.PostCode = p["postcode"]
   PatientAddress_AD_Opt.AddressTypeID = p["address_type"]
   PatientAddress_AD_Opt.CountryID = p["country_code"]
   PrimaryLanguage_CE_Opt.Text = p["language"]
   PatientID_CX_Req.ID = p["medicare_number"]     
   PatientID_CX_Req.IdentifierTypeCode = "MC"
   PatientID_CX_Req.AssigningAuthority.ApplicationIdentifier = "AUSHIC"
   PhoneNumberHome_TN_Opt.Load(comms) ' FIXME: need to control work or home
   
'    Public VeteransMilitaryStatus_CE_Opt As New CHL7Datatype_CE
' Public SsnNumberPatient_ST_Opt As String
End

Public Sub Emit(dest As Stream)
   '----------------------------------------------------------------------
   'This function puts the information contained by this class object into HL7 format
   'Variables:
   '-dest:  a stream variable where the result will be written to 
   '----------------------------------------------------------------------
   '

   modHL7Emitter.Emit("|", dest, ["PID", SetIDPatientID_SI_Opt, OldPatientID_CX_Opt, PatientID_CX_Req, AlternatePatientID_CX_Opt, PatientName_PN_Req, 
      MothersMaidenName_PN_Opt, DateTimeOfBirth_TS_Opt, Sex_Is_Opt, PatientAlias_PN_Opt, Race_Is_Opt, PatientAddress_AD_Opt, CountryCode_Is_Opt, PhoneNumberHome_TN_Opt,
      PhoneNumberBusiness_TN_Opt, PrimaryLanguage_CE_Opt, "", Religion_Is_Opt, PatientAccountNumber_CX_Opt, Null,
      DriversLicenseNumberPatient_ST_Opt, MothersIdentifier_CX_Opt, EthnicGroup_Is_Opt, BirthPlace_ST_Opt, MultipleBirthIndicator_ID_Opt,
      BirthOrder_NM_Opt, Citizenship_Is_Opt, VeteransMilitaryStatus_CE_Opt, Nationality_CE_Opt,
      PatientDeathDateAndTime_TS_Opt, PatientDeathIndicator_ID_Opt])
   
   'Fix me:
   'maritalStatus the NameOfCodingSystem is missing...
   ' modHL7Emitter.Emit("|", dest, ["PID", SetIDPatientID_SI_Opt, PatientIDExternalID_CX_Opt, PatientIDInternalID_CX_Req, AlternatePatientID_CX_Opt, PatientName_PN_Req, 
   '  MothersMaidenName_PN_Opt, DateTimeOfBirth_TS_Opt, Sex_Is_Opt, PatientAlias_PN_Opt, Race_Is_Opt, PatientAddress_AD_Opt, CountryCode_Is_Opt, PhoneNumberHome_TN_Opt,
   '  PhoneNumberBusiness_TN_Opt, PrimaryLanguage_CE_Opt, MaritalStatus_CE_Opt, Religion_Is_Opt, PatientAccountNumber_CX_Opt, Null,
   '  DriversLicenseNumberPatient_ST_Opt, MothersIdentifier_CX_Opt, EthnicGroup_Is_Opt, BirthPlace_ST_Opt, MultipleBirthIndicator_ID_Opt,
   '  BirthOrder_NM_Opt, Citizenship_Is_Opt, VeteransMilitaryStatus_CE_Opt, Nationality_CE_Opt, "",
   '  PatientDeathDateAndTime_TS_Opt, PatientDeathIndicator_ID_Opt])
   
End
