' Gambas class file
 
Private The_Collection As Collection
Private Member As Collection
Public fk_town As Integer
Public town As String
Private bExit As Boolean


Public Sub Run() As Boolean
   Return Not Me.ShowModal()

End

Public Sub btnOK_Click()
  If chkSkip.Value = True Then
      Me.Close()
  Else
      town = Trim(txtSuburb.text)
      Me.Close(True)
  End If
End

Public Sub btnCancel_Click()
  
  Me.Close()

End


Public Sub EditArea_TextBox_KeyRelease()
  
  Suburb_Selection("get")
  

End

Public Sub Suburb_Selection(action As String, Optional calling_control As String) 
      '--------------------------------
      'PURPOSE    :Select a suburb
      'CALLED BY  :listview1_DblClick()
      '--------------------------------
      Dim iMatched As Boolean
      Dim x As Integer
      Select Case action
      Case "get"
         '----------------------------------------------------------
         'Load all the towns like txtSuburb into the popup listview1
         '----------------------------------------------------------
         If Trim$(txtSuburb.text) = "" Then Return
         listview1.Visible = False  
         The_Collection = modContactsDBI.Get_Town(Lower(Trim$(txtSuburb.text)), True, SpinboxLIMIT.value)
         listview1.Clear
         If The_Collection.count Then 
            For Each Member In The_Collection
                listview1.Add(Member!pk, Member!town & " " & Member!state & " " & Member!postcode)
            Next 
            If The_Collection.count = 1 Then 
               Suburb_Selection("accept")
            Else 
               listview1.Visible = True
               listview1.Raise
               listview1.tag = txtSuburb
            End If
         Else
            listview1.Visible = False  
         End If
      Case "accept"
        
         bExit = True
         If calling_control = "textbox" Then
            '-------------------------------------------------------
            'User has just hit <enter> without scrolling on the list
            'try and find a match
            '-------------------------------------------------------
            If listview1.Visible Then
                 listview1.MoveFirst
                  For x = 0 To listview1.count - 1
                    If InStr(Lower(listview1.Item.text), Trim(Lower(txtsuburb.text))) Then
                    
                       iMatched = True 
                       Break
                    End If
                 Next
                 If Not iMatched Then
                  listview1.Visible = False
                  txtSuburb.SetFocus()
                  fk_town = 0
                  Return 'no match found for suburb user typed in 
                 End If 
               End If
          Else
            '-------------------------------------
            'User is selecting from the popup list
            '-------------------------------------
            If listview1.Visible Then
                        
               listview1.MoveCurrent()             'match internal cursor to marquee
            End If
          End If
          '------------------------------------------------------------------------------------------
          'either way, a match has been found within the list, or the user has selected from the list
          '------------------------------------------------------------------------------------------
         txtSuburb.text = The_Collection[listview1.Item.key]!town
         txtState.text = The_Collection[listview1.Item.key]!state 
         txtPostcode.text = The_Collection[listview1.Item.key]!postcode
         fk_town = The_Collection[listview1.Item.key]!pk
        
         listview1.Visible = False  
         bExit = False  
         End Select
      
End
Public Sub EditArea_TextBox_Keypress()
  
  If key.code = key.down Then
      If listview1.Visible Then  
         listview1.SetFocus
         listview1.MoveFirst
         listview1.Item.selected = True   
      Endif
  Endif
  
End

Public Sub EditArea_TextBox_GotFocus()

  With listview1
    .Top = Hbox2.top + Hbox2.Height
    .left = txtsuburb.Left
    .Visible = False
    .Clear
  End With

End
Public Sub ListView1_Keypress()
  
  If key.code = key.return Then
      ListView1_DblClick()
  Endif
  
End

Public Sub ListView1_DblClick()

     Suburb_Selection("accept", "list")

End

Public Sub ListView1_LostFocus()

  Last.Visible = False  

End

Public Sub chkSkip_Click()
   'If true, add this town to skipped towns
 
   FImportPatientsWizard.Skipped_Towns_Add(Trim(txtNotFound.text))
 

End

Public Sub EditArea_TextBox_Change()
  If BExit Then Return 
  Select Case Last.tag
    Case "suburb"
      If Trim(Last.text) = "" Then
         bExit = True
         txtPostcode.text = ""
         txtState.text = ""
         listview1.Visible = False   
         bExit = False  
      Endif
  End Select

End
