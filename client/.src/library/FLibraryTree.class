' Gambas class file

Private picGreenDot As Picture
Private picRedDot As Picture
Private picPDF As Picture
Private sLibraryRootDir As String 'the root directory in filesystem 
Private sHandoutRootDir As String
Private sFileText As String

Public Sub Form_Open()
   
   Init()
   
End 

Public Sub Init()

   Dim sDir As String   

   Settings_Load()
   picRedDot = Picture["icons/12/red_dot.png"]
   picGreenDot = Picture["icons/12/green_dot.png"]
   picPDF = Picture["icons/20/pdf2020.png"]
   Load_Library_Tree
   cmbFilter.Add("*.pdf", 0)
   cmbFilter.Add("*.htm,html", 1)
   cmbFilter.Add("*.doc", 2)
   cmbFilter.Add("*.rtf", 3)
   Load_Handouts_Tree()
   
End

Public Sub form_Close()
   
   Settings_Save()
   
End

Sub GetDirectory(Directory As String)
   
   Dim sFile As String
   Dim sFiles As String[]
   
   For Each sFile In Dir(Directory, "*")
      tvLibrary.Add(sFile, SFile, picGreenDot, "GPar")
      
   Next 
   
End 

Sub PrintDirectory(Directory As String)
   
   Dim sFile As String
   
   For Each sFile In Dir(Directory, "*")
   Next       
   
End

Private Sub Settings_Save()
   
   '   Settings["Library/Hsplit_Main"] = HSplit_Main.Layout
   
End

Private Sub Settings_Load()
   
   ' Try HSplit_Main.Layout = Settings["Library/Hsplit_Main"]
   
End

Public Sub tvLibrary_Click()
   
   Try Display_Item(tvLibrary, sLibraryRootDir)
   
End

Public Sub tvHandouts_Click()
   
   Try Display_Item(tvHandouts, sHandoutRootDir)
   
End

Public Sub Load_Library_Tree_old()
   'FIXME: put in a default dir for library - probably on server
   
   Dim sDir As String           'hold a directory name
   Dim sFile As String          'hold a file anme
   Dim iKey As Integer
   Dim iKey2 As Integer
   Dim sKeyGenerated As String
   Dim picTag As Picture
   'loads defaults for inbox, as yet there are none so hard code
  
  ' sLibraryRootDir = modAdminDBI.Config_Get("library_directory_network", "", Null, modDBConnect.currentUser!fk_c)
   '  Try txtLibraryPathLocal.text = modAdminDBI.Config_Get("library_directory_local", "", Null, fk_clinic) 
   
   tvLibrary.Clear()
   If IsDir(sLibraryRootDir) Then 
      'Each sub file of a DIR will be a Directory or file
      'but in our structure there are no files in the rootdir
      For Each sDir In Dir(sLibraryRootDir)        'Add each directory to the tree
         If IsDir(sLibraryRootDir & sDir) Then       'check if it is actually a directory
            tvLibrary.Add(sDir, sDir) 'if yes, then add to tree as node
            ikey = ikey + 1
            
            For Each sFile In Dir(sLibraryRootDir & sDir, "*.*")
               If InStr(Lower(Sfile), ".pdf") Then
                  pictag = picPDF   
               Else
                  picTag = picGreenDot
               End If
               Try tvLibrary.Add(sFile, sFile, picTag, sDir)
               If Error Then
               End If
               iKey2 = iKey2 + 1
            Next 
         Endif 
      Next 
   Endif 
   
End

Public Sub Load_Library_Tree()
   '------------------------------------------------------------------
   'Loads the tree control with directories and files from the library
   'Tries server first, if fails falls back to local if available
   '------------------------------------------------------------------
   
   sLibraryRootDir = modAdminDBI.Config_Get("library_directory_network", "", Null, modDBConnect.currentUser!fk_clinic)
   If Not Load_Tree(tvLibrary, sLibraryRootDir) Then 
      sLibraryRootDir = modAdminDBI.Config_Get("library_directory_local", "", Null, modDBConnect.currentUser!fk_clinic)
      Load_Tree(tvLibrary, sLibraryRootDir)
   Endif
   
End

Public Function Load_Tree(trview As Treeview, sLibDir As String) As Boolean
   '--------------------------------------------
   'Fills the tree with directories and files
   'returns true is successfull (ie files exist)
   '--------------------------------------------

   Dim sDir As String           'hold a directory name
   Dim sFile As String          'hold a file anme
   Dim iKey As Integer
   Dim iKey2 As Integer
   Dim sKeyGenerated As String
   Dim picTag As Picture
   
   trview.Clear()
   If IsDir(sLibDir) Then 
      'Each sub file of a DIR will be a Directory or file
      'but in our structure there are no files in the rootdir
      For Each sDir In Dir(sLibDir)        'Add each directory to the tree
         If IsDir(sLibDir & sDir) Then       'check if it is actually a directory
            trview.Add(sDir, sDir) 'if yes, then add to tree as node
            ikey = ikey + 1
            
            For Each sFile In Dir(sLibDir & sDir, "*.*")
               If InStr(Lower(Sfile), ".pdf") Then
                  pictag = picPDF   
               Else
                  picTag = picGreenDot
               End If
               Try tvLibrary.Add(sFile, sFile, picTag, sDir)
               If Error Then
               End If
               iKey2 = iKey2 + 1
            Next 
         Endif 
      Next 
   Endif 
   
End

Public Sub Load_Handouts_Tree()
   
   Dim sDir As String           'hold a directory name
   Dim sFile As String          'hold a file anme
   Dim iKey As Integer
   Dim iKey2 As Integer
   Dim sKeyGenerated As String
   Dim picTag As Picture
   'loads defaults for inbox, as yet there are none so hard code
   sHandoutRootDir = User.home & "/easygp/handouts/"
   tvHandouts.Clear()
   If IsDir(sHandoutRootDir) Then 
      'Each sub file of a DIR will be a Directory or file
      'but in our structure there are no files in the rootdir
      For Each sDir In Dir(sHandoutRootDir)        'Add each directory to the tree
         If IsDir(sHandoutRootDir & sDir) Then       'check if it is actually a directory
            tvHandouts.Add(sDir, sDir) 'if yes, then add to tree as node
            ikey = ikey + 1
            
            For Each sFile In Dir(sHandoutRootDir & sDir, "*.*")
               If InStr(Lower(Sfile), ".pdf") Then
                  pictag = picPDF   
               Else
                  picTag = picGreenDot
               End If
               Try tvHandouts.Add(sFile, sFile, picTag, sDir)
               If Error Then
               End If
               iKey2 = iKey2 + 1
            Next 
         Endif 
      Next 
   Endif 
   
End

Public Sub ToolButtons_Click()
   
   Select Case Last.tag
      Case "refresh files"
         Load_Library_Tree()
         Load_Handouts_Tree()
   End Select
   
End

Public Sub Display_Item(tvw As Treeview, rootdir As String)
   
   Dim sKey As String
   Dim sParentDir As String
   Dim Pic As Picture
   Dim sFilename As String
   
   sFilename = tvw.Item.Key                'get filename
   tvw.MoveParent                          'back to parent in tree
   sParentDir = tvw.Item.Key               'top get Parent directory
   
   Select Case File.Ext(sFilename)    
      Case "png", "jpg", "jpeg", "gif", "bmp"
         FClinical.Editor_ShowPage_External("image", sFilename, rootdir & sParentDir & "/" & sFilename)
      Case "pdf" 'used "pdf file" below  rather than "pdf" as Editor_ShowPage(...) has "pdf documents" = patient documents as well.
         FClinical.Editor_ShowPage_External("pdf file", sFilename, sLibraryRootDir & sParentDir & "/" & sFilename)
      Case "html", "htm" 
         FClinical.Editor_ShowPage_External("browser", sFilename, File.Load(rootdir & sParentDir & "/" & sFilename))
      Case "avi", "mov", "wmv", "flv", "mpeg", "mpg", "asf"
         FClinical.Editor_ShowPage_External("multimedia", sFilename, rootdir & sParentDir & "/" & sFilename)
   End Select
   
End
