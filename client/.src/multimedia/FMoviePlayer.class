' Gambas class file

' Gambas Movie Player
' Based on the MPlayer movie player and was made by Beno√Æt Minisini

Private $hProcess As Process
Private $bQuit As Boolean
Private $sPath As String
Private $bShow As Boolean

Public Sub Form_Resize()

  dwgMoviePlayer.Move(8, 8, Me.ClientW - 16, Me.ClientH - panButton.H - 8)
  panButton.Move(0, Me.CLientH - panButton.H, Me.CLientW)
 ' txtAbout.Move(16, 16, dwgMoviePlayer.W - 16, dwgMoviePlayer.H - 16)

End

Public Sub btnPlay_Click()

  If $hProcess Then
    btnPlay.Enabled = False
    btnPause.Enabled = True
    Return
  Endif

  With dwgMoviePlayer
    Form_Resize
    .Show
    .Enabled = False
  End With

  $bShow = True

  $hProcess = Exec ["mplayer", "-wid", CStr(dwgMoviePlayer.Handle), Conv$($sPath, Desktop.Charset, System.Charset)] For Read Write As "Process"

  btnStop.Enabled = True
  btnPlay.Enabled = False
  btnPause.Enabled = True
End

Public Sub btnPause_Click()

  If Not $hProcess Then Return
  btnPlay.Enabled = True
  btnPause.Enabled = False
End

Public Sub btnStop_Click()

  If Not $hProcess Then Return
  If $bQuit Then
    $hProcess.Kill
  Else
    $bQuit = True
  Endif

End

Public Sub Process_Read()
  
  Dim sData As String
  
  sData = Read #Last, -255
  
End


Public Sub Process_Kill()

  $hProcess = Null
  timShow.Enabled = False
  $bQuit = False
  $bShow = False
  btnPause.Enabled = False
  btnPlay.Enabled = True
  btnStop.Enabled = False
  dwgMoviePlayer.Hide

End


Public Sub StopMovie()

  If Not $hProcess Then Return

  $hProcess.Kill
End

Public Sub Form_Close()
  
  StopMovie
  
End

Public Sub Init(sFilepath As String)
   
    $sPath = sFilepath
    StopMovie
    btnPlay.Enabled = True
    btnPlay_Click
End


Public Sub btnOpen_Click()

  Dialog.Path = $sPath
  If Dialog.OpenFile() Then Return
  $sPath = Dialog.Path
  
  StopMovie
  btnPlay.Enabled = True
  btnPlay_Click
  
End


Public Sub Form_Open()

  Print "Wid = "; Hex$(dwgMoviePlayer.id)

End

Public Sub timShow_Timer()

  dwgMoviePlayer.Resize(1, 1)
  dwgMoviePlayer.Show
  FORM_Resize
  timShow.Enabled = False

End
