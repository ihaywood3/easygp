' Gambas class file

' Gambas module file

' Copyright (C) 2008-2016 Dr. Richard Terry
' This program is free software: you can redistribute it and/or modify
' it under the terms of the GNU General Public License as published by
' the Free Software Foundation, either version 3 of the License, or
' (at your option) any later version.

' This program is distributed in the hope that it will be useful,
' but WITHOUT ANY WARRANTY; without even the implied warranty of
' MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
' GNU General Public License for more details.

' You should have received a copy of the GNU General Public License
' along with this program.  If not, see <http://www.gnu.org/licenses/>.
' ---------------------------------------------------------------------
' A form to show bar graph of patient's with progress notes for a
' period Of Time shown per-decade of age eg 0-12M = 0 decade
'----------------------------------------------------------------------
Private picture_file As String
Private form_sex_pie As FPie

Public Sub Init(fromdate As String, todate As String)
   
   Inc Application.Busy
   lblYear.text = fromdate & " - " & todate
   Bar_Chart_Decades(fromdate, todate)
   Pie_Chart_Sex(fromdate, todate)
   Dec Application.Busy
   
End

Public Sub Bar_Chart_Decades(fromdate As String, todate As String)
   
   Dim pic As Picture
   Dim gnuplot As String
   Dim m As Integer
   Dim f As Integer
   Dim data As Result
   
   data = modResearchDBI.Age_Distribution_By_Decade(fromdate, todate)
   If Not IsNull(picture_file) Then Try Kill picture_file
   gnuplot = modPlot.Gnuplot_Boxgraph(data)
   picture_file = modPlot.Gnuplot_Run(pbAgesByDecade.Width, pbAgesByDecade.Height, gnuplot, data, 4)
   pic = Picture.Load(picture_file)
   pbAgesByDecade.Background = Color.White
   pbAgesByDecade.Picture = pic
   
Catch
   Message.Error(Error.Text)
   
End

Public Sub Pie_Chart_Sex(fromdate As String, todate As String)
   
   Dim Colours As Variant
   Dim c As New Collection
   Dim data As Collection
   Dim sex As New Integer[]
   Dim Sex_R As Result
   
   Try form_sex_pie.Delete
   form_sex_pie = New FPie(VBox_SexPie)
   Sex_R = modResearchDBI.Sex_Distribution(fromdate, todate)
   For Each Sex_R  
      sex.Add(Sex_R!count) 
   Next
   tlSexMessage.text = "<TABLE>"
   tlSexMessage.text &= Row_Template()
   tlSexMessage.text = Replace(tlSexMessage.text, "col1", "Total Male")
   tlSexMessage.text = Replace(tlSexMessage.text, "col2", Str(sex[1]))
   tlSexMessage.text &= Row_Template()
   tlSexMessage.text = Replace(tlSexMessage.text, "col1", "Total Female")
   tlSexMessage.text = Replace(tlSexMessage.text, "col2", Str(sex[0]))
   tlSexMessage.text &= Row_Template()
   tlSexMessage.text = Replace(tlSexMessage.text, "col1", "Total Patients")
   tlSexMessage.text = Replace(tlSexMessage.text, "col2", Str(sex[0] + sex[1]))
   tlSexMessage.text &= "</TABLE>"
   
   Colours = New Variant[]
   colours.Add(Color.Blue)
   colours.Add(Color.Red) 
   
   data = New Collection
   data!label = "Male"
   data!number = sex[1]
   
   c.Add(data, c.count)
   
   data = New Collection
   data!label = "Female"
   data!number = sex[0]
   c.Add(data, c.count)
   form_sex_pie.Init(sex[0] + sex[1], c)
   
End

Public Function Row_Template() As String
   
   Return ""
   "<COL WIDTH=60%>"
   "<COL WIDTH=40%>"
   "<TR VALIGN=TOP>"
   "<TD WIDTH=50%>"
   "col1"
   "</TD>"
   "<TD WIDTH=20%>"
   "col2"
   "</TR>"
   
End
