' Gambas class file

' Copyright (C) 2008-2012 Dr. Richard Terry

' This program is free software: you can redistribute it and/or modify
' it under the terms of the GNU General Public License as published by
' the Free Software Foundation, either version 3 of the License, or
' (at your option) any later version.

' This program is distributed in the hope that it will be useful,
' but WITHOUT ANY WARRANTY; without even the implied warranty of
' MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
' GNU General Public License for more details.

' You should have received a copy of the GNU General Public License
' along with this program.  If not, see <http://www.gnu.org/licenses/>.
' A form for doing research, like the Pen or Canning tools for MDW only better!
'------------------------------------------------------------------------------
Private $Result As Result
Public Settings As Settings
Public Groupers As Collection 
Public keywords As Collection 
Public KeywordGroupers As Collection 
Public currentKeywordGrouper As CICPCKeywordGrouper
Public Patients As Collection

Public bexit As Boolean
Public Sub Form_Open()
  
   
   Me.Center()
End
Public Sub Form_Close()
  
   
 ' Settings_Save()
End

Public Sub init()
  KeywordGroupers = New Collection
  Try Settings_Load()
  
  
End


Public Sub Settings_Save()
   Settings["Research/Top"] = Me.Top
   Settings["Research/Left"] = Me.Left
   Settings["Research/Height"] = Me.Height 
   Settings["Research/Width"] = Me.Width

  ' Settings["Research/VSplit_Defaults_Requests.layout"] = VSplit_Defaults_Requests.Layout
   Settings["Research/HSplit_Research.layout"] = HSplit_Research.layout
   Settings["Research/VSplit_Research.layout"] = VSplit_Research.layout
End

Public Sub Settings_Load()
  
  'VSplit_Defaults_Requests.Layout = Settings["Research/VSplit_Defaults_Requests.layout"]
   HSplit_Research.layout = Settings["Research/HSplit_Research.layout"] 
   VSplit_Research.layout = Settings["Research/VSplit_Research.layout"] 
   Me.Top = Settings["Research/Top", Me.Top]
   Me.Left = Settings["Research/Left", Me.Left] 
   Me.Height = Settings["Research/Height", Me.Height] 
   Me.Width = Settings["Research/Width", Me.Width] 
End
' Public Sub DrawingArea1_Draw()
'   Chart.Width = DrawingArea1.Width
'   Chart.Height = DrawingArea1.Height
'   Chart.Draw()
'   
' End
' Public Sub DrawingArea2_Draw()
'   Chart1.Width = DrawingArea2.Width
'   Chart1.Height = DrawingArea2.Height
'   Chart1.Draw()
'   
' End
' Sub Display_HBA1c_Distribution()
'    Dim i As Integer
'    '------------------------------------------------------------
'    'Display the distribution of hba1c in the diabetic population
'    '------------------------------------------------------------
'    $Result = modStatsDBI.Hba1c_Distribution()
'    tvData.Rows.Count = $Result.count
'    tvData.columns.count = 2
'   For Each $Result
'    tvData[i, 0].text = $Result!XAxes_text
'    tvData[i, 1].text = $Result!count
'    Inc i
'   Next
' End
' Public Sub start_here()
' 'Chart = New Chart
' Chart.Legend.Title = "Legend"
' Chart.Legend.Visible = True
' Chart.Title.Visible = True
' Chart.Title.Text = "Hba1c Distribution"
' Display_HBA1c_Distribution
' 'tvdata.Columns.Count = 2
' 'tvData.Rows.Count = 4
' 'tvData.Header = tvData.Both
' 'tvdata.Columns[0].Text = "Headers"
' 'tvdata.Columns[1].Text = "Set 1"
' SetChartValues()
' End 
' Private Sub SetChartValues()
'  Dim XAxes_Descriptor As New String[]
'   
'   Dim ars As New String[]
'   Dim arf As New Float[]
'   Dim i As Integer
'   Dim j As Integer
'   
'   Chart.CountDataSets = tvData.Columns.Count - 1
'   
'   'For i = 0 To tvdata.Rows.Count - 1
'    ' ars.Add(tvdata[i, 0].Text)
'   'Next
'   For j = 0 To tvData.Columns.Count - 2
'     arf = New Float[]
'     For i = 0 To tvdata.Rows.Count - 1
'       Try arf.Add(CFloat(tvdata[i, J + 1].Text))
'       If Error Then arf.Add(0)
'       Chart[J].Text = tvdata[i, 0].Text
'       ars.Add(tvdata[i, 0].Text)
'     Next
'     Chart.Headers.Values = ars
'     Chart[J].Values = arf
'     Chart[J].Text = tvdata.Columns[J + 1].Text
'     ' Chart[J].Text = tvdata[i, J + 1].Text
'   Next
'   ' Chart.Headers.Values = ars
'   DrawingArea1.Refresh()
'  
' End
' Public Sub Age_Pie()
'    Dim aFont As Font
'    Dim smsg As String
'    '------------------------------------
'    'Displays all current BP measurements
'    'with FIXME - USER DEFINED LIMIT
'    '-------------------------------------
'   ' VBox_DrawingArea.Visible = False
'    'Vbox_Measurements.Visible = False
'    'Vbox_Range.Visible = False
'    'tlMeasurements.Visible = False
'   ' Hbox_TableViews.Padding = 0
'    ' If Not modMeasurementsDBI.Measurements_Display(EasyGP.p, tvwMeasurements, gvar.Measurement_BP) Then
'    '    sMsg = "<P><B>< ALIGN=CENTER>Blood Pressure Measurements></B><P>"
'    '           "There are no values for blood pressure saved to the database.<BR><BR>"
'    '           "You may enter the blood pressure in the notes using the following format:<BR><BR>" 
'    '           "bp=170/90<BR><BR>"
'    '           "Note: there must be no spaces between the letters 'bp', the sign '=' and the numbers, "
'    '           "and the program will only recognise a valid blood pressure format "
'    '           "such as the example above i.e<BR>" 
'    '           " bp = 170/90 will not trigger the formatting function.<BR><BR>"
'    '           "Save the patients record (F12=save, or click the save icon on the task bar "
'    '           "<img align=LEFT border=0 name=graphics src='icons/16/filesave1616.png')"
'    '        sMsg &= "<P></P>"    
'    '           "The blood pressure will appear in the following format in the clinical notes and will be "
'    '           "available for graphing:<BR><BR>"
'    '           "<a href='blood pressure'> blood pressure=134/70 mmhg </a" 
'    '    Hbox_TableViews.Padding = 5   
'    '    tlMeasurements.text = sMsg
'    '    tlMeasurements.Visible = True
'    '    Return
'    ' 
'    ' End If
'   ' graphtype = gvar.Measurement_BP
'   ' Vbox_Range.Visible = False
'   ' VBox_DrawingArea.Visible = True
'   ' Vsplit1.Layout = Settings["Consult Notes Graphs BP/Vsplit1"]
'   ' Vsplit_Left.Layout = Settings["Consult Notes Graphs BP/Vsplit_Left"]
'   ' Hbox_TableViews.Visible = True
'   ' lblMeasurements.text = "Blood Pressure"
'   ' 
'  ' SetChartValues_age()
' '  aFont = Font[Settings["Consult Notes Graphs BP/GraphXY Font"]]
'  ' Chart.XAxe.Font = AFont
'  ' Chart.YAxe.Font = aFont
'  ' Slider1.Value = AFont.size
'  ' tvwMeasurements.Visible = True
'   'Vbox_Measurements.Visible = True
' 
' End
' Private Sub SetChartValues_Hba1c()
'   
'   Dim XAxes_Descriptor As New String[]
'  
'   Dim Hba1c_Values As New Float[]
'   Dim i As Integer
'   Dim j As Integer
'   Dim aFont As font
''  ' Chart = New chart
'   DrawingArea1.Clear()
'   DrawingArea2.Clear()
'   '------------------------------------------------------------------------------
'   'A note on the  behaviour of this graph control
'   '
'   'If the Title is set to a null string, then it occupies no space at the top
'   'This seems to affect the x-axes names height (they squish up), hence I have
'   'set an font size for the header and a blank title "   ", which fixes the 
'   'problem. This will probably change when the graph control is released in 2009
'   'currently setting the legend for a point set eg chart[1].name, dosn't work
'   '------------------------------------------------------------------------------
'   
'    With chart
'       .type = ChartType.columns
'       .Legend.Title = "Legend"                  'the legend at the right
'       .Legend.Visible = True                   'switched this off, ?don't need is obvious
'       .Legend.Position = Align.Right   
'       .title.Font = Font["Arial,22"]            'keep this see note above
'       .Title.Text = "   " 
'       .title.Visible = True
'       .BackColor = Color.White
'       .YAxe.ShowIntervalLines = False
'       .XAxe.ShowIntervalLines = False
'      ' .YAxe.ShowIntervalLines = True
'        .CountDataSets = 1                    'systolic/diastolic, range ul, ll
'       .Border = False
'       
'    End With
'    chart.Count = 2
' '   tvwMeasurements.ToolTip = "" 
'    '-----------------------------------------------------
'    'Default from-to to the range of patients measurements
'    'FIXME - Put a default last n months as user defaults
'    '----------------------------------------------------
'   ' txtGraphFrom.text = tvwMeasurements.Columns[tvwMeasurements.Columns.Count - 2].text
'    'txtGraphTo.text = tvwMeasurements.Columns[1].text
'     '------------------------------------------------------------
'     'Calculate systolic and diastolic measurements for each date
'     '------------------------------------------------------------
'     For Each $Result
'          XAxes_Descriptor.Add($Result!XAxes_text)
'          chart.Headers.Values = XAxes_Descriptor 
              '  UL.Add(CFloat(10.0))
'                
'               Hba1c_Values.Add(CFloat(Format($Result!count, "##.0")))
'              'age.Add(CFloat(10.0))
'            '   Format(bpVal[0], "###.0")))
'             '  systolic.Add(CFloat(Format(bpVal[0], "###.0")))
'             '  tvwMeasurements.ToolTip &= tvwMeasurements.Columns[j].text & ":" & tvwMeasurements[0, j].Text & "\n"
'      Next
      '-----------------------------------------------------
'     'plot systolic and diastolic measurement for each date
'     'and name the Legends
'     '-----------------------------------------------------
'     'chart[0].Values = Hba1c_Values
'     'Chart[1].Values = age
'     chart.Headers.Values = XAxes_Descriptor
'      DrawingArea1.Visible = True
'      DrawingArea1.Refresh
' End
Public Sub txtEditArea_LostFocus()
  
   Last.BackGround = Color.white
  
End

Public Sub txtEditArea_GotFocus()
   Last.BackGround = Color.rgb(95, 255, 175)
   Select Case Last.tag
   Case "keyword"
      ' 
      ' With listview1
      '     .left = txtKeyword.Left
      '     .top = Hbox_Keyword.Top + Hbox_Keyword.height
      '     .width = txtKeyword.Width
      '    ' .Raise()
      ' End With
   Case "group"
         With listview1
          .left = txtGrouper.Left
          .top = Hbox_Group.Top + Hbox_Group.Height
          .width = txtGrouper.Width
         ' .Raise()
      End With
   End Select
  

End
Public Sub txtEditArea_Keypress()
  
  '   fixme PUT IN KEY VALIDATION
  If bexit Then Return
  Select Case Key.Code
  Case Key.Enter
  
  Case Key.Down
   If listview1.Visible Then
      listview1.SetFocus()
   End If   
  End Select
End

Public Sub listview1_KeyPress()
   If Key.code = Key.return Then
      listview1_DblClick()
   End If

End

Public Sub listview1_DblClick()
   '---------------------------------------------------
   'The tag of the list is a the calling textbox control
   '----------------------------------------------------
  Select Case Last.tag.tag
  'Case "keyword"
      'keyword_grouper_select()
  Case "grouper"
      Grouper_Select()
  End Select
  
End

Public Sub Grouper_Select()
   '-------------------------------------------
   'Selects the grouper to find the patients on
   '-------------------------------------------
End

Public Sub keyword_grouper_select()
   '--------------------------------
   'Selects the keyword to search on
   '--------------------------------
   '
      lvwsubgroups.MoveCurrent()
      currentKeywordGrouper = KeywordGroupers[lvwsubgroups.Item.key]
      txtKeyword.text = currentKeywordGrouper.keyword
      txtGrouper.text = currentKeywordGrouper.grouper_description
     ' lvwsubgroups.Visible = False
    Patients = New Collection
  patients = modResearchDBI.Patients_Get_For_Grouper(currentKeywordGrouper.grouper, cvwpatients)
  lblQueryResults.text = "There are " & cvwpatients.count & " patients in this group"


End

Public Sub txtEditArea_KeyRelease()
   If bexit Then Return
  Select Case Last.tag
  
  Case "keyword"
      KeywordGroupers = modResearchDBI.Grouper_Select(Last, lvwsubgroups)
  Case "grouper"
      ' Groupers = modResearchDBI.Grouper_Select(Last, listview1)
  End Select
End
Public Sub btnHBA1c_Click()
  
  Dim R As Result
  R = modStatsDBI.Hba1c_Distribution()
  
End

Public Sub Button1_Click()
  Patients = New Collection
  patients = modResearchDBI.Patients_Get_For_Grouper(currentKeywordGrouper.grouper, cvwpatients)

End
Public Sub lvwsubgroups_Select()
  
   keyword_grouper_select()
  
End

Public Sub lvwSubGroups_DblClick()

   keyword_grouper_select()

End


