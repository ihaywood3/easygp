' Gambas class file

' Copyright (C) 2008-2016 Dr. Richard Terry
' This program is free software: you can redistribute it and/or modify
' it under the terms of the GNU General Public License as published by
' the Free Software Foundation, either version 3 of the License, or
' (at your option) any later version.

' This program is distributed in the hope that it will be useful,
' but WITHOUT ANY WARRANTY; without even the implied warranty of
' MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
' GNU General Public License for more details.

' You should have received a copy of the GNU General Public License
' along with this program.  If not, see <http://www.gnu.org/licenses/>.
'----------------------------------------------------------------------
'PURPOSE    To display a practices demographic profile etc
'----------------------------------------------------------------------
Private picture_file As String
Private form_sex_pie As FPie
Private date_first_progress_note As String

Public Sub _new()

   Inc Application.Busy
   Settings_Load
   EasyGP_Stats 
  ' tlAgeProfile.text = Replace(tlAgeProfile.text, "interval", "from " & date_first_progress_note & " to " & Format(Now, "dd/mm/yyyy"))
   txtDateFrom.text = date_first_progress_note
   txtDateto.text = Format(Now, "dd/mm/yyyy")
   form_sex_pie = New FPie(Vbox_SexPie)
   Profile_Reload 
   
   Pie_Chart_Sex
   Dec Application.Busy

End

Public Sub Pie_Chart_Sex()
   
   Dim Colours As Variant
   Dim sex As Integer[] = modResearchDBI.EasyGP_Sex_Male_Female()
   Dim c As New Collection
   Dim data As Collection
   
   Colours = New Variant[]
   colours.Add(Color.Blue)
   colours.Add(Color.Red) 
   
   data = New Collection
   data!label = "Male"
   data!number = sex[0]
   
   c.Add(data, c.count)
   
   data = New Collection
   data!label = "Female"
   data!number = sex[1]
   c.Add(data, c.count)
   form_sex_pie.Init(sex[0] + sex[1], c)
   
End

Public Sub EasyGP_Stats()
   
   date_first_progress_note = Format(modResearchDBI.First_Progress_Note_In_EasyGP(), "dd/mm/yyyy")
   tlEasyGPStats.text &= "<TABLE>"
   tlEasyGPStats.text &= Row_Template()
   tlEasyGPStats.text = Replace(tlEasyGPStats.text, "col1", "Date first progress note was written")
   tlEasyGPStats.text = Replace(tlEasyGPStats.text, "col2", date_first_progress_note)
   tlEasyGPStats.text &= "</TABLE>"
   
End

Public Function Row_Template() As String
   'for each row in the quiz
   'col 1 = the question, col2 = the text eg high, medium, low, none, col3 = a spacer
   
   Return ""
   "<COL WIDTH=50%>"
   "<COL WIDTH=20%>"
   "<TR VALIGN=TOP>"
   "<TD WIDTH=50%>"
   "col1"
   "</TD>"
   "<TD WIDTH=20%>"
   "col2"
   "</TR>"
   
End

Public Sub Profile_Reload()
   
   Dim pic As Picture
   Dim res As Result
   Dim gnuplot As String
   Dim i As Integer
   Dim j As Integer
   
   If Not IsNull(picture_file) Then Try Kill picture_file
  ' res = modDBConnect.exec_query("select age_numeric::integer /10 as decade, count(*) from Research.vwPatientsProgressNotesLast5Years group by age_numeric::integer / 10 order by decade")
   res = modResearchDBI.Age_Distribution_By_Decade(txtDateFrom.text, txtDateto.Text)
   Print res
   ' If IsNull(query!gnuplot) Then
   '    gnuplot = ""
   ' Else
   '   gnuplot = query!gnuplot
   gnuplot = "box"
   ' Endif
   ' If gnuplot = "" Or Lower$(gnuplot) = "grid" Or Lower$(gnuplot) = "data" Then
   '    PictureBox1.Visible = False
   '    picture_file = Null
   '    tbSaveImage.Text = "Save Data"
   '    Grid.Visible = True
   '    Grid.Columns.Count = res.Fields.Count
   '    Grid.Rows.Count = res.Count
   '    For i = 0 To res.Fields.Count - 1
   '       Grid.Columns[i].Title = res.Fields[i].Name
   '    Next
   '    i = 0
   '    For Each res
   '       For j = 0 To res.Fields.Count - 1
   '          Grid[i, j].Text = Str$(res[j])
   '       Next
   '       Inc i
   '    Next
   ' Else
   '    Grid.visible = False
   '    PictureBox1.Visible = True
   '    tbSaveImage.Text = "Save Image"
   '    If Lower$(gnuplot) = "guess" Then
   '       ' try some default gnuplots
   '       If res.Fields.Count = 2 Then
   '          If res.Fields[0].Type = db.String Then
   '             If res.Count < 10 Then
   '                ' pie chart time!
   '                gnuplot = modPlot.PieChart(res)
   '             Else 
   '                ' bar chart
   '                gnuplot = modPlot.Gnuplot_BoxGraph(res)
   '             Endif
   '          Else
   '             gnuplot = modPlot.ScatterPlot(res)
   '          Endif
   '       Else
   '          If res.Fields[0].Type = db.String Then
   '             gnuplot = modPlot.Gnuplot_BoxGraph(res)
   '          Endif
   '       Endif
   '    Endif
   If Lower$(gnuplot) = "scatter" Then gnuplot = modPlot.ScatterPlot(res)
   If Lower$(gnuplot) = "pie" Then gnuplot = modPlot.PieChart(res)
   If Lower$(gnuplot) = "box" Then gnuplot = modPlot.Gnuplot_Boxgraph(res)
   If Lower(gnuplot) = "line" Then gnuplot = modPlot.Gnuplot_LineGraph(res)
   Debug gnuplot
   picture_file = modPlot.Gnuplot_Run(pbAgesByDecade.Width, pbAgesByDecade.Height, gnuplot, res)
   pic = Picture.Load(picture_file)
   pbAgesByDecade.Background = Color.White
   pbAgesByDecade.Picture = pic
   
Catch
   Message.Error(Error.Text)
   
End

Public Sub Settings_Load()
   
   HSplit1.Layout = Settings[Me.name & "/HSplit1.Layout", modUtilGUI.HSplit([1, 2])]
   
End

Public Sub HSplit1_Resize()
   
   Settings[Me.name & "/HSplit1.Layout"] = HSplit1.Layout
   
End

Public Sub EditArea_TxtBox_KeyPress()

    If Not modUtilGUI.AllowKeys(const.AllowKeys_Date_DWMY, Key.code) Then
       Stop Event
       Return
    Endif

End

Public Sub tbReload_Click()

   Profile_Reload

End
