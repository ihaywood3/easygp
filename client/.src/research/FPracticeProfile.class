' Gambas class file

' Copyright (C) 2008-2016 Dr. Richard Terry
' This program is free software: you can redistribute it and/or modify
' it under the terms of the GNU General Public License as published by
' the Free Software Foundation, either version 3 of the License, or
' (at your option) any later version.

' This program is distributed in the hope that it will be useful,
' but WITHOUT ANY WARRANTY; without even the implied warranty of
' MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
' GNU General Public License for more details.

' You should have received a copy of the GNU General Public License
' along with this program.  If not, see <http://www.gnu.org/licenses/>.
'----------------------------------------------------------------------
'PURPOSE    To display a practices demographic profile etc
'----------------------------------------------------------------------
Private date_first_progress_note As String
Private form_year1 As FAgeByDecade
Private form_year2 As FAgeByDecade
Private form_year3 As FAgeByDecade
Private form_year4 As FAgeByDecade
Private form_year5 As FAgeByDecade
Private picture_file As String
Private year_periods As Collection

Public Sub _new()
   
   Settings_Load
   form_year1 = New FAgeByDecade(Vbox_Year1)
   form_year2 = New FAgeByDecade(Vbox_year2)
   form_year3 = New FAgeByDecade(Vbox_Year3)
   form_year4 = New FAgeByDecade(Vbox_Year4)
   form_year5 = New FAgeByDecade(Vbox_Year5)
   Caveats
   
End

Public Sub Caveats()
   
   tlCaveats.text = "<B>For a variety of reasons, this data will only be an approximation:</B>"
   tlCaveats.text &= "<UL>"
   tlCaveats.text &= "<LI>The data is taken from the progress note entries not the billing system visits."
   tlCaveats.text &= "<LI>The patient may not have been present when a progress note was entered, for "
   "example it could have been a telephone conversation, or a staff member may have entered a note."
   tlCaveats.text &= "<LI>Legacy data, imported with an incorrect audit_action may skew the numbers."
   tlCaveats.text &= "</UL>"
   tlCaveats.text &= "<B>Fixing the Text Size/Spacing on the graphs</B><BR>"
   tlCaveats.text &= "You should use the resizers to make your graphs the optimal size "
   "however, you will have to re-run the analysis after this, which should re-set the graph "
   "image to improve its appearance."
   
End

Public Sub EasyGP_Stats()
   
   date_first_progress_note = Format(modResearchDBI.First_Progress_Note_In_EasyGP(), "dd/mm/yyyy")
   tlEasyGPStats.text = "<TABLE>"
   tlEasyGPStats.text &= Row_Template()
   tlEasyGPStats.text = Replace(tlEasyGPStats.text, "col1", "Date first progress note")
   tlEasyGPStats.text = Replace(tlEasyGPStats.text, "col2", date_first_progress_note)
   tlEasyGPStats.text &= "</TABLE>"
   
End

Public Function Row_Template() As String
   'for each row in the quiz
   'col 1 = the question, col2 = the text eg high, medium, low, none, col3 = a spacer
   
   Return ""
   "<COL WIDTH=60%>"
   "<COL WIDTH=40%>"
   "<TR VALIGN=TOP>"
   "<TD WIDTH=60%>"
   "col1"
   "</TD>"
   "<TD WIDTH=40%>"
   "col2"
   "</TR>"
   
End

Public Sub Analyse_Age_Distribution()
   
   'Calculate the last 3 years age distribution
   Dim D1 As String
   Dim D2 As String
   Dim data As Result
   
   year_periods = New Collection
   
   D2 = Format(Now(), "dd/mm/yyyy")
   D1 = Format(DateAdd(Now(), gb.year, -1), "dd/mm/yyyy")
   form_year5.Init(D1, D2)
   year_periods.Add(D1 & "|" & D2, 5)
   D2 = D1
   D1 = Format(DateAdd(Now(), gb.year, -2), "dd/mm/yyyy")
   form_year4.Init(D1, D2)
   year_periods.Add(D1 & "|" & D2, 4)
   D2 = D1
   D1 = Format(DateAdd(Now(), gb.year, -3), "dd/mm/yyyy")
   form_year3.Init(D1, D2)
   year_periods.Add(D1 & "|" & D2, 3)
   D2 = D1
   D1 = Format(DateAdd(Now(), gb.year, -4), "dd/mm/yyyy")
   form_year2.Init(D1, D2)
   year_periods.Add(D1 & "|" & D2, 2)
   D2 = D1
   D1 = Format(DateAdd(Now(), gb.year, -5), "dd/mm/yyyy")
   form_year1.Init(D1, D2)
   year_periods.Add(D1 & "|" & D2, 1)
   
End

Public Sub Patients_Per_Year()          
   
   Dim pic As Picture                   
   Dim gnuplot As String                
   Dim m As Integer                     
   Dim f As Integer                     
   Dim data As Result                   
   Dim sql As String                    
   Dim sql_base As String               
   Dim x As Integer                     
   Dim dates As String[]                
   
   For x = 1 To year_periods.Length   
      sql_base = ""                      
      "SELECT 'insert_time_period' as time_period, " & x & " as sort_order, "
      "COUNT(distinct vwProgressNOtes.fk_patient)"
      " from clin_consult.vwProgressNotes"
      " JOIN contacts.vwPatients on vwPatients.fk_patient = vwProgressnotes.fk_patient "
      " WHERE  fk_audit_action = 1  AND vwProgressNotes.deleted  is false "
      " AND consult_date BETWEEN $$date_from$$ AND $$date_to$$ AND  vwPatients.person_deleted is  false "
      data = modDBConnect.exec_query(sql)
      sql &= sql_base                   
      dates = Split(year_periods[x], "|")
      sql = Replace(sql, "insert_time_period", Right(dates[0], 7) & "-" & Right(dates[1], 7))
      sql = Replace(sql, "date_from", dates[0])
      sql = Replace(sql, "date_to", dates[1])
      If x < 5 Then sql &= " UNION "    
   Next   
   sql &= " ORDER By sort_order"                              
   Print sql                            
   data = modDBConnect.exec_query(sql)  
   If Not IsNull(picture_file) Then Try Kill picture_file
   gnuplot = modPlot.Gnuplot_BoxGraph(data)
   picture_file = modPlot.Gnuplot_Run(pbAveragePatients.Width, pbAveragePatients.Height, gnuplot, data, 5)
   pic = Picture.Load(picture_file)     
   pbAveragePatients.Background = Color.White
   pbAveragePatients.Picture = pic      
   
End     

Public Sub Patients_Per_Year_demo()
   
   Dim pic As Picture
   Dim gnuplot As String
   Dim m As Integer
   Dim f As Integer
   Dim data As Result
   Dim sql As String = ""
   
   "SELECT '21/02/2014-21/02/2015' as time_period, "
   "COUNT(distinct vwProgressNOtes.fk_patient)"
   " from clin_consult.vwProgressNotes"
   " JOIN contacts.vwPatients on vwPatients.fk_patient = vwProgressnotes.fk_patient"
   " where consult_date BETWEEN $$21/02/2014$$ AND $$21/02/2015$$  AND  vwPatients.person_deleted is  false "
   " UNION"
   " SELECT '21/02/2015-21/02/2016' as time_period, "
   " COUNT(distinct vwProgressNOtes.fk_patient)"
   " from clin_consult.vwProgressNotes"
   " JOIN contacts.vwPatients on vwPatients.fk_patient = vwProgressnotes.fk_patient"
   " where consult_date BETWEEN $$21/02/2015$$ AND $$21/02/2016$$  AND  vwPatients.person_deleted is  false ;" 
   data = modDBConnect.exec_query(sql)
   
   ' data = modResearchDBI.Age_Distribution_By_Decade(fromdate, todate)
   If Not IsNull(picture_file) Then Try Kill picture_file
   gnuplot = modPlot.Gnuplot_BoxGraph(data)
   picture_file = modPlot.Gnuplot_Run(pbAveragePatients.Width, pbAveragePatients.Height, gnuplot, data, 3)
   pic = Picture.Load(picture_file)
   pbAveragePatients.Background = Color.White
   pbAveragePatients.Picture = pic
   
End

Public Sub Settings_Load()
   
   VSplit1.Layout = Settings[Me.name & "/VSplit1.Layout", modUtilGUI.VSplit([1, 1])]
   HSplit1.Layout = Settings[Me.name & "/HSplit1.Layout", [563, 660, 467]]
   
End

Public Sub EditArea_TxtBox_KeyPress()
   
   If Not modUtilGUI.AllowKeys(const.AllowKeys_Date_DWMY, Key.code) Then
      Stop Event
      Return
   Endif
   
End

Public Sub tbReload_Click()
   
   Analyse_Age_Distribution
   EasyGP_Stats
   Patients_Per_Year
   
End
' CREATE OR REPLACE FUNCTION research.first_progressnote()
'   RETURNS date AS
' $BODY$
' declare
'   first_date date;
' 
' begin
'   select into first_date 
'   consult_date From clin_consult.vwprogressnotes where fk_audit_action = 1 order by pk_progressnote ASC limit 1;
'   return first_date;
' end;
' $BODY$
'   LANGUAGE plpgsql VOLATILE
'   COST 100;
' ALTER FUNCTION research.first_progressNote(date)   OWNER TO easygp;

Public Sub VSplit1_Resize()
   
   Settings[Me.name & "/VSplit1.Layout"] = VSplit1.Layout
   
End

Public Sub HSplit1_Resize()
   
   Settings[Me.name & "/HSplit1.Layout"] = HSplit1.Layout
   
End
