' Gambas class file

' Copyright (C) 2008-2016 Dr. Richard Terry
' This program is free software: you can redistribute it and/or modify
' it under the terms of the GNU General Public License as published by
' the Free Software Foundation, either version 3 of the License, or
' (at your option) any later version.

' This program is distributed in the hope that it will be useful,
' but WITHOUT ANY WARRANTY; without even the implied warranty of
' MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
' GNU General Public License for more details.

' You should have received a copy of the GNU General Public License
' along with this program.  If not, see <http://www.gnu.org/licenses/>.
'----------------------------------------------------------------------
'PURPOSE    To display a practices demographic profile etc
'----------------------------------------------------------------------
Private picture_file As String
Private form_sex_pie As FPie
Private date_first_progress_note As String

Public Sub _new()
   
   Inc Application.Busy
   Settings_Load
   EasyGP_Stats 
   txtDateFrom.text = date_first_progress_note
   txtDateto.text = Format(Now, "dd/mm/yyyy")
   Analyse_Age_Distribution
   form_sex_pie = New FPie(Vbox_SexPie)
   
   Pie_Chart_Sex
   Dec Application.Busy
   
End

Public Sub Pie_Chart_Sex()
   
   Dim Colours As Variant
   Dim sex As Integer[] = modResearchDBI.EasyGP_Sex_Male_Female()
   Dim c As New Collection
   Dim data As Collection
   
   Colours = New Variant[]
   colours.Add(Color.Blue)
   colours.Add(Color.Red) 
   
   data = New Collection
   data!label = "Male"
   data!number = sex[0]
   
   c.Add(data, c.count)
   
   data = New Collection
   data!label = "Female"
   data!number = sex[1]
   c.Add(data, c.count)
   form_sex_pie.Init(sex[0] + sex[1], c)
   With form_sex_pie
      .top = VBox5.top - 500
      .left = vBox5.Left + 800
   End With
End

Public Sub EasyGP_Stats()
   
   date_first_progress_note = Format(modResearchDBI.First_Progress_Note_In_EasyGP(), "dd/mm/yyyy")
   tlEasyGPStats.text &= "<TABLE>"
   tlEasyGPStats.text &= Row_Template()
   tlEasyGPStats.text = Replace(tlEasyGPStats.text, "col1", "Date first progress note was written")
   tlEasyGPStats.text = Replace(tlEasyGPStats.text, "col2", date_first_progress_note)
   tlEasyGPStats.text &= "</TABLE>"
   
End

Public Function Row_Template() As String
   'for each row in the quiz
   'col 1 = the question, col2 = the text eg high, medium, low, none, col3 = a spacer
   
   Return ""
   "<COL WIDTH=50%>"
   "<COL WIDTH=20%>"
   "<TR VALIGN=TOP>"
   "<TD WIDTH=50%>"
   "col1"
   "</TD>"
   "<TD WIDTH=20%>"
   "col2"
   "</TR>"
   
End

Public Sub Analyse_Age_Distribution()
   
   'Calculate the last 3 years age distribution
   Dim D1 As String
   Dim D2 As String
   
   D2 = Format(Now(), "dd/mm/yyyy")
   D1 = Format(DateAdd(Now(), gb.year, -1), "dd/mm/yyyy")
   Age_Distribution_Make_Graph(D1, D2, pbAgesByDecade1, lblYear1)
   D2 = D1
   D1 = Format(DateAdd(Now(), gb.year, -2), "dd/mm/yyyy")
   Age_Distribution_Make_Graph(D1, D2, pbAgesByDecade2, lblYear2)
   D2 = D1
   D1 = Format(DateAdd(Now(), gb.year, -3), "dd/mm/yyyy")
   Print D1, D2 
   Age_Distribution_Make_Graph(D1, D2, pbAgesByDecade3, lblYear3) 
   
End

Public Sub Age_Distribution_Make_Graph(fromdate As String, todate As String, pb As PictureBox, lbl As Label)
   
   Dim pic As Picture
   Dim res As Result
   Dim gnuplot As String
   Dim i As Integer
   Dim j As Integer
   
   If Not IsNull(picture_file) Then Try Kill picture_file
   res = modResearchDBI.Age_Distribution_By_Decade(fromdate, todate)
   gnuplot = "box"
   If Lower$(gnuplot) = "box" Then gnuplot = modPlot.Gnuplot_Boxgraph(res)
   picture_file = modPlot.Gnuplot_Run(pb.Width, pb.Height, gnuplot, res)
   pic = Picture.Load(picture_file)
   pb.Background = Color.White
   pb.Picture = pic
   lbl.text = fromdate & " - " & todate
   
Catch
   Message.Error(Error.Text)
   
End

Public Sub Age_Distribution_Make_Graph_old(fromdate As String, todate As String, pb As PictureBox, lbl As Label)
   
   Dim pic As Picture
   Dim res As Result
   Dim gnuplot As String
   Dim i As Integer
   Dim j As Integer
   
   If Not IsNull(picture_file) Then Try Kill picture_file
   res = modResearchDBI.Age_Distribution_By_Decade(fromdate, todate)
   gnuplot = "box"
   If Lower$(gnuplot) = "box" Then gnuplot = modPlot.Gnuplot_Boxgraph(res)
   picture_file = modPlot.Gnuplot_Run(pbAgesByDecade1.Width, pbAgesByDecade1.Height, gnuplot, res)
   pic = Picture.Load(picture_file)
   pbAgesByDecade1.Background = Color.White
   pbAgesByDecade1.Picture = pic
   
Catch
   Message.Error(Error.Text)
   
End

Public Sub Settings_Load()
   
   HSplit1.Layout = Settings[Me.name & "/HSplit1.Layout", modUtilGUI.HSplit([1, 2])]
   VSplit1.Layout = Settings[Me.name & "/VSplit1.Layout", modUtilGUI.VSplit([1, 1])]
   
End

Public Sub HSplit1_Resize()
   
   Settings[Me.name & "/HSplit1.Layout"] = HSplit1.Layout
   
End

Public Sub EditArea_TxtBox_KeyPress()
   
   If Not modUtilGUI.AllowKeys(const.AllowKeys_Date_DWMY, Key.code) Then
      Stop Event
      Return
   Endif
   
End

Public Sub tbReload_Click()
   
   Analyse_Age_Distribution
   
End
' CREATE OR REPLACE FUNCTION research.first_progressnote()
'   RETURNS date AS
' $BODY$
' declare
'   first_date date;
' 
' begin
'   select into first_date 
'   consult_date From clin_consult.vwprogressnotes where fk_audit_action = 1 order by pk_progressnote ASC limit 1;
'   return first_date;
' end;
' $BODY$
'   LANGUAGE plpgsql VOLATILE
'   COST 100;
' ALTER FUNCTION research.first_progressNote(date)   OWNER TO easygp;

Public Sub VSplit1_Resize()
   
   Settings[Me.name & "/VSplit1.Layout"] = VSplit1.Layout
   
End
