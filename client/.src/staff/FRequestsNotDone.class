' Gambas class file

Private Patients As Collection
Private cvwPatients_key As Variant
Private fk_patient As Variant
Private All_Requests As Collection
Private form_clinlists_ordering As FClinLists_Ordering
Private currentconsult As CConsult

Public Sub Init()
   
   With cvwPatients
      .Columns.Count = 3
      .Columns[1].Width = 100
   End With
   cvwRequests.Columns.count = 2
   HSplit1.Layout = Settings[Me.Name & "/hsplit.layout", modUtilGUI.hsplit([1, 1, 1])]
   Reload()
   
End

Public Sub Reload()
   
   Dim last_fk_patient As Variant
   Dim patient As Collection
   Dim x As Integer
   Dim patients_requests As Collection
   
   Inc Application.Busy
   If IsNull(form_clinlists_ordering) Then
      With form_clinlists_ordering = New FClinLists_Ordering(Vbox_Clin_list_ordering)      'create it
         '.Set_Graph_Vbox(Vbox_Graphs)
      End With
      
   Endif
   form_clinlists_ordering.Gui_Clear
   Patients = modUtil.Copy_Collection_Keyed_Sequentially(modRequestsDBI.RequestsForms_Note_Finalised_All_Patients())
   All_Requests = New Collection
   Dec Application.Busy
   cvwPatients.Clear
   For Each patient In Patients
      If last_fk_patient <> patient!fk_patient Then
         ' patients_requests = New Collection
         cvwPatients.Add(patient!fk_patient, 0)
         cvwPatients[patient!fk_patient][0] = patient!patient_wholename
         cvwPatients[patient!fk_patient][1] = Format(patient!birthdate, "dd/mm/yyyy")
         cvwPatients[patient!fk_patient][2] = Trim(patient!patient_street1 & " " & patient!patient_street2) & " " & patient!patient_town
         last_fk_patient = patient!fk_patient  
         Inc x
         ' patients_requests.Add(patient)
      Else
      Endif
   Next
   
End   

Public Sub HSplit1_Arrange()
   
   Settings[Me.Name & "/hsplit.layout"] = hsplit1.layout 
   
End

Public Sub cvwPatients_Select()
   
   Dim P As Collection
   Dim last_fk_patient As Variant
   Dim forms As Collection
   Dim x As Integer
   Dim last_fk_form As Variant
   
   cvwPatients.MoveCurrent
   cvwRequests.Clear
   cvwPatients_Key = cvwPatients.Item.Key
   ' fk_patient = Patients[cvwPatients_Key]!fk_patient  
   fk_patient = cvwPatients_key
   form_clinlists_ordering.Gui_Clear 
   Wait
   
   For Each P In Patients
      If P!fk_patient = fk_patient Then
         If Not form_clinlists_ordering.Current_Consult_Exists() Then                'If there is no current consult e.g first time used or next patient 
            currentconsult = New CConsult(P, const.consult_type_at_Surgery)
            With form_clinlists_ordering                                     
               .Init(currentconsult)
               .cvwResults_Reload
            End With
         End If
         If last_fk_form <> P!fk_form Then
            last_fk_form = P!fk_form   
            cvwRequests.Add(x, 0)
            cvwRequests[x][0] = Format(P!date, "dd/mm/yyyy")
            cvwRequests[x][1] = P!requests_summary
            Inc x
         Endif
      End If   
   Next
   
End
