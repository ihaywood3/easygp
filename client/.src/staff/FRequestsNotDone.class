' Gambas class file

Private Patients As Collection
Private cvwPatients_key As Variant
Private cvwRequests_Key As Variant
Private fk_patient As Variant
Private All_Requests As Collection
Private form_clinlists_ordering As FClinLists_Ordering
Private currentconsult As CConsult
Private Forms_Requests As Collection

Public Sub Init()
   
   With cvwPatients
      .Columns.Count = 3
      .Columns[1].Width = 100
   End With
   cvwRequests.Columns.count = 2
   HSplit1.Layout = Settings[Me.Name & "/hsplit.layout", modUtilGUI.hsplit([1, 1, 1])]
   Reload()
   
End

Public Sub Reload()
   
   Dim last_fk_patient As Variant
   Dim patient As Collection
   Dim x As Integer
   Dim patients_requests As Collection
   
   Inc Application.Busy
   If IsNull(form_clinlists_ordering) Then
      With form_clinlists_ordering = New FClinLists_Ordering(Vbox_Clin_list_ordering)      'create it
         '.Set_Graph_Vbox(Vbox_Graphs)
      End With
      
   Endif
   form_clinlists_ordering.Gui_Clear
   Patients = modUtil.Copy_Collection_Keyed_Sequentially(modRequestsDBI.RequestsForms_Note_Finalised_All_Patients())
   All_Requests = New Collection
   Dec Application.Busy
   cvwPatients.Clear
   
   For Each patient In Patients
      If last_fk_patient <> patient!fk_patient Then
        cvwPatients.Add(patient!fk_patient, 0)
         cvwPatients[patient!fk_patient][0] = patient!patient_wholename
         cvwPatients[patient!fk_patient][1] = Format(patient!birthdate, "dd/mm/yyyy")
         cvwPatients[patient!fk_patient][2] = Trim(patient!patient_street1 & " " & patient!patient_street2) & " " & patient!patient_town
         last_fk_patient = patient!fk_patient 
         Inc x
      Else
      Endif
   Next
   
End   

Public Sub HSplit1_Arrange()
   
   Settings[Me.Name & "/hsplit.layout"] = hsplit1.layout 
   
End

Public Sub cvwPatients_Select()
   
   Dim P As Collection
   Dim last_fk_patient As Variant
   Dim forms As Collection
   Dim x As Integer
   Dim last_fk_form As Variant
   
   cvwPatients.MoveCurrent
   cvwRequests.Clear
   cvwPatients_Key = cvwPatients.Item.Key
   fk_patient = cvwPatients_key
   form_clinlists_ordering.Gui_Clear 
   Wait
   
   For Each P In Patients
      If P!fk_patient = fk_patient Then
         If Not form_clinlists_ordering.Current_Consult_Exists() Then                'If there is no current consult e.g first time used or next patient 
            currentconsult = New CConsult(P, const.consult_type_at_Surgery)
            With form_clinlists_ordering                                     
               .Init(currentconsult)
               .cvwResults_Reload
            End With
         End If
         If last_fk_form <> P!fk_form Then
            Forms_Requests = New Collection
            last_fk_form = P!fk_form   
            cvwRequests.Add(x, 0)
            cvwRequests[x][0] = Format(P!date, "dd/mm/yyyy")
            cvwRequests[x][1] = P!requests_summary
            Forms_Requests.Add(P, Forms_Requests.count)
            Inc x
         Endif
      End If   
   Next
   
End

Public Sub cvwRequests_Menu()

   If cvwRequests.count Then
      mnuRequests_Mark_Back.Popup
   Endif

End
Public Sub mnuRequests_Mark_Back_Click()
  Dim sMsg As String
  Dim sql As String
  
  Select Case Last.tag
  Case "mark form completed"
     sMsg = "Are you sure you want to mark these requests as completed?\n\n"
     "Please note that each and every request you ordered on this form must have been "
     "reviewed in the inbox and be present in the results/requests list on the right of the screen.\n\n"
     sMsg &= Forms_Requests[cvwRequests_Key]!requests_summary
     If Message.Question(sMsg, "Yes - Mark off Form", "Cancel") = 2 Then Return 
     sql = "Update clin_requests.forms_requests set finalised = True where fk_form = " & Forms_Requests[cvwRequests_Key]!fk_form
     modDBConnect.exec_query(sql)
     modDBConnect.CommitTrans 
    Reload
  End Select    
  Catch
  Return 
End

Public Sub cvwRequests_Select()

   cvwRequests.MoveCurrent
   cvwRequests_Key = cvwRequests.Item.Key

End
