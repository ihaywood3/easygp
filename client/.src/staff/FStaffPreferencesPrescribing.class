' Gambas class file

' Copyright (C) 2008-12 Dr. Richard Terry
' This program is free software: you can redistribute it and/or modify
' it under the terms of the GNU General Public License as published by
' the Free Software Foundation, either version 3 of the License, or
' (at your option) any later version.

' This program is distributed in the hope that it will be useful,
' but WITHOUT ANY WARRANTY; without even the implied warranty of
' MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
' GNU General Public License for more details.

' You should have received a copy of the GNU General Public License
' along with this program.  If not, see <http://www.gnu.org/licenses/>.
'-------------------------------------------------------------------------------------
'PURPOSE    Allow user to set their peferences for how the prescribing section behaves
'-------------------------------------------------------------------------------------


Private sDefault_Prescribing_Mode As String
Private bExit As Boolean

Public Sub Form_Leave()
   
   Save() 
   
End

Public Sub Init()
   '-----------------------------------------------------------------------------
   ' Create the gui to allow users to choose which drugs to expose in prescribing  
   ' PBS chapters
   ' "CS";"Section 100 (Chemotherapy Special Benefit)"
   ' "CT";"Section 100 (Chemotherapy Scheme)"
   ' "DB";"Doctor's Bag"
   ' "DS";"Dental (Special Pharmaceutical Benefits)"
   ' "DT";"Dental"
   ' "GE";"General"
   ' "GH";"Section 100 (Growth hormone)" Chapters_Create_Gui()
   ' "HB";"Section 100 (Highly Specialised Drugs) - Public Hospitals"
   ' "HS";"Section 100 (Highly specialised drugs)"
   ' "IF";"Section 100 (IVF/GIFT Treatment)"
   ' "MD";"Section 100 (Opiate Addiction Treatment)"
   ' "MF";"Section 100 (Botulinum Toxin Program)"False
   ' "OT";"Optometrist"
   ' "PL";"Palliative care"
   ' "PQ";"Paraplegic/Quadriplegic"
   ' "R1";"Repatriation"
   ' "SB";"Special Pharmaceutical Benefits"
   ' "SY";"Section 100 (Special Authority Item  Chapters = modPrescribingDBI.Chapters_Get()s) - Private Hospitals"
   ' "SZ";"Section 100 (Special Authority Items) - Public Hospitals"
   '-------------------------------------------------------------------------

   Dim chkbox As CheckBox
   Dim chapter As Collection
   Dim Chapters As Collection
   
   lblMeasure.text = "  Default Prescribing Mode  "                    'the widest label 
   modEditAreaHelpers.Resize_labels(Vbox_EditArea, lblmeasure)         'ensure all labels the same width
   '---------------------------------------------------------------------------
   'First contruct the part of the gui with all the checkboxes for the chapters
   '---------------------------------------------------------------------------
   Chapters = modPrescribingDBI.Chapters_Get()
   bExit = True   
   For Each chapter In Chapters
      With chkbox = New CheckBox(Vbox_Chapters) As "vbox_chapters"
         .Expand = True
         .text = chapter!chapter_name
         .tag = chapter
         .height = 28
         .value = False 
      End With
      chkbox.value = modAdminDBI.Config_Get(chapter!chapter, False, False, modDBConnect.currentUser!fk_clinic)
   Next
   bExit = False  
   '----------------------------------------------------------- 
   'Now, set all the other  previously saved options (if exist)
   '-----------------------------------------------------------
   Select Case modAdminDBI.Config_Get_Staff_Member("user_prescribing_mode", "brand", Null, modDBConnect.currentUser!fk_clinic, modDBConnect.currentUser!fk_staff) 
      Case "brand"
         rbBrandPrescribing.value = True
      Case "generic"
         rbGenericPrescribing.Value = True   
   End Select
   chkAutoCompleteScript.value = modAdminDBI.Config_Get("user_prescribing_auto_complete_script", True, False, modDBConnect.currentUser!fk_clinic)

End

Public Sub Vbox_Chapters_click()
   
   If bExit Then Return 
 
     modAdminDBI.Config_Save_staff_member(modDBConnect.currentUser!fk_clinic, Last.tag!chapter, CBool(Last.value), modDBConnect.currentUser!fk_staff) 
    modDBConnect.CommitTrans()
End   

Public Sub Save()
   '--------------------------------
   'Called by Form_Leave()
   'Save all defaults to the backend
   '--------------------------------

   Dim cb As CheckBox
   Dim search_scope As New String[]
   
   For Each cb In Vbox_Chapters.Children
   '   modAdminDBI.Config_Save_staff_member(modDBConnect.currentUser!fk_clinic, cb.tag!chapter, CBool(cb.value), modDBConnect.currentUser!fk_staff) 
    '  modDBConnect.CommitTrans()
      If cb.Value = True Then
         search_scope.Add(cb.Tag!chapter)
      Endif
   Next
   modAdminDBI.Config_Save_staff_member(modDBConnect.currentUser!fk_clinic, "user_prescribing_mode", sDefault_Prescribing_Mode, modDBConnect.currentUser!fk_staff) 
   modAdminDBI.Config_Save_staff_member(modDBConnect.currentUser!fk_clinic, "user_prescribing_auto_complete_script", CBool(chkAutoCompleteScript.value), modDBConnect.currentUser!fk_staff) 
   modDBConnect.CommitTrans()
   Try FPrescriptions.Prescribing_Mode_Set(sDefault_Prescribing_Mode)
   Try FPrescriptions.Search_Scope_Update(search_scope)
   
End

Public Sub EditArea_RadioButtons_Click()
   
   sDefault_Prescribing_Mode = Last.tag '"generic" or "brand"
   
End


